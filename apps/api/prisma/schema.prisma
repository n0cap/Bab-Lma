generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  client
  pro
  admin
}

enum Locale {
  fr
  ar
  en
}

enum ServiceType {
  menage
  cuisine
  childcare
}

enum OrderStatus {
  draft
  submitted
  searching
  negotiating
  accepted
  en_route
  in_progress
  completed
  cancelled
}

enum CleanType {
  simple
  deep
}

enum TeamType {
  solo
  duo
  squad
}

enum AssignmentStatus {
  assigned
  confirmed
  declined
}

enum OfferStatus {
  pending
  accepted
  rejected
}

enum OtpPurpose {
  login
  signup
  reset
}

enum ActorRole {
  client
  pro
  admin
  system
}

model User {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String?  @unique @db.VarChar(255)
  phone        String?  @unique @db.VarChar(20)
  passwordHash String?  @map("password_hash")
  fullName     String   @map("full_name") @db.VarChar(100)
  role         UserRole @default(client)
  locale       Locale   @default(fr)
  avatarUrl    String?  @map("avatar_url")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  professional    Professional?
  orders          Order[]          @relation("ClientOrders")
  refreshTokens   RefreshToken[]
  statusEvents    StatusEvent[]
  messages        Message[]
  offers          NegotiationOffer[]
  ratings         Rating[]
  auditLogs       AuditLog[]

  @@map("users")
}

model Professional {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String      @unique @map("user_id") @db.Uuid
  skills        ServiceType[]
  bio           String?
  rating        Float       @default(0)
  totalSessions Int         @default(0) @map("total_sessions")
  reliability   Float       @default(100)
  zones         String[]
  isAvailable   Boolean     @default(true) @map("is_available")
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  user        User              @relation(fields: [userId], references: [id])
  assignments OrderAssignment[]

  @@map("professionals")
}

model Order {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId         String      @map("client_id") @db.Uuid
  serviceType      ServiceType @map("service_type")
  status           OrderStatus @default(draft)
  floorPrice       Int         @map("floor_price")
  finalPrice       Int?        @map("final_price")
  tipAmount        Int         @default(0) @map("tip_amount")
  scheduledStartAt DateTime?   @map("scheduled_start_at") @db.Timestamptz
  scheduledEndAt   DateTime?   @map("scheduled_end_at") @db.Timestamptz
  location         String      @db.VarChar(100)
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  client       User               @relation("ClientOrders", fields: [clientId], references: [id])
  detail       OrderDetail?
  assignments  OrderAssignment[]
  statusEvents StatusEvent[]
  messages     Message[]
  offers       NegotiationOffer[]
  rating       Rating?

  @@map("orders")
}

model OrderDetail {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId   String    @unique @map("order_id") @db.Uuid
  // m√©nage
  surface   Int?
  cleanType CleanType? @map("clean_type")
  teamType  TeamType?  @map("team_type")
  squadSize Int?       @map("squad_size")
  // cuisine
  guests    Int?
  dishes    String?    @db.VarChar(500)
  // childcare
  children  Int?
  hours     Int?
  // shared
  notes     String?    @db.VarChar(500)

  order Order @relation(fields: [orderId], references: [id])

  @@map("order_details")
}

model OrderAssignment {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId        String           @map("order_id") @db.Uuid
  professionalId String           @map("professional_id") @db.Uuid
  isLead         Boolean          @default(false) @map("is_lead")
  status         AssignmentStatus @default(assigned)
  assignedAt     DateTime         @default(now()) @map("assigned_at") @db.Timestamptz
  confirmedAt    DateTime?        @map("confirmed_at") @db.Timestamptz

  order        Order        @relation(fields: [orderId], references: [id])
  professional Professional @relation(fields: [professionalId], references: [id])

  @@unique([orderId, professionalId])
  @@map("order_assignments")
}

model StatusEvent {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId     String      @map("order_id") @db.Uuid
  seq         Int         @default(autoincrement())
  fromStatus  OrderStatus @map("from_status")
  toStatus    OrderStatus @map("to_status")
  actorUserId String      @map("actor_user_id") @db.Uuid
  actorRole   ActorRole   @map("actor_role")
  reason      String?     @db.VarChar(500)
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz

  order Order @relation(fields: [orderId], references: [id])
  actor User  @relation(fields: [actorUserId], references: [id])

  @@index([orderId, seq])
  @@map("status_events")
}

model Message {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId         String    @map("order_id") @db.Uuid
  seq             Int       @default(autoincrement())
  senderId        String    @map("sender_id") @db.Uuid
  senderRole      ActorRole @map("sender_role")
  content         String    @db.VarChar(2000)
  clientMessageId String?   @unique @map("client_message_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz

  order  Order @relation(fields: [orderId], references: [id])
  sender User  @relation(fields: [senderId], references: [id])

  @@index([orderId, seq])
  @@map("messages")
}

model NegotiationOffer {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId    String      @map("order_id") @db.Uuid
  seq        Int         @default(autoincrement())
  offeredBy  String      @map("offered_by") @db.Uuid
  amount     Int
  status     OfferStatus @default(pending)
  acceptedAt DateTime?   @map("accepted_at") @db.Timestamptz
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz

  order  Order @relation(fields: [orderId], references: [id])
  author User  @relation(fields: [offeredBy], references: [id])

  @@index([orderId, seq])
  @@map("negotiation_offers")
}

model OtpChallenge {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone      String     @db.VarChar(20)
  purpose    OtpPurpose
  codeHash   String     @map("code_hash")
  expiresAt  DateTime   @map("expires_at") @db.Timestamptz
  attempts   Int        @default(0)
  consumedAt DateTime?  @map("consumed_at") @db.Timestamptz
  createdAt  DateTime   @default(now()) @map("created_at") @db.Timestamptz

  @@index([phone, createdAt])
  @@map("otp_challenges")
}

model RefreshToken {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  tokenHash  String   @unique @map("token_hash") @db.VarChar(64)
  family     String   @db.Uuid
  replacedBy String?  @map("replaced_by") @db.Uuid
  isRevoked  Boolean  @default(false) @map("is_revoked")
  expiresAt  DateTime @map("expires_at") @db.Timestamptz
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id])

  @@index([family])
  @@map("refresh_tokens")
}

model Rating {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId   String   @unique @map("order_id") @db.Uuid
  clientId  String   @map("client_id") @db.Uuid
  stars     Int
  comment   String?  @db.VarChar(1000)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  order  Order @relation(fields: [orderId], references: [id])
  client User  @relation(fields: [clientId], references: [id])

  @@map("ratings")
}

model AuditLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action      String    @db.VarChar(100)
  entityType  String    @map("entity_type") @db.VarChar(50)
  entityId    String    @map("entity_id") @db.Uuid
  actorUserId String    @map("actor_user_id") @db.Uuid
  actorRole   ActorRole @map("actor_role")
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz

  actor User @relation(fields: [actorUserId], references: [id])

  @@index([entityType, entityId])
  @@index([actorUserId])
  @@map("audit_logs")
}

model IdempotencyKey {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key        String   @db.VarChar(64)
  userId     String   @map("user_id") @db.Uuid
  response   Json
  statusCode Int      @map("status_code")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@unique([key, userId])
  @@map("idempotency_keys")
}
