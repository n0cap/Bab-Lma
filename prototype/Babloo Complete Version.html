<!DOCTYPE html>
<script>
// ── Babloo SVG Logo (inline vectors for crisp rendering at any size) ──
const BABLOO_SVG_NAVY = '<svg viewBox="0 0 1456 1456" xmlns="http://www.w3.org/2000/svg"><path d="m0 0h1456v1456h-1456z" fill="none"/><path transform="translate(587,367)" d="m0 0h92l54 1 17 2 19 1 7 2 13 2 15 4 20 7 21 10 15 10 13 10 12 11 9 9 14 19 10 16 8 16 8 19 6 21 2 8 3 21v38l-4 22-6 21-9 22-10 20 1 5 16 16 9 11 11 14 9 14 8 16 8 20 4 15 5 26 1 8v36l-3 20-6 25-8 20-8 17-8 12-13 17-11 12-11 11-17 13-17 12-15 8-15 6-22 6-24 3-48 1h-21l-3-2-5-16-6-10-1-3v-104l2-4 2-9 6-10 3-9 4 2 3 2 38 6h21l5-2 2-5 1-3v-55l-3-7-6-4-8-1-13 2-23 3-6 1-7 1-10 7-10 2-7-1-12 5-1 1h-9l-9-8-4-5-3-1h-25l-16 2-21 7-17 8-14 10-10 9-9 11-9 14-4 10 1 5 5 5 5 2h6l8-5 10-7 14-6 18-5 23-3h15l3 2 4 13 3 5 2 10 3 7v33l-1 29v33l-4 13-8 24-1 1h-107l-26-6-16-6-14-7-11-9-9-9-9-12-7-12-6-18-2-11-2-49-1-224v-207l3-19 6-20 8-15 12-16 10-9 15-10 14-7 17-5 20-4z" fill="#020069"/><path transform="translate(641,518)" d="m0 0 93 1 8 9 6 12 2 6 1 19v14l-2 10-5 12-6 9-4 3-8 1h-86l-5-4-6-10-4-10-2-7v-33l5-16 7-11z" fill="#FFFFFE"/></svg>';
const BABLOO_SVG_WHITE = '<svg viewBox="0 0 1456 1456" xmlns="http://www.w3.org/2000/svg"><path d="m0 0h1456v1456h-1456z" fill="none"/><path transform="translate(587,367)" d="m0 0h92l54 1 17 2 19 1 7 2 13 2 15 4 20 7 21 10 15 10 13 10 12 11 9 9 14 19 10 16 8 16 8 19 6 21 2 8 3 21v38l-4 22-6 21-9 22-10 20 1 5 16 16 9 11 11 14 9 14 8 16 8 20 4 15 5 26 1 8v36l-3 20-6 25-8 20-8 17-8 12-13 17-11 12-11 11-17 13-17 12-15 8-15 6-22 6-24 3-48 1h-21l-3-2-5-16-6-10-1-3v-104l2-4 2-9 6-10 3-9 4 2 3 2 38 6h21l5-2 2-5 1-3v-55l-3-7-6-4-8-1-13 2-23 3-6 1-7 1-10 7-10 2-7-1-12 5-1 1h-9l-9-8-4-5-3-1h-25l-16 2-21 7-17 8-14 10-10 9-9 11-9 14-4 10 1 5 5 5 5 2h6l8-5 10-7 14-6 18-5 23-3h15l3 2 4 13 3 5 2 10 3 7v33l-1 29v33l-4 13-8 24-1 1h-107l-26-6-16-6-14-7-11-9-9-9-9-12-7-12-6-18-2-11-2-49-1-224v-207l3-19 6-20 8-15 12-16 10-9 15-10 14-7 17-5 20-4z" fill="white"/><path transform="translate(641,518)" d="m0 0 93 1 8 9 6 12 2 6 1 19v14l-2 10-5 12-6 9-4 3-8 1h-86l-5-4-6-10-4-10-2-7v-33l5-16 7-11z" fill="#020069"/></svg>';
const BABLOO_SVG_CLAY = '<svg viewBox="0 0 1456 1456" xmlns="http://www.w3.org/2000/svg"><path d="m0 0h1456v1456h-1456z" fill="none"/><path transform="translate(587,367)" d="m0 0h92l54 1 17 2 19 1 7 2 13 2 15 4 20 7 21 10 15 10 13 10 12 11 9 9 14 19 10 16 8 16 8 19 6 21 2 8 3 21v38l-4 22-6 21-9 22-10 20 1 5 16 16 9 11 11 14 9 14 8 16 8 20 4 15 5 26 1 8v36l-3 20-6 25-8 20-8 17-8 12-13 17-11 12-11 11-17 13-17 12-15 8-15 6-22 6-24 3-48 1h-21l-3-2-5-16-6-10-1-3v-104l2-4 2-9 6-10 3-9 4 2 3 2 38 6h21l5-2 2-5 1-3v-55l-3-7-6-4-8-1-13 2-23 3-6 1-7 1-10 7-10 2-7-1-12 5-1 1h-9l-9-8-4-5-3-1h-25l-16 2-21 7-17 8-14 10-10 9-9 11-9 14-4 10 1 5 5 5 5 2h6l8-5 10-7 14-6 18-5 23-3h15l3 2 4 13 3 5 2 10 3 7v33l-1 29v33l-4 13-8 24-1 1h-107l-26-6-16-6-14-7-11-9-9-9-9-12-7-12-6-18-2-11-2-49-1-224v-207l3-19 6-20 8-15 12-16 10-9 15-10 14-7 17-5 20-4z" fill="#C4370D"/><path transform="translate(641,518)" d="m0 0 93 1 8 9 6 12 2 6 1 19v14l-2 10-5 12-6 9-4 3-8 1h-86l-5-4-6-10-4-10-2-7v-33l5-16 7-11z" fill="white"/></svg>';
</script>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Babloo — Design System v2</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,600;0,9..144,700;1,9..144,400&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<style>
:root {
  --navy:#0E1442; --navy-mid:#1C2462; --clay:#C4370D; --clay-light:#F0835A;
  --clay-tint:#FBF0EC; --bg:#EDEEF6; --bg-alt:#F4F3FA;
  --surface:#FFFFFF; --border:#E2E1EE; --border-strong:#C8C7DC;
  --text-sec:#5C5C7A; --text-muted:#9898B0;
  --success:#1A7A50; --success-bg:#EAF5EF;
  --warning:#B06B00; --warning-bg:#FFF5E0;
  --error:#C0392B;
  --pro-a:#6C63FF; --pro-b:#E8517A; --pro-c:#00A99D;
  --r-sm:8px; --r-md:14px; --r-lg:20px; --r-xl:28px; --r-full:999px;
  --sh-sm:0 2px 10px rgba(14,20,66,0.08); --sh-md:0 4px 20px rgba(14,20,66,0.10);
  --sh-lg:0 8px 40px rgba(14,20,66,0.14); --sh-xl:0 20px 60px rgba(14,20,66,0.18);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',system-ui,sans-serif;background:#12121E;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;gap:24px;}
.phone{width:393px;height:852px;background:var(--bg);border-radius:52px;overflow:hidden;position:relative;flex-shrink:0;box-shadow:0 0 0 1px rgba(255,255,255,0.05),0 0 0 11px #0e0e1a,0 0 0 13px #1e1e30,var(--sh-xl);}
.status-bar{position:absolute;top:0;left:0;right:0;height:50px;z-index:200;display:flex;align-items:center;justify-content:space-between;padding:0 26px;background:var(--surface);font-size:12px;font-weight:600;color:var(--navy);}
.status-bar.dark{background:var(--navy);color:rgba(255,255,255,0.9);}
.screens{position:absolute;inset:0;overflow:hidden;}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;background:var(--bg);opacity:0;pointer-events:none;transform:translateX(22px);transition:opacity .24s cubic-bezier(.4,0,.2,1),transform .24s cubic-bezier(.4,0,.2,1);overflow:hidden;}
.screen.active{opacity:1;pointer-events:all;transform:translateX(0);}
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.scroll::-webkit-scrollbar{display:none;}
.t-display{font-family:'Fraunces',serif;font-weight:700;font-size:26px;line-height:1.2;color:var(--navy);}
.t-h1{font-family:'Fraunces',serif;font-weight:600;font-size:20px;line-height:1.3;color:var(--navy);}
.t-h2{font-family:'Fraunces',serif;font-weight:600;font-size:17px;line-height:1.35;color:var(--navy);}
.t-h3{font-family:'DM Sans',sans-serif;font-weight:700;font-size:14px;color:var(--navy);}
.t-body{font-size:13px;line-height:1.6;color:var(--text-sec);}
.t-label{font-size:10px;font-weight:700;color:var(--text-muted);letter-spacing:1.2px;text-transform:uppercase;}
.btn{display:flex;align-items:center;justify-content:center;gap:8px;height:52px;border-radius:var(--r-full);border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;transition:opacity .15s,transform .1s;width:100%;}
.btn:active{opacity:.85;transform:scale(.98);}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.btn-primary{background:var(--navy);color:white;}
.btn-clay{background:var(--clay);color:white;}
.btn-outline{background:transparent;color:var(--navy);border:1.5px solid var(--navy);}
.btn-ghost{background:var(--bg-alt);color:var(--navy);}
.btn-xs{height:30px;font-size:11px;border-radius:var(--r-sm);padding:0 12px;width:auto;}
.card{background:var(--surface);border-radius:var(--r-lg);padding:18px;box-shadow:var(--sh-sm);}
.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:var(--r-full);font-size:10px;font-weight:700;border:1.5px solid var(--border);background:var(--surface);color:var(--text-sec);}
.chip-navy{background:rgba(14,20,66,0.07);border-color:rgba(14,20,66,0.14);color:var(--navy);}
.chip-success{background:var(--success-bg);border-color:var(--success);color:var(--success);}
.chip-clay{background:var(--clay-tint);border-color:var(--clay-light);color:var(--clay);}
.chip-warn{background:var(--warning-bg);border-color:var(--warning);color:var(--warning);}
.nav-bar{background:var(--surface);border-top:1px solid var(--border);display:flex;padding:8px 6px 20px;flex-shrink:0;}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:6px 4px;border-radius:var(--r-md);transition:background .15s;position:relative;}
.nav-item:active{background:var(--bg);}
.nav-item svg{width:21px;height:21px;color:var(--text-muted);stroke-width:1.8;fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round;}
.nav-lbl{font-size:9px;font-weight:700;color:var(--text-muted);}
.nav-item.active svg,.nav-item.active .nav-lbl{color:var(--navy);}
.nav-badge{position:absolute;top:3px;right:10px;min-width:15px;height:15px;background:var(--clay);border-radius:var(--r-full);border:2px solid var(--surface);font-size:8px;font-weight:700;color:white;display:flex;align-items:center;justify-content:center;padding:0 3px;}
.cta-bar{padding:14px 20px 28px;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:8px;}
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;flex-shrink:0;}
.av-xl{width:72px;height:72px;font-size:24px;}
.av-lg{width:56px;height:56px;font-size:18px;}
.av-md{width:44px;height:44px;font-size:14px;}
.av-sm{width:32px;height:32px;font-size:11px;}
.av-a{background:linear-gradient(135deg,#6C63FF,#A080FF);}
.av-b{background:linear-gradient(135deg,#E8517A,#F07AB0);}
.av-c{background:linear-gradient(135deg,#00A99D,#00D4C8);}
.av-user{background:linear-gradient(135deg,#1C2462,#2D3494);}
.stars{display:flex;gap:2px;}
.star svg{width:12px;height:12px;fill:#D8D7EE;}
.star.on svg{fill:var(--navy);}
.back-hdr{background:var(--surface);padding:52px 20px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;}
.back-btn{width:34px;height:34px;border-radius:50%;background:var(--bg);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--navy);flex-shrink:0;transition:background .15s;}
.back-btn:active{background:var(--border);}
.back-btn svg{width:17px;height:17px;fill:none;stroke:currentColor;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;}
.stepper{display:flex;align-items:center;gap:14px;}
.stp-btn{width:34px;height:34px;border-radius:50%;border:1.5px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--navy);font-size:18px;transition:all .15s;user-select:none;}
.stp-btn:active{background:var(--bg);}
.stp-val{font-size:22px;font-weight:700;color:var(--navy);min-width:30px;text-align:center;}
.input-f{border:1.5px solid var(--border);border-radius:var(--r-md);padding:11px 14px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--navy);background:var(--surface);outline:none;transition:border-color .2s;width:100%;}
.input-f:focus{border-color:var(--navy);}
.tgl{width:42px;height:24px;border-radius:12px;background:var(--border);position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;}
.tgl.on{background:var(--navy);}
.tgl::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:white;top:3px;left:3px;box-shadow:0 1px 4px rgba(0,0,0,0.15);transition:transform .2s;}
.tgl.on::after{transform:translateX(18px);}
.chk{width:22px;height:22px;border-radius:50%;border:2px solid var(--border-strong);background:var(--surface);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;flex-shrink:0;}
.chk.on{background:var(--navy);border-color:var(--navy);}
.chk.on::after{content:'';width:9px;height:5px;border-left:2px solid white;border-bottom:2px solid white;transform:rotate(-45deg) translateY(-1px);display:block;}
.skill-row{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border-radius:var(--r-md);border:1.5px solid var(--border);cursor:pointer;transition:border-color .2s;margin-bottom:8px;}
.skill-row.on{border-color:var(--navy);background:rgba(14,20,66,0.02);}
.skill-name{font-size:13px;font-weight:700;color:var(--navy);}
.skill-hint{font-size:11px;color:var(--text-muted);margin-top:2px;}
.skill-chk{width:20px;height:20px;border-radius:4px;border:1.5px solid var(--border-strong);background:var(--surface);transition:all .2s;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.skill-chk.on{background:var(--navy);border-color:var(--navy);}
.skill-chk.on::after{content:'';width:8px;height:5px;border-left:2px solid white;border-bottom:2px solid white;transform:rotate(-45deg) translateY(-1px);display:block;}
.prog{height:4px;border-radius:2px;background:var(--border);overflow:hidden;flex:1;}
.prog-fill{height:100%;border-radius:2px;background:var(--navy);}
.price-dark{background:linear-gradient(135deg,var(--navy) 0%,var(--navy-mid) 100%);border-radius:var(--r-lg);padding:20px;color:white;}
.squad-card{margin:0 20px 12px;background:var(--surface);border-radius:var(--r-lg);padding:18px;box-shadow:var(--sh-sm);border:2px solid transparent;transition:border-color .2s,box-shadow .2s;cursor:pointer;position:relative;}
.squad-card.sel{border-color:var(--navy);box-shadow:0 0 0 4px rgba(14,20,66,0.07),var(--sh-sm);}
.team-card{flex:1;background:var(--surface);border-radius:var(--r-lg);padding:14px 10px;text-align:center;border:2px solid var(--border);cursor:pointer;transition:all .2s;}
.team-card.sel{border-color:var(--navy);background:rgba(14,20,66,0.03);}
.modal-ov{position:absolute;inset:0;background:rgba(14,20,66,0.55);backdrop-filter:blur(6px);z-index:300;display:none;align-items:flex-end;}
.modal-ov.open{display:flex;animation:fadein .2s ease;}
.modal-sheet{width:100%;background:var(--surface);border-radius:var(--r-xl) var(--r-xl) 0 0;padding:16px 20px 36px;max-height:82%;overflow-y:auto;animation:slideup .28s cubic-bezier(.4,0,.2,1);}
.modal-handle{width:38px;height:4px;border-radius:2px;background:var(--border-strong);margin:0 auto 18px;}
.fid-card{margin:0 20px 12px;background:var(--surface);border-radius:var(--r-lg);overflow:hidden;box-shadow:var(--sh-sm);}
.fid-top{padding:16px 18px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--border);}
.fid-bot{padding:12px 18px;display:flex;gap:12px;background:var(--bg-alt);}
.wk-slot{border-right:1px solid var(--border);border-bottom:1px solid var(--border);background:var(--surface);min-height:38px;cursor:pointer;position:relative;transition:background .15s;}
.wk-slot:active{background:var(--bg);}
.wk-ev{position:absolute;inset:2px;border-radius:4px;padding:3px 5px;font-size:8px;font-weight:700;color:white;overflow:hidden;line-height:1.3;}
.toast{position:absolute;bottom:100px;left:20px;right:20px;background:var(--navy);color:white;border-radius:var(--r-md);padding:14px 18px;font-size:13px;font-weight:500;z-index:400;text-align:center;box-shadow:var(--sh-lg);animation:fadein .25s ease;}
.sidebar{display:flex;flex-direction:column;gap:2px;max-height:852px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.12) transparent;min-width:158px;}
.sidebar::-webkit-scrollbar{width:3px;}
.sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.12);border-radius:2px;}
.sb-sec{font-size:9px;font-weight:700;color:rgba(255,255,255,0.28);letter-spacing:1.5px;text-transform:uppercase;padding:12px 10px 3px;}
.sb-btn{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:var(--r-sm);background:transparent;border:none;color:rgba(255,255,255,0.5);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;text-align:left;transition:all .15s;white-space:nowrap;width:100%;}
.sb-btn:hover{background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.85);}
.sb-btn.active{background:var(--clay);color:white;}
.bk-type-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 20px;}
.bk-type-card{background:var(--surface);border-radius:var(--r-lg);padding:16px;border:2px solid var(--border);cursor:pointer;transition:all .2s;}
.bk-type-card.sel{border-color:var(--navy);background:rgba(14,20,66,0.02);}
.zone-pill{display:flex;align-items:center;gap:10px;padding:14px 16px;border-radius:var(--r-md);border:1.5px solid var(--border);background:var(--surface);cursor:pointer;margin-bottom:8px;transition:border-color .2s;}
.zone-pill.sel{border-color:var(--navy);background:rgba(14,20,66,0.03);}
@keyframes fadein{from{opacity:0;}to{opacity:1;}}
@keyframes slideup{from{transform:translateY(40px);}to{transform:translateY(0);}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
@keyframes spin{to{transform:rotate(360deg)}}
/* ── Splash Screen ── */
.splash-overlay{position:absolute;inset:0;z-index:999;background:#fff;display:flex;align-items:center;justify-content:center;transition:opacity .45s ease,transform .45s ease;}
.splash-overlay.hide{opacity:0;transform:scale(1.03);pointer-events:none;}
.splash-incision-wrap{width:220px;height:220px;transform-origin:center center;will-change:transform,filter;}
.splash-incision-logo{width:100%;height:100%;overflow:visible;}
.splash-trace{fill:transparent;stroke:#04016D;stroke-width:3px;stroke-linecap:round;stroke-linejoin:round;}
/* ── Négociation Price Slider ── */
.nego-section{padding:16px;background:var(--bg-alt);border-radius:var(--r-lg);margin:8px 0;border:1.5px solid var(--border);}
.nego-price-display{font-family:'Fraunces',serif;font-size:36px;font-weight:700;color:var(--navy);text-align:center;line-height:1;}
.nego-slider{-webkit-appearance:none;appearance:none;width:100%;height:6px;border-radius:3px;background:linear-gradient(to right,var(--navy) 0%,var(--clay) 100%);outline:none;margin:14px 0 8px;}
.nego-slider::-webkit-slider-thumb{-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:var(--navy);border:3px solid white;box-shadow:0 2px 8px rgba(14,20,66,.25);cursor:pointer;transition:transform .15s;}
.nego-slider::-webkit-slider-thumb:active{transform:scale(1.15);}
.nego-slider::-moz-range-thumb{width:28px;height:28px;border-radius:50%;background:var(--navy);border:3px solid white;box-shadow:0 2px 8px rgba(14,20,66,.25);cursor:pointer;}
.nego-quick-btn{padding:8px 14px;border-radius:var(--r-full);border:1.5px solid var(--border);background:var(--surface);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;color:var(--navy);cursor:pointer;transition:all .2s;white-space:nowrap;}
.nego-quick-btn:hover,.nego-quick-btn.sel{background:var(--navy);color:white;border-color:var(--navy);}
.tip-btn{display:flex;align-items:center;gap:8px;padding:12px 16px;border-radius:var(--r-md);border:1.5px dashed var(--clay-light);background:var(--clay-tint);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;}
.tip-btn:hover{border-style:solid;background:rgba(196,55,13,.12);}
.tip-btn.sel{border-style:solid;border-color:var(--clay);background:rgba(196,55,13,.12);}
.pref-slot{background:var(--surface);border-radius:var(--r-md);padding:12px;border:1.5px solid var(--border);cursor:pointer;text-align:center;transition:border-color .2s,background .2s;}
.pref-slot.sel{border:2px solid var(--navy);background:rgba(14,20,66,0.03);}
.pref-slot .pref-slot-title{font-size:11px;font-weight:700;color:var(--text-sec);}
.pref-slot.sel .pref-slot-title{color:var(--navy);}
.pref-slot .pref-slot-sub{font-size:10px;color:var(--text-muted);margin-top:2px;}
.slot-pro-opt{flex:1;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:var(--r-md);border:1.5px solid var(--border);cursor:pointer;transition:border-color .2s,background .2s;}
.slot-pro-opt.sel{border:2px solid var(--navy);background:rgba(14,20,66,0.03);}
.slot-pro-opt span{font-size:12px;font-weight:600;color:var(--text-sec);}
.slot-pro-opt.sel span{font-weight:700;color:var(--navy);}
.fid-stat-val{font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--navy);}
.fid-stat-lbl{font-size:10px;color:var(--text-muted);margin-top:2px;text-transform:uppercase;letter-spacing:.8px;}
.sb-new{display:inline-flex;align-items:center;justify-content:center;margin-left:6px;padding:1px 6px;border-radius:999px;background:rgba(196,55,13,.2);color:var(--clay-light);font-size:8px;font-weight:800;letter-spacing:.8px;}
/* ── Service card hover polish ── */
.svc-card{background:var(--surface);border-radius:var(--r-lg);padding:18px 14px;display:flex;flex-direction:column;align-items:center;gap:10px;box-shadow:var(--sh-sm);cursor:pointer;border:1.5px solid rgba(14,20,66,0.06);transition:transform .15s,box-shadow .15s;position:relative;}
.svc-card:active{transform:scale(.97);box-shadow:var(--sh-md);}
.svc-card .svc-dot{position:absolute;top:10px;right:10px;width:7px;height:7px;border-radius:50%;background:var(--success);}
.svc-card .svc-icon{width:52px;height:52px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center;}
.svc-card .svc-label{font-size:12px;font-weight:600;color:var(--navy);text-align:center;}
.svc-card .svc-sub{font-size:10px;color:var(--text-muted);text-align:center;line-height:1.4;margin-top:-4px;}
.svc-card.disabled{opacity:.38;cursor:default;}
@media(max-width:700px){body{padding:0;background:var(--bg);flex-direction:column;align-items:stretch;}.phone{border-radius:0;width:100%;height:100dvh;box-shadow:none;}.sidebar{display:none;}}


/* ================================================================
   BABLOO OTP SCREEN — Additive styles only
   Namespace: .otp-*  |  Safe to append to existing stylesheet
   ================================================================ */
.t-body-sm { font-size: 12px; line-height: 1.5; color: var(--text-sec); }

/* Screen base — mirror your existing .screen layout */
.otp-screen {
  display: none;
  flex-direction: column;
  min-height: 100%;
  background: var(--bg);
  position: relative;
  overflow: hidden;
}
.otp-screen.active { display: flex; }

/* Header */
.otp-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 62px 20px 8px;
  gap: 8px;
  background: linear-gradient(to bottom, rgba(255,255,255,0.65), rgba(255,255,255,0));
}
.otp-back-btn {
  width: 40px; height: 40px;
  border-radius: var(--r-full);
  border: 1px solid var(--border);
  background: var(--surface);
  box-shadow: var(--sh-sm);
  display: flex; align-items: center; justify-content: center;
  color: var(--navy);
  cursor: pointer;
  transition: box-shadow .15s, background .15s, transform .1s;
  flex-shrink: 0;
}
.otp-back-btn:hover  { background: var(--bg-alt); box-shadow: var(--sh-md); }
.otp-back-btn:active { transform: scale(.95); }
.otp-header-title { font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 600; color: var(--navy); letter-spacing: -.01em; text-transform: none; }
.otp-header-spacer { width: 40px; flex-shrink: 0; }

/* Body layout */
.otp-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 24px 40px;
}

/* Icon badge */
.otp-icon-wrap { margin-bottom: 28px; }
.otp-icon-ring {
  width: 72px; height: 72px;
  border-radius: var(--r-xl);
  background: linear-gradient(135deg, var(--navy) 0%, #1e3a5f 100%);
  box-shadow: var(--sh-md), 0 0 0 8px rgba(14,20,66,0.08);
  display: flex; align-items: center; justify-content: center;
  color: #fff;
}

/* Intro text */
.otp-intro { text-align: center; margin-bottom: 36px; }
.otp-title { margin-bottom: 12px; }
.otp-desc { color: var(--text-sec); margin-bottom: 6px; }
.otp-phone {
  font-family: 'Fraunces', serif;
  font-size: 20px; font-weight: 700;
  color: var(--navy);
  letter-spacing: .04em;
}

/* OTP boxes */
.otp-fieldset { border: none; padding: 0; margin: 0 0 28px; width: 100%; }
.otp-boxes {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 14px;
}
.otp-box {
  width: 46px; height: 58px;
  border-radius: var(--r-md);
  border: 1.5px solid var(--border);
  background: var(--surface);
  box-shadow: var(--sh-sm);
  font-family: 'Fraunces', serif;
  font-size: 26px; font-weight: 700;
  color: var(--navy);
  text-align: center;
  caret-color: var(--clay);
  outline: none;
  transition: border-color .15s, box-shadow .15s, background .15s, transform .1s;
  -webkit-appearance: none;
}
.otp-box:focus {
  border-color: var(--clay);
  box-shadow: var(--sh-sm), 0 0 0 3px rgba(196,55,13,0.14);
  background: var(--bg);
  transform: translateY(-1px);
}
.otp-box.filled {
  border-color: rgba(14,20,66,0.22);
  background: var(--bg-alt);
}
.otp-box.otp-error-box {
  border-color: #c0392b;
  background: #fdf2f2;
  animation: otp-shake .35s ease;
}

/* Error message */
.otp-error {
  display: flex;
  align-items: center;
  gap: 6px;
  justify-content: center;
  color: #c0392b;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px; font-weight: 500;
  padding: 10px 14px;
  background: #fdf2f2;
  border-radius: var(--r-md);
  border: 1px solid #f5c2c2;
}
.otp-error[hidden] { display: none; }

/* CTA */
.otp-cta {
  width: 100%;
  margin-bottom: 20px;
  display: flex; align-items: center; justify-content: center;
  gap: 8px;
  min-height: 54px;
  font-size: 16px;
}
.otp-cta:disabled, .otp-cta[aria-disabled="true"] {
  opacity: .45;
  cursor: not-allowed;
  pointer-events: all;
}
.otp-cta:not(:disabled):hover { transform: translateY(-1px); box-shadow: var(--sh-lg); }

/* Loading state */
.otp-spinner {
  width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,.35);
  border-top-color: #fff;
  border-radius: 50%;
  display: inline-block;
  animation: otp-spin .65s linear infinite;
}
.otp-loader { display: flex; align-items: center; gap: 8px; color: #fff; font-family: 'DM Sans', sans-serif; font-size: 15px; }

/* Resend row */
.otp-resend-row {
  display: flex; align-items: center; gap: 6px;
  margin-bottom: 16px;
  flex-wrap: wrap; justify-content: center;
}
.otp-resend-hint {
  color: var(--text-muted);
  font-size: 14px;
}
.otp-resend-btn {
  background: none; border: none; cursor: pointer;
  font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600;
  color: var(--clay);
  padding: 4px 10px;
  border-radius: var(--r-full);
  transition: background .15s, opacity .15s;
}
.otp-resend-btn strong { font-weight: 700; }
.otp-resend-btn:not(:disabled):hover { background: rgba(196,55,13,0.08); }
.otp-resend-btn:disabled {
  color: var(--text-muted);
  opacity: .6;
  cursor: default;
}

/* Change number */
.otp-change-num {
  background: none; border: none; cursor: pointer;
  font-family: 'DM Sans', sans-serif; font-size: 14px;
  color: var(--text-sec);
  text-decoration: underline;
  text-decoration-color: transparent;
  transition: color .15s, text-decoration-color .15s;
  padding: 4px 0;
}
.otp-change-num:hover {
  color: var(--navy);
  text-decoration-color: var(--navy);
}

/* Success overlay */
.otp-success {
  position: absolute; inset: 0;
  background: var(--bg);
  display: flex; align-items: center; justify-content: center;
  z-index: 10;
  animation: otp-fadeIn .35s ease;
}
.otp-success[hidden] { display: none; }
.otp-success-card {
  display: flex; flex-direction: column; align-items: center; gap: 16px;
  padding: 48px 32px;
  text-align: center;
}
.otp-success-badge {
  width: 80px; height: 80px;
  border-radius: var(--r-full);
  background: linear-gradient(135deg, var(--clay) 0%, #c8643d 100%);
  box-shadow: var(--sh-lg), 0 0 0 10px rgba(196,55,13,0.10);
  display: flex; align-items: center; justify-content: center;
  color: #fff;
  animation: otp-pop .4s cubic-bezier(.34,1.56,.64,1) .1s both;
}
.otp-success-title { margin-bottom: 4px; }
.otp-success-sub { color: var(--text-sec); }

/* Accessibility */
.sr-only {
  position: absolute; width: 1px; height: 1px;
  padding: 0; margin: -1px; overflow: hidden;
  clip: rect(0,0,0,0); white-space: nowrap; border: 0;
}

/* Motion */
@keyframes otp-shake {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-5px); }
  40% { transform: translateX(5px); }
  60% { transform: translateX(-3px); }
  80% { transform: translateX(3px); }
}
@keyframes otp-spin { to { transform: rotate(360deg); } }
@keyframes otp-fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes otp-pop {
  from { transform: scale(.6); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}



/* ================================================================
   BABLOO AUTH SYSTEM — CSS additions
   Namespace: .auth-*   No color-mix()
   ================================================================ */
.auth-hero {
  position: relative;
  background: var(--navy);
  padding: 54px 28px 40px;
  overflow: hidden;
  flex-shrink: 0;
}
.auth-hero-blob {
  position: absolute;
  border-radius: 50%;
  pointer-events: none;
}
.auth-hero-blob--1 {
  width: 220px; height: 220px;
  background: rgba(196,55,13,0.22);
  top: -60px; right: -40px;
}
.auth-hero-blob--2 {
  width: 160px; height: 160px;
  background: rgba(255,255,255,0.06);
  bottom: -80px; left: -30px;
}
.auth-logo-wrap {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 20px;
}
.auth-logo-mark {
  width: 42px; height: 42px;
  border-radius: var(--r-md);
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.18);
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}
.auth-logo-mark svg { width: 28px; height: 28px; }
.auth-wordmark {
  font-family: 'Fraunces', serif;
  font-size: 24px; font-weight: 700;
  color: #fff; letter-spacing: -.02em;
}
.auth-tagline {
  font-family: 'DM Sans', sans-serif;
  font-size: 15px; line-height: 1.55;
  color: rgba(255,255,255,0.62);
}
.auth-card {
  background: var(--bg);
  border-radius: var(--r-xl) var(--r-xl) 0 0;
  margin-top: -20px;
  padding: 24px 20px 36px;
  flex: 1;
  position: relative;
  z-index: 1;
  box-shadow: 0 -4px 24px rgba(14,20,66,0.08);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.auth-tabs {
  display: flex;
  background: var(--bg-alt);
  border-radius: var(--r-full);
  padding: 4px;
  position: relative;
  margin-bottom: 20px;
}
.auth-tab {
  flex: 1; padding: 10px 8px;
  border: none; background: none;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600;
  color: var(--text-muted);
  border-radius: var(--r-full);
  cursor: pointer;
  position: relative; z-index: 1;
  transition: color .2s;
  white-space: nowrap;
}
.auth-tab.active { color: var(--navy); }
.auth-tab-indicator {
  position: absolute;
  top: 4px; bottom: 4px; left: 4px;
  width: calc(50% - 4px);
  background: var(--surface);
  border-radius: var(--r-full);
  box-shadow: var(--sh-sm);
  transition: transform .22s cubic-bezier(.4,0,.2,1);
  pointer-events: none;
}
.auth-tab-indicator.right { transform: translateX(100%); }
.auth-sso { display: flex; flex-direction: column; gap: 10px; margin-bottom: 18px; }
.auth-btn-sso {
  width: 100%;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  padding: 13px 16px;
  border-radius: var(--r-lg);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600;
  cursor: pointer;
  transition: box-shadow .15s, transform .1s, opacity .15s;
  border: 1.5px solid var(--border);
}
.auth-btn-sso:active { transform: scale(.98); }
.auth-btn-google { background: var(--surface); color: var(--navy); box-shadow: var(--sh-sm); }
.auth-btn-google:hover { box-shadow: var(--sh-md); }
.auth-btn-apple { background: var(--navy); color: #fff; border-color: var(--navy); box-shadow: var(--sh-md); }
.auth-btn-apple:hover { box-shadow: var(--sh-lg); }
.auth-sso-label { flex: 1; text-align: left; }
.auth-btn-sso.auth-loading { opacity: .6; cursor: wait; pointer-events: none; }
.auth-divider { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
.auth-divider-line { flex: 1; height: 1px; background: var(--border); }
.auth-divider-label {
  font-family: 'DM Sans', sans-serif;
  font-size: 11px; color: var(--text-muted);
  letter-spacing: .08em; text-transform: uppercase;
}
.auth-methods { display: flex; flex-direction: column; gap: 8px; margin-bottom: 18px; }
.auth-btn-method {
  width: 100%;
  display: flex; align-items: center; gap: 12px;
  padding: 13px 14px;
  border-radius: var(--r-lg);
  border: 1.5px solid var(--border);
  background: var(--surface);
  box-shadow: var(--sh-sm);
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 500;
  color: var(--navy);
  text-align: left;
  transition: box-shadow .15s, border-color .15s, transform .1s;
}
.auth-btn-method:hover { box-shadow: var(--sh-md); border-color: rgba(14,20,66,0.2); }
.auth-btn-method:active { transform: scale(.98); }
.auth-method-icon { color: var(--text-sec); flex-shrink: 0; display: flex; }
.auth-method-label { flex: 1; }
.auth-method-arrow { color: var(--text-muted); flex-shrink: 0; fill: none; display: block; }
.auth-legal {
  font-family: 'DM Sans', sans-serif;
  font-size: 11px; line-height: 1.65;
  color: var(--text-muted); text-align: center;
}
.auth-legal[hidden] { display: none; }
.auth-legal-link {
  background: none; border: none; padding: 0;
  font: inherit; font-weight: 600; color: var(--navy);
  cursor: pointer; text-decoration: underline; text-underline-offset: 2px;
}
.auth-sub-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 54px 18px 0;
  flex-shrink: 0;
  background: var(--bg);
}
.auth-back-btn {
  width: 34px; height: 34px;
  border-radius: 50%;
  background: var(--bg-alt);
  border: none;
  display: flex; align-items: center; justify-content: center;
  color: var(--navy); cursor: pointer;
  transition: background .15s;
}
.auth-back-btn:active { background: var(--border); }
.auth-sub-title-sm {
  font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600; color: var(--navy);
}
.auth-progress-bar-wrap {
  display: flex; align-items: center; gap: 10px;
  padding: 14px 20px 0; flex-shrink: 0;
}
.auth-progress-track {
  flex: 1; height: 3px;
  background: var(--border);
  border-radius: var(--r-full); overflow: hidden;
}
.auth-progress-fill {
  height: 100%; border-radius: var(--r-full);
  background: var(--clay); transition: width .3s ease;
}
.auth-progress-label {
  font-family: 'DM Sans', sans-serif;
  font-size: 11px; color: var(--text-muted); white-space: nowrap;
}
.auth-sub-body { padding: 24px 20px 0; }
.auth-sub-intro { margin-bottom: 28px; }
.auth-display-title {
  font-family: 'Fraunces', serif;
  font-size: 26px; font-weight: 700; line-height: 1.18;
  color: var(--navy); margin-bottom: 8px;
}
.auth-clay-dot { color: var(--clay); }
.auth-phone-badge { font-family: 'Fraunces', serif; color: var(--navy); font-size: inherit; }
.auth-field-group { display: flex; flex-direction: column; gap: 16px; margin-bottom: 18px; }
.auth-field { display: flex; flex-direction: column; gap: 6px; }
.auth-label-row { display: flex; justify-content: space-between; align-items: baseline; }
.auth-label {
  font-family: 'DM Sans', sans-serif;
  font-size: 12px; font-weight: 700;
  color: var(--navy); letter-spacing: .01em;
}
.auth-input { font-size: 15px; }
.auth-input:focus {
  outline: none;
  border-color: var(--clay) !important;
  box-shadow: 0 0 0 3px rgba(196,55,13,0.13) !important;
}
.auth-input.auth-err { border-color: #c0392b !important; }
.auth-input-wrap { position: relative; display: flex; align-items: center; }
.auth-input-wrap .auth-input { padding-right: 40px; }
.auth-eye-btn {
  position: absolute; right: 11px;
  background: none; border: none; cursor: pointer;
  color: var(--text-muted); padding: 4px;
  display: flex; align-items: center;
  transition: color .15s;
}
.auth-eye-btn:hover { color: var(--navy); }
.auth-phone-row { display: flex; gap: 8px; align-items: center; }
.auth-dial-pill {
  flex-shrink: 0;
  display: flex; align-items: center;
  padding: 0 12px; height: 48px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--r-md);
  box-shadow: var(--sh-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 13px; font-weight: 600;
  color: var(--navy); cursor: pointer; white-space: nowrap;
}
.auth-phone-input { flex: 1; }
.auth-field-hint { font-family: 'DM Sans', sans-serif; font-size: 11px; color: var(--text-muted); }
.auth-field-err { font-family: 'DM Sans', sans-serif; font-size: 11px; font-weight: 600; color: #c0392b; }
.auth-field-err[hidden] { display: none; }
.auth-alert {
  display: flex; align-items: flex-start; gap: 8px;
  padding: 11px 13px;
  border-radius: var(--r-md);
  font-family: 'DM Sans', sans-serif;
  font-size: 12px; line-height: 1.55;
  margin-bottom: 14px;
}
.auth-alert[hidden] { display: none; }
.auth-alert--error { background: #fdf2f2; border: 1px solid #f5c2c2; color: #c0392b; }
.auth-alert--info { background: rgba(14,20,66,0.05); border: 1px solid rgba(14,20,66,0.12); color: var(--navy); }
.auth-alert-link {
  background: none; border: none; cursor: pointer;
  font: inherit; font-weight: 700; color: inherit;
  text-decoration: underline; text-underline-offset: 2px; padding: 0;
}
.auth-cta { margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
.auth-cta:not(:disabled):hover { transform: translateY(-1px); box-shadow: var(--sh-lg); }
.auth-cta-label[hidden] { display: none; }
.auth-cta-loader {
  display: flex; align-items: center; gap: 8px;
  font-family: 'DM Sans', sans-serif; font-size: 15px; color: #fff;
}
.auth-cta-loader[hidden] { display: none; }
.auth-spinner {
  width: 15px; height: 15px;
  border: 2px solid rgba(255,255,255,.3);
  border-top-color: #fff;
  border-radius: 50%;
  display: inline-block;
  animation: spin .6s linear infinite;
}
.auth-link-sm {
  background: none; border: none; cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 11px; font-weight: 700; color: var(--clay); padding: 0;
}
.auth-link-centered {
  background: none; border: none; cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px; color: var(--text-sec);
  display: block; width: 100%; text-align: center;
  padding: 10px 0; text-decoration: underline;
  text-decoration-color: transparent;
  transition: color .15s, text-decoration-color .15s;
}
.auth-link-centered:hover { color: var(--navy); text-decoration-color: var(--navy); }

</style>
</head>
<body>
<div class="phone" id="app">
<!-- ══ SPLASH SCREEN ══ -->
<div class="splash-overlay" id="splash">
  <div class="splash-incision-wrap" id="splash-container">
    <svg class="splash-incision-logo" viewBox="0 0 450 450" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path id="splash-base" class="splash-trace" d="M227.015 113.354L232.427 113.709L233.87 114.063L240.727 114.418L251.552 116.545L258.769 119.026L265.624 122.217L271.397 125.762L276.089 129.307L278.614 131.788L281.501 134.27L284.388 137.46L288.718 143.486L291.966 149.158L295.574 156.603L298.1 164.047L299.904 172.2V189.57L298.461 196.66L296.656 202.687L293.77 209.422L290.522 216.157L291.244 217.93L297.018 223.602L300.986 228.564L304.595 233.527L308.925 241.681L311.812 249.125L313.977 258.696L314.698 264.723V274.648L313.616 282.093L311.451 290.601L308.564 297.69L305.678 303.362L302.791 307.616L299.543 311.516L297.018 314.352L292.688 318.96L287.274 323.214L282.223 326.759L278.614 328.886L273.562 331.367L265.624 333.849L260.212 334.912L254.438 335.621L240.005 335.976H232.481L232.5 336H204.766C204.773 335.993 204.779 335.984 204.787 335.976H172.167L167.115 335.267L159.898 333.494L154.125 331.367L149.795 328.886L146.187 325.695L143.3 322.859L140.052 318.251L137.526 312.934L136.083 306.907L135.361 290.601L135 175.036V152.703L135.361 145.613L136.805 139.232L138.97 133.561L141.856 128.952L144.743 125.053L148.352 121.862L155.207 117.608L160.98 115.481L168.559 113.709L171.445 113.354L182.992 113H209.694L227.015 113.354Z"/>
      <path id="splash-cut-top" class="splash-trace" d="M198.413 166H212.485L229.445 166.354L231.249 167.772L233.775 171.672L235.218 175.217L235.579 177.344V181.598L235.218 187.624L233.414 192.941L231.971 195.068L230.527 196.486L228.001 197.195H198.052L195.526 194.005L193.361 189.751L193 188.688V175.571L194.443 171.672L196.608 167.772L198.413 166Z"/>
      <path id="splash-hammer" class="splash-trace" d="M210.5 324C209.167 327.667 206.3 335.2 205.5 336H232.5L231 334L228.5 328.5L227 327V290.5L231.5 281L234.5 282L247.5 284H255L256 280.741V262.5L255 260.5L253 259.5L251.5 259H249L234.5 261L231 263.5L228.5 264H224.5L221 266L217 265.5L214 262.5V262L213 261.5H202L197.5 262.5L190.5 264.5L184 268L177.5 273.5L173 279.5L171 284L171.5 286L173.5 288H175.5L183.5 283.5L189.5 281.5L197 280L200 279.5H205L206.5 280.5L208.5 285L211 292L210.5 324Z"/>
    </svg>
  </div>
</div>
<div class="status-bar" id="status-bar"><span>9:41</span><span id="sb-brand" style="font-size:9px;letter-spacing:1px;font-weight:800;color:var(--clay);display:flex;align-items:center;gap:5px"><span id="sb-logo" style="width:18px;height:18px;display:inline-block"></span>BABLOO</span><span>&#9679;&#9679;&#9679;</span></div>
<div class="screens" id="screens">

<!-- ══ HOME ══ -->
<div class="screen" id="s-home">
  <div style="background:var(--surface);padding:52px 20px 14px;border-bottom:1px solid var(--border);flex-shrink:0">
    <div style="display:flex;align-items:center;gap:10px;background:var(--bg);border-radius:var(--r-full);padding:10px 16px;border:1.5px solid var(--border);cursor:pointer" onclick="openModal('modal-location')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--clay)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>
      <div style="flex:1"><div style="font-size:9px;font-weight:700;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase">Adresse de service</div><div style="font-size:13px;font-weight:600;color:var(--navy)" id="loc-display">Agdal, Rabat</div></div>
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
  </div>
  <div class="scroll">
    <div id="home-live-banner-wrap" style="display:none;padding:14px 20px 0"></div>
    <!-- Promo banner -->
    <div style="padding:20px 20px 0">
      <div style="background:linear-gradient(135deg,var(--navy) 0%,#1C2462 60%,#2D1F8A 100%);border-radius:var(--r-xl);padding:22px;position:relative;overflow:hidden;cursor:pointer" onclick="S.svc='maid';goto('s-booking-maid')">
        <div style="position:absolute;top:-24px;right:-24px;width:130px;height:130px;border-radius:50%;border:28px solid rgba(255,255,255,0.05)"></div>
        <div style="position:absolute;bottom:-20px;right:30px;width:80px;height:80px;border-radius:50%;border:20px solid rgba(196,55,13,0.12)"></div>
        <div style="position:absolute;top:16px;right:18px;width:48px;height:48px;opacity:.12" id="promo-logo"></div>
        <div style="position:relative">
          <div style="font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--clay-light);margin-bottom:6px">Offre de bienvenue</div>
          <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:white;line-height:1.25;margin-bottom:6px">Votre 1er service<br>Maid est <em style="color:var(--clay-light)">offert</em></div>
          <div style="font-size:11px;color:rgba(255,255,255,0.55);margin-bottom:16px;line-height:1.5">Sans engagement · Paiement espèces à la porte</div>
          <div style="display:inline-flex;align-items:center;gap:7px;background:var(--clay);color:white;border-radius:var(--r-full);padding:10px 18px;font-size:13px;font-weight:700">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="5 12 12 5 19 12"/><line x1="12" y1="19" x2="12" y2="5"/></svg>
            Réserver maintenant
          </div>
        </div>
      </div>
    </div>
    <!-- Services grid -->
    <div style="padding:24px 20px 12px">
      <span style="font-family:'Fraunces',serif;font-size:17px;font-weight:600;color:var(--navy)">De quoi avez-vous besoin ?</span>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:0 20px">
      <!-- Maid -->
      <div class="svc-card" onclick="S.svc='maid';goto('s-booking-maid')">
        <div class="svc-dot"></div>
        <div class="svc-icon" style="background:rgba(14,20,66,0.07)">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12l-2 0l9-9 9 9-2 0"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M14.5 5.5l1 1"/><path d="M18 2l.5.5"/><path d="M18 6l-.5-.5"/><path d="M15 3l.5.5"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
        </div>
        <span class="svc-label">Ménage</span>
        <span class="svc-sub">Maison · Bureau</span>
      </div>
      <!-- Cuisine -->
      <div class="svc-card" onclick="S.svc='cuisine';goto('s-booking-cuisine')">
        <div class="svc-dot"></div>
        <div class="svc-icon" style="background:rgba(14,20,66,0.07)">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2v6c0 2.2 1.8 4 4 4s4-1.8 4-4V2"/><line x1="10" y1="22" x2="10" y2="12"/><line x1="6" y1="2" x2="6" y2="6"/><line x1="10" y1="2" x2="10" y2="6"/><line x1="14" y1="2" x2="14" y2="6"/></svg>
        </div>
        <span class="svc-label">Cuisine</span>
        <span class="svc-sub">Chef à domicile</span>
      </div>
      <!-- Garde d'enfants - improved -->
      <div class="svc-card" onclick="S.svc='childcare';goto('s-booking-childcare')">
        <div class="svc-dot"></div>
        <div class="svc-icon" style="background:rgba(14,20,66,0.07)">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12h.01M15 12h.01"/><path d="M10 16c.5.3 1.2.5 2 .5s1.5-.2 2-.5"/><path d="M12 2a8 8 0 0 0-8 8v1c0 4.4 3.6 8 8 8h0c4.4 0 8-3.6 8-8v-1a8 8 0 0 0-8-8z"/><path d="M20 10c.6-.3 1-.9 1-1.5C21 7.7 20.3 7 19.5 7c-.5 0-1 .3-1.3.7"/><path d="M4 10c-.6-.3-1-.9-1-1.5C3 7.7 3.7 7 4.5 7c.5 0 1 .3 1.3.7"/></svg>
        </div>
        <span class="svc-label">Baby-sitting</span>
        <span class="svc-sub">Garde fiable</span>
      </div>
      <!-- Coming soon -->
      <div class="svc-card disabled">
        <div class="svc-icon" style="background:var(--bg)">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
        </div>
        <span class="svc-label" style="color:var(--text-muted)">Plomberie</span>
        <span class="svc-sub">Bientôt</span>
      </div>
      <div class="svc-card disabled">
        <div class="svc-icon" style="background:var(--bg)">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4"/></svg>
        </div>
        <span class="svc-label" style="color:var(--text-muted)">Électricité</span>
        <span class="svc-sub">Bientôt</span>
      </div>
      <div class="svc-card disabled">
        <div class="svc-icon" style="background:var(--bg)">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        </div>
        <span class="svc-label" style="color:var(--text-muted)">Assistance IT</span>
        <span class="svc-sub">Bientôt</span>
      </div>
    </div>
    <div style="height:28px"></div>
  </div>
  <div class="nav-bar">
    <div class="nav-item active" onclick="gotoV3('s-home')">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="nav-lbl">Accueil</span>
    </div>
    <div class="nav-item" onclick="gotoV3('s-orders')" style="position:relative">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span class="nav-lbl">Commandes</span>
      <div class="nav-badge">1</div>
    </div>
    <div class="nav-item" onclick="gotoV3('s-fid-dashboard')">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="nav-lbl">Fidèles</span>
    </div>
    <div class="nav-item" onclick="showToast('Paramètres — bientôt disponible')">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93l-1.41 1.41M4.93 19.07l1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2M4.93 4.93l1.41 1.41M19.07 19.07l-1.41-1.41"/></svg><span class="nav-lbl">Paramètres</span>
    </div>
  </div>
</div>

<!-- ══ BOOKING MAID ══ -->
<div class="screen" id="s-booking-maid">
  <div class="back-hdr">
    <button class="back-btn" onclick="gotoV3('s-home')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="t-h2" style="flex:1">Ménage · Maid</span>
    <span class="chip chip-navy">Étape 1/3</span>
  </div>
  <div class="scroll" style="padding-bottom:80px">
    <!-- Steps -->
    <div style="display:flex;gap:5px;padding:16px 20px 20px">
      <div style="height:3px;border-radius:2px;background:var(--clay);flex:1"></div>
      <div style="height:3px;border-radius:2px;background:var(--border);flex:1"></div>
      <div style="height:3px;border-radius:2px;background:var(--border);flex:1"></div>
    </div>
    <!-- Type de prestation -->
    <div style="padding:0 20px 20px">
      <p class="t-label" style="margin-bottom:12px">Type de prestation</p>
      <div class="bk-type-grid" style="padding:0">
        <div class="bk-type-card sel" id="type-simple" onclick="toggleBkType(this,'type-simple','type-deep')">
          <div style="width:40px;height:40px;border-radius:var(--r-sm);background:var(--bg);display:flex;align-items:center;justify-content:center;margin-bottom:10px">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.8" stroke-linecap="round"><path d="M3 21l4-4M17 3l4 4-14 14-4-4z"/></svg>
          </div>
          <div style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:3px">Ménage simple</div>
          <div style="font-size:10px;color:var(--text-muted);line-height:1.5">Surfaces, sol, salle de bain, cuisine. Sans machines.</div>
          <div style="margin-top:10px;font-size:11px;font-weight:700;color:var(--clay)">dès 80 MAD</div>
        </div>
        <div class="bk-type-card" id="type-deep" onclick="toggleBkType(this,'type-deep','type-simple')">
          <div style="width:40px;height:40px;border-radius:var(--r-sm);background:var(--bg);display:flex;align-items:center;justify-content:center;margin-bottom:10px">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.8" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
          </div>
          <div style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:3px">Ménage profond</div>
          <div style="font-size:10px;color:var(--text-muted);line-height:1.5">Machines professionnelles fournies par Babloo.</div>
          <div style="margin-top:10px;font-size:11px;font-weight:700;color:var(--clay)">dès 150 MAD</div>
        </div>
      </div>
    </div>
    <!-- Superficie -->
    <div style="padding:0 20px 20px">
      <p class="t-label" style="margin-bottom:10px">Superficie du logement</p>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px">
          <div><span style="font-family:'Fraunces',serif;font-size:38px;font-weight:700;color:var(--navy)" id="surface-val">80</span><span style="font-size:14px;color:var(--text-muted)"> m²</span></div>
          <span class="chip chip-navy" id="rec-team-chip">Duo recommandé</span>
        </div>
        <input type="range" min="20" max="300" value="80" style="width:100%;accent-color:var(--navy);cursor:pointer" oninput="updateSurface(this.value)">
        <div style="display:flex;justify-content:space-between;margin-top:8px"><span style="font-size:10px;color:var(--text-muted)">Studio · 20m²</span><span style="font-size:10px;color:var(--text-muted)">Villa · 300m²</span></div>
      </div>
    </div>
    <!-- Taille équipe -->
    <div style="padding:0 20px 20px">
      <p class="t-label" style="margin-bottom:10px">Taille de l'équipe</p>
      <div style="display:flex;gap:10px">
        <div class="team-card" id="team-solo" onclick="selTeam('solo')">
          <div style="font-size:12px;font-weight:700;color:var(--navy)">Solo</div>
          <div style="font-size:10px;color:var(--text-muted);margin-top:2px">1 personne</div>
          <div style="font-size:11px;font-weight:700;color:var(--clay);margin-top:6px">dès 80 MAD</div>
        </div>
        <div class="team-card sel" id="team-duo" onclick="selTeam('duo')">
          <div style="font-size:12px;font-weight:700;color:var(--navy)">Duo</div>
          <div style="font-size:10px;color:var(--text-muted);margin-top:2px">2 personnes</div>
          <div style="font-size:11px;font-weight:700;color:var(--clay);margin-top:6px">dès 150 MAD</div>
        </div>
        <div class="team-card" id="team-squad" onclick="selTeam('squad')">
          <div style="font-size:12px;font-weight:700;color:var(--navy)">Squad</div>
          <div style="font-size:10px;color:var(--text-muted);margin-top:2px">3+ personnes</div>
          <div style="font-size:11px;font-weight:700;color:var(--clay);margin-top:6px">dès 220 MAD</div>
        </div>
      </div>
    </div>
    <!-- Estimation prix -->
    <div style="padding:0 20px 20px">
      <div class="price-dark">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
          <div>
            <div style="font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,0.45);margin-bottom:5px">Plancher minimum garanti</div>
            <div style="font-family:'Fraunces',serif;font-size:32px;font-weight:700;color:white" id="price-estimate">140 MAD</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:2px">La pro peut proposer plus en négociation</div>
          </div>
          <div style="background:rgba(255,255,255,0.1);border-radius:var(--r-md);padding:10px 12px;text-align:right">
            <div style="font-size:10px;color:rgba(255,255,255,0.45)">Durée estimée</div>
            <div style="font-size:16px;font-weight:700;color:white" id="duration-estimate">1.6–2.3h</div>
          </div>
        </div>
        <div style="background:rgba(255,255,255,0.08);border-radius:var(--r-sm);padding:10px 14px;display:flex;gap:10px;align-items:center">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.55)" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <span style="font-size:11px;color:rgba(255,255,255,0.55);line-height:1.5">Paiement uniquement en espèces à la porte. Aucun prépaiement.</span>
        </div>
      </div>
    </div>
    <!-- Instructions -->
    <div style="padding:0 20px">
      <p class="t-label" style="margin-bottom:8px">Instructions spécifiques <span style="font-weight:500;text-transform:none;letter-spacing:0;font-size:10px">(optionnel)</span></p>
      <textarea id="maid-notes" class="input-f" placeholder="Ex: Éviter la chambre du fond, animaux présents, accès digicode…" rows="3" style="resize:none;line-height:1.6" oninput="S.maid.notes=this.value"></textarea>
    </div>
  </div>
  <div class="cta-bar">
    <button class="btn btn-primary" onclick="gotoV3('s-confirm')">Continuer vers la confirmation<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg></button>
    <p style="text-align:center;font-size:11px;color:var(--text-muted)">Paiement espèces à la porte · Offre 1er service</p>
  </div>
</div>

<!-- ══ BOOKING CUISINE ══ -->
<div class="screen" id="s-booking-cuisine">
  <div class="back-hdr"><button class="back-btn" onclick="gotoV3('s-home')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><span class="t-h2" style="flex:1">Préparation culinaire</span><span class="chip chip-navy">Étape 1/3</span></div>
  <div class="scroll" style="padding-bottom:80px">
    <div style="padding:16px 20px 0">
      <div style="background:var(--warning-bg);border:1px solid rgba(176,107,0,0.25);border-radius:var(--r-md);padding:12px 14px;display:flex;gap:10px;align-items:flex-start">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span style="font-size:12px;color:var(--warning);line-height:1.55;font-weight:500">Les courses <strong>ne sont pas incluses</strong>. Prévoir les ingrédients à l'avance — la professionnelle n'effectue pas les achats.</span>
      </div>
    </div>
    <div style="padding:20px">
      <p class="t-label" style="margin-bottom:8px">Plat(s) à préparer</p>
      <textarea id="cuisine-dishes" class="input-f" placeholder="Ex: Tajine de poulet aux olives, salade marocaine, harira pour 6 personnes…" rows="4" style="resize:none;line-height:1.6" oninput="S.cuisine.dishes=this.value"></textarea>
    </div>
    <div style="padding:0 20px 20px">
      <p class="t-label" style="margin-bottom:12px">Pour combien de convives</p>
      <div class="card" style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Nombre de personnes</div>
          <div class="stepper">
            <div class="stp-btn" onclick="stepChange('guests',-1)">−</div>
            <div class="stp-val" id="guests-val">6</div>
            <div class="stp-btn" onclick="stepChange('guests',1)">+</div>
          </div>
        </div>
        <div style="text-align:right"><div style="font-size:10px;color:var(--text-muted)">Prix minimum</div><div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--clay)" id="cuisine-price-min">130 MAD</div></div>
      </div>
    </div>
    <div style="padding:0 20px 20px">
      <div class="price-dark">
        <div style="font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,0.45);margin-bottom:6px">Plancher minimum</div>
        <div style="font-family:'Fraunces',serif;font-size:30px;font-weight:700;color:white;margin-bottom:3px" id="cuisine-price-hero">130 MAD</div>
        <div style="font-size:11px;color:rgba(255,255,255,0.5)" id="cuisine-note">Pour 6 personnes · hors ingrédients · prix final négocié</div>
      </div>
    </div>
  </div>
  <div class="cta-bar"><button class="btn btn-primary" onclick="gotoV3('s-confirm')">Confirmer la demande</button></div>
</div>

<!-- ══ BOOKING CHILDCARE ══ -->
<div class="screen" id="s-booking-childcare">
  <div class="back-hdr"><button class="back-btn" onclick="gotoV3('s-home')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><span class="t-h2" style="flex:1">Garde d'enfants</span><span class="chip chip-navy">Étape 1/3</span></div>
  <div class="scroll" style="padding-bottom:80px">
    <div style="padding:20px">
      <p class="t-label" style="margin-bottom:10px">Nombre d'enfants</p>
      <div class="card" style="display:flex;align-items:center;justify-content:space-between">
        <div class="stepper"><div class="stp-btn" onclick="stepChange('children',-1)">−</div><div class="stp-val" id="children-val">2</div><div class="stp-btn" onclick="stepChange('children',1)">+</div></div>
        <div style="text-align:right"><div style="font-size:10px;color:var(--text-muted)">min. par enfant</div><div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--clay)">80 MAD</div></div>
      </div>
    </div>
    <div style="padding:0 20px 20px">
      <p class="t-label" style="margin-bottom:10px">Durée de garde (heures)</p>
      <div class="card" style="display:flex;align-items:center;justify-content:space-between">
        <div class="stepper"><div class="stp-btn" onclick="stepChange('hours',-1)">−</div><div class="stp-val" id="hours-val">3</div><div class="stp-btn" onclick="stepChange('hours',1)">+</div></div>
        <div style="text-align:right"><div style="font-size:10px;color:var(--text-muted)">Total estimé</div><div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--clay)" id="childcare-price">210 MAD</div></div>
      </div>
    </div>
    <div style="padding:0 20px 20px">
      <p class="t-label" style="margin-bottom:8px">Informations complémentaires</p>
      <textarea id="childcare-notes" class="input-f" placeholder="Allergies, médicaments, habitudes, numéros d'urgence à contacter…" rows="3" style="resize:none;line-height:1.6" oninput="S.childcare.notes=this.value"></textarea>
    </div>
    <div style="padding:0 20px 20px">
      <div class="price-dark">
        <div style="font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,0.45);margin-bottom:6px">Estimation plancher</div>
        <div style="font-family:'Fraunces',serif;font-size:30px;font-weight:700;color:white;margin-bottom:3px" id="childcare-price-hero">210 MAD</div>
        <div style="font-size:11px;color:rgba(255,255,255,0.5)" id="childcare-note">2 enfants · 3h · prix final négocié</div>
      </div>
    </div>
  </div>
  <div class="cta-bar"><button class="btn btn-primary" onclick="gotoV3('s-confirm')">Confirmer la demande</button></div>
</div>

<!-- ══ CONFIRM ══ -->
<div class="screen" id="s-confirm">
  <div class="back-hdr"><button class="back-btn" onclick="goBk()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><span class="t-h2">Récapitulatif</span><span class="chip chip-navy">Étape 2/3</span></div>
  <div class="scroll" style="padding-bottom:90px"><div id="dyn-confirm" style="padding:20px;display:flex;flex-direction:column;gap:14px"></div>
  </div>
  <div class="cta-bar">
    <button class="btn btn-clay" onclick="gotoV3('s-search')">Confirmer et lancer la recherche<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg></button>
    <p style="text-align:center;font-size:11px;color:var(--text-muted)" id="conf-note">Aucun prépaiement requis · Offre 1er service active</p>
  </div>
</div>

<!-- ══ SEARCH (Recherche en cours) ══ -->
<div class="screen" id="s-search">
  <div class="back-hdr">
    <button class="back-btn" onclick="gotoV3('s-confirm')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="t-h2" style="flex:1">Recherche en cours</span>
    <span class="chip chip-warn" id="search-chip">Recherche…</span>
  </div>
  <div class="scroll">
    <div style="padding:40px 20px;text-align:center" id="search-anim">
      <div style="width:100px;height:100px;margin:0 auto 24px;position:relative">
        <div style="width:100px;height:100px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--clay);animation:spin 1s linear infinite"></div>
        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        </div>
      </div>
      <div class="t-h1" style="margin-bottom:6px">Nous cherchons<br>votre équipe</div>
      <div class="t-body" style="margin-bottom:28px">Professionnelles disponibles dans<br>votre quartier en ce moment…</div>
      <div style="background:var(--border);border-radius:var(--r-full);height:6px;max-width:260px;margin:0 auto 10px;overflow:hidden">
        <div id="search-prog" style="width:0%;height:100%;background:linear-gradient(90deg,var(--clay),var(--clay-light));border-radius:var(--r-full);transition:width .4s ease"></div>
      </div>
      <div id="search-status-txt" style="font-size:12px;color:var(--text-muted);font-weight:500">Vérification des disponibilités…</div>
    </div>
    <div id="search-results" style="display:none;padding:0 20px 20px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="16 8 10 16 7 13"/></svg>
        <span style="font-family:'Fraunces',serif;font-size:17px;font-weight:600;color:var(--navy)">Professionnelles trouvées</span>
      </div>
      <div style="background:var(--surface);border-radius:var(--r-lg);padding:16px;box-shadow:var(--sh-sm);border:2px solid var(--navy);margin-bottom:12px;cursor:pointer" onclick="openModal('modal-pro-select');selectPro('a')">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div class="avatar av-lg av-a">FZ</div>
          <div style="flex:1">
            <div style="font-size:15px;font-weight:700;color:var(--navy)">Fatima Zahra</div>
            <div style="font-size:11px;color:var(--text-sec)">Coordinatrice · 7 ans d'exp.</div>
            <div style="display:flex;align-items:center;gap:4px;margin-top:4px">
              <span style="font-size:13px;font-weight:700;color:var(--navy)">4.9</span>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="var(--navy)" stroke="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              <span style="font-size:11px;color:var(--text-muted)">· 47 prestations</span>
            </div>
          </div>
          <span class="chip chip-success">Disponible</span>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <span class="chip chip-navy" style="font-size:10px">Ménage</span>
          <span class="chip chip-navy" style="font-size:10px">Cuisine</span>
          <span class="chip" style="font-size:10px">Fiabilité 96%</span>
        </div>
        <div style="margin-top:10px;font-size:12px;color:var(--clay);font-weight:600;display:flex;align-items:center;gap:4px">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
          Voir le profil et sélectionner
        </div>
      </div>
      <div style="background:var(--surface);border-radius:var(--r-lg);padding:16px;box-shadow:var(--sh-sm);border:1.5px solid var(--border);margin-bottom:12px;cursor:pointer" onclick="openModal('modal-pro-select');selectPro('b')">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div class="avatar av-lg av-b">KB</div>
          <div style="flex:1">
            <div style="font-size:15px;font-weight:700;color:var(--navy)">Khadija Benali</div>
            <div style="font-size:11px;color:var(--text-sec)">Spécialiste sol · 4 ans d'exp.</div>
            <div style="display:flex;align-items:center;gap:4px;margin-top:4px">
              <span style="font-size:13px;font-weight:700;color:var(--navy)">4.7</span>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="var(--navy)" stroke="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              <span style="font-size:11px;color:var(--text-muted)">· 31 prestations</span>
            </div>
          </div>
          <span class="chip chip-success">Disponible</span>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <span class="chip chip-navy" style="font-size:10px">Ménage</span>
          <span class="chip chip-navy" style="font-size:10px">Repassage</span>
          <span class="chip" style="font-size:10px">Fiabilité 91%</span>
        </div>
        <div style="margin-top:10px;font-size:12px;color:var(--clay);font-weight:600;display:flex;align-items:center;gap:4px">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
          Voir le profil et sélectionner
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══ STATUS / TRACKING ══ -->
<div class="screen" id="s-status">
  <div class="back-hdr">
    <button class="back-btn" onclick="gotoV3('s-home')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="t-h2" id="status-order-title" style="flex:1">Commande</span>
    <span class="chip chip-success" id="status-main-chip">Confirmé</span>
  </div>
  <div class="scroll"><div id="dyn-status" style="padding:20px;display:flex;flex-direction:column;gap:14px"></div></div>
</div>


<!-- ══ ORDER CONFIRMED ══ -->
<div class="screen" id="s-order-confirmed">
  <div style="background:var(--surface);padding:52px 20px 20px;border-bottom:1px solid var(--border);flex-shrink:0;text-align:center">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" style="margin-bottom:12px"><circle cx="12" cy="12" r="10"/><polyline points="16 8 10 16 7 13"/></svg>
    <div class="t-h1" style="margin-bottom:4px">Commande confirmée !</div>
    <div class="t-body">Votre prestation est en route</div>
  </div>
  <div class="scroll">
    <div style="padding:20px;display:flex;flex-direction:column;gap:14px" id="dyn-order-confirmed"></div>
  </div>
  <div class="cta-bar">
    <button class="btn btn-primary" onclick="openLiveStatus()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Suivre ma commande
    </button>
  </div>
</div>

<!-- ══ CHAT / NÉGOCIATION ══ -->
<div class="screen" id="s-chat">
  <div class="back-hdr">
    <button class="back-btn" onclick="chatGoBack()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="avatar av-md av-a" id="chat-hdr-avatar">FZ</div>
    <div style="flex:1;padding-left:4px">
      <div style="font-size:14px;font-weight:700;color:var(--navy)" id="chat-hdr-name">Fatima Zahra</div>
      <div style="font-size:11px;color:var(--text-muted)" id="chat-hdr-role">Coordinatrice · En ligne</div>
    </div>
    <div class="chip chip-success" style="font-size:9px">Négociation</div>
  </div>
  <div class="scroll" style="padding:16px 20px;display:flex;flex-direction:column;gap:12px" id="nego-scroll">
    <!-- Messages area -->
    <div id="chat-msgs" style="display:flex;flex-direction:column;gap:8px"></div>
    <!-- Negotiation panel -->
    <div id="nego-panel"></div>
  </div>
  <div style="padding:10px 20px 28px;background:#fff;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0">
    <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.8" stroke-linecap="round" style="flex-shrink:0;cursor:pointer" onclick="showToast('Caméra — bientôt')"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/></svg>
    <input class="input-f" placeholder="Écrire un message…" id="chat-inp" style="border-radius:var(--r-full);font-size:14px;flex:1" onkeydown="chatSend(event)">
    <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.8" stroke-linecap="round" style="flex-shrink:0;cursor:pointer" onclick="showToast('Micro — bientôt')"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
  </div>
</div>

<!-- ══ RATING ══ -->
<div class="screen" id="s-rating">
  <div style="background:var(--surface);padding:52px 20px 18px;border-bottom:1px solid var(--border);flex-shrink:0">
    <div class="t-h1" style="margin-bottom:3px">Prestation terminée</div>
    <div class="t-body">Évaluez votre expérience pour aider la communauté</div>
  </div>
  <div class="scroll" style="padding-bottom:90px">
    <div style="padding:20px;display:flex;flex-direction:column;gap:14px">
      <!-- Note globale -->
      <div class="card">
        <div class="t-label" style="margin-bottom:14px">Note globale</div>
        <div style="display:flex;gap:10px" id="stars-global">
          <svg onclick="setRating(1)" style="width:32px;height:32px;fill:var(--navy);cursor:pointer;transition:fill .15s" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          <svg onclick="setRating(2)" style="width:32px;height:32px;fill:var(--navy);cursor:pointer;transition:fill .15s" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          <svg onclick="setRating(3)" style="width:32px;height:32px;fill:var(--navy);cursor:pointer;transition:fill .15s" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          <svg onclick="setRating(4)" style="width:32px;height:32px;fill:var(--navy);cursor:pointer;transition:fill .15s" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          <svg onclick="setRating(5)" style="width:32px;height:32px;fill:#D8D7EE;cursor:pointer;transition:fill .15s" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
        </div>
      </div>
      <!-- Commentaire -->
      <div class="card">
        <div class="t-label" style="margin-bottom:8px">Commentaire</div>
        <textarea class="input-f" id="rating-comment" placeholder="Travail soigné, professionnelles très agréables et ponctuelles…" rows="3" style="border:none;padding:0;resize:none;font-size:14px;color:var(--navy)"></textarea>
      </div>
      <div class="card">
        <div class="t-label" style="margin-bottom:10px">Pourboire (optionnel)</div>
        <div id="rating-tip-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px"></div>
        <div id="rating-tip-total" style="margin-top:10px;font-size:12px;color:var(--text-muted)"></div>
      </div>
      <!-- Teaser fidélisation -->
      <div style="background:linear-gradient(135deg,var(--navy) 0%,#2D1F8A 100%);border-radius:var(--r-xl);padding:22px;position:relative;overflow:hidden;cursor:pointer" onclick="openSquadReview('s-rating')">
        <div style="position:absolute;top:-26px;right:-26px;width:120px;height:120px;border-radius:50%;border:24px solid rgba(255,255,255,0.05)"></div>
        <div style="font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--clay-light);margin-bottom:7px">Nouveau · Fidélisation</div>
        <div style="font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:white;line-height:1.3;margin-bottom:7px">Engagez votre équipe<br>sur le long terme</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.55);line-height:1.6;margin-bottom:16px">CNSS incluse · Planning flexible · Professionnelles que vous connaissez déjà</div>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="display:flex" id="rating-fid-avatars">
            <div class="avatar av-sm av-a" style="border:2px solid rgba(14,20,66,0.6)">FZ</div>
            <div class="avatar av-sm av-b" style="border:2px solid rgba(14,20,66,0.6);margin-left:-8px">KB</div>
          </div>
          <span style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.75)" id="rating-fid-names">Fatima Z. · Khadija B.</span>
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2.5" stroke-linecap="round" style="margin-left:auto"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
      </div>
    </div>
  </div>
    <div style="background:#fff;border-top:1px solid var(--border);padding:14px 20px 0;flex-shrink:0">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div><div class="t-label" style="margin-bottom:2px">Total mensuel estimé</div><div id="sq-total" style="font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--navy)">1 550 MAD<span style="font-size:13px;font-weight:500;color:var(--text-muted)">/mois</span></div></div>
      <div style="text-align:right"><div class="t-label">Sélectionnées</div><div id="sq-count" style="font-size:18px;font-weight:700;color:var(--navy)">2 / 3</div></div>
    </div>
  </div>
<div class="cta-bar">
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" style="flex:1" onclick="submitAndFidelize()">Fidéliser l'équipe</button>
      <button class="btn btn-primary" style="flex:2" onclick="submitRating()">Terminer</button>
    </div>
  </div>
</div>

<!-- ══ SQUAD REVIEW ══ -->
<div class="screen" id="s-squad-review">
  <div style="background:var(--navy);padding:52px 20px 20px;flex-shrink:0">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <button class="back-btn" onclick="backFromSquad()" style="background:rgba(255,255,255,0.1);color:white"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
      <div><div style="font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:white">Votre équipe d'aujourd'hui</div><div style="font-size:12px;color:rgba(255,255,255,0.5);margin-top:2px">Sélectionnez qui fidéliser</div></div>
    </div>
    <!-- Toggle all -->
    <div style="display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.08);border-radius:var(--r-md);padding:12px 16px;cursor:pointer" onclick="toggleAll()">
      <span style="font-size:13px;font-weight:600;color:rgba(255,255,255,0.85)">Fidéliser tout le Squad</span>
      <div class="tgl on" id="tgl-all"></div>
    </div>
  </div>
  <div class="scroll" style="padding-bottom:10px">
    <div style="height:16px"></div>
    <div id="squad-cards"></div>
    <div style="height:10px"></div>
  </div>
  <!-- Summary -->
  <div style="background:var(--surface);border-top:1px solid var(--border);padding:14px 20px 28px;flex-shrink:0">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div><div class="t-label" style="margin-bottom:2px">Total mensuel estimé</div><div style="font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--navy)" id="fid-total">1 550 MAD<span style="font-size:13px;font-weight:500;color:var(--text-muted)">/mois</span></div></div>
      <div style="text-align:right"><div class="t-label">Sélectionnées</div><div style="font-size:18px;font-weight:700;color:var(--navy)" id="fid-count">2 / 3</div></div>
    </div>
    <button class="btn btn-clay" onclick="gotoV3('s-fid-configure')">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      Configurer les fidélisations
    </button>
  </div>
</div>

<!-- ══ FIDELISATION CONFIGURE ══ -->
<div class="screen" id="s-fid-configure">
  <div style="background:var(--navy);padding:52px 20px 20px;flex-shrink:0">
    <div style="display:flex;align-items:center;gap:14px">
      <button class="back-btn" onclick="gotoV3('s-squad-review')" style="background:rgba(255,255,255,0.1);color:white"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
      <div class="avatar av-lg av-a" id="fid-cfg-av">FZ</div>
      <div style="flex:1">
        <div style="font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:3px">Configuration · 1 sur 2</div>
        <div style="font-family:'Fraunces',serif;font-size:19px;font-weight:700;color:white" id="fid-cfg-name">Fatima Zahra</div>
        <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:2px" id="fid-cfg-sub">Coordinatrice · 4.9 ★</div>
      </div>
      <div style="display:flex;gap:6px">
        <div style="width:8px;height:8px;border-radius:50%;background:white"></div>
        <div style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.3)"></div>
      </div>
    </div>
  </div>
  <div class="scroll" style="padding-bottom:90px">
    <!-- CNSS badge -->
    <div style="padding:16px 20px 0">
      <div style="background:var(--success-bg);border:1px solid rgba(26,122,80,0.25);border-radius:var(--r-md);padding:12px 14px;display:flex;gap:10px;align-items:center">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" style="flex-shrink:0"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <div><div style="font-size:13px;font-weight:700;color:var(--success)">CNSS incluse</div><div style="font-size:11px;color:var(--success);opacity:.8;line-height:1.5;margin-top:2px">Fatima bénéficie d'une couverture sociale. Un avantage majeur pour fidéliser les meilleures professionnelles.</div></div>
      </div>
    </div>
    <!-- Skills (dynamically rendered) -->
    <div style="padding:20px 20px 0">
      <div class="t-label" style="margin-bottom:12px">Compétences demandées</div>
      <div id="skill-rows"></div>
    </div>
    <!-- Heures mensuelles -->
    <div style="padding:20px 20px 0">
      <div class="t-label" style="margin-bottom:10px">Heures mensuelles engagées</div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px">
          <div><span style="font-family:'Fraunces',serif;font-size:38px;font-weight:700;color:var(--navy)" id="h-month">28</span><span style="font-size:14px;color:var(--text-muted)"> h/mois</span></div>
          <span style="font-size:12px;color:var(--text-sec)">≈ 7h / semaine</span>
        </div>
        <input type="range" min="10" max="80" value="28" style="width:100%;accent-color:var(--navy);cursor:pointer" oninput="updH(this.value)">
        <div style="display:flex;justify-content:space-between;margin-top:8px"><span style="font-size:10px;color:var(--text-muted)">10h minimum</span><span style="font-size:10px;color:var(--text-muted)">80h maximum</span></div>
      </div>
    </div>
    <!-- Prix résumé (dynamically rendered) -->
    <div style="padding:20px 20px 0" id="fid-price-summ"></div>
    <!-- Créneaux préférentiels -->
    <div style="padding:20px 20px 0">
      <div class="t-label" style="margin-bottom:10px">Créneaux préférentiels</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div class="pref-slot" id="pref-slot-morning" onclick="togglePrefSlot('morning')">
          <div class="pref-slot-title">Matin</div>
          <div class="pref-slot-sub">8h – 13h</div>
        </div>
        <div class="pref-slot" id="pref-slot-afternoon" onclick="togglePrefSlot('afternoon')">
          <div class="pref-slot-title">Après-midi</div>
          <div class="pref-slot-sub">14h – 18h</div>
        </div>
        <div class="pref-slot" id="pref-slot-flexible" onclick="togglePrefSlot('flexible')">
          <div class="pref-slot-title">Flexible</div>
          <div class="pref-slot-sub">Selon disponibilité</div>
        </div>
        <div class="pref-slot" id="pref-slot-recurring" onclick="togglePrefSlot('recurring')">
          <div class="pref-slot-title">Récurrent</div>
          <div class="pref-slot-sub">Lundi · Jeudi</div>
        </div>
      </div>
    </div>
    <!-- Règle d'annulation -->
    <div style="padding:20px 20px 0">
      <div style="background:var(--warning-bg);border-radius:var(--r-lg);padding:16px 18px;border:1px solid rgba(176,107,0,0.2);display:flex;gap:12px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;margin-top:1px"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <div><div style="font-size:12px;font-weight:700;color:var(--warning);margin-bottom:4px">Règle d'annulation</div><div style="font-size:11px;color:var(--warning);line-height:1.6;opacity:.9">En cas d'empêchement, la professionnelle doit prévenir <strong>72h à l'avance</strong>. Sans préavis, une session est offerte au client lors de la prochaine intervention.</div></div>
      </div>
    </div>
    <div style="height:20px"></div>
  </div>
  <div class="cta-bar">
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" style="flex:1" onclick="openProCalendar((S&&S.fid&&S.fid.curPro)||'a','s-fid-configure')">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Calendrier
      </button>
      <button class="btn btn-primary" style="flex:2" id="fid-next-btn" onclick="nextFidConfig()">
        Suivante : Khadija
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- ══ FIDELISATION CALENDAR ══ -->
<div class="screen" id="s-fid-calendar">
  <div class="back-hdr">
    <button class="back-btn" onclick="goCalendarBack()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="t-h2" id="cal-title" style="flex:1">Planning partagé</span>
    <button class="btn btn-xs btn-ghost" onclick="openModal('modal-slot')">+ Créneau</button>
  </div>
  <!-- Tabs -->
  <div style="display:flex;padding:0 20px;gap:0;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0">
    <div id="cal-tab-equipe" style="padding:12px 14px;font-size:13px;font-weight:700;color:var(--navy);border-bottom:2px solid var(--navy);cursor:pointer" onclick="switchCalTab('equipe')">Équipe</div>
    <div id="cal-tab-moi" style="padding:12px 14px;font-size:13px;font-weight:600;color:var(--text-muted);border-bottom:2px solid transparent;cursor:pointer" onclick="switchCalTab('moi')">Mon planning</div>
    <div style="padding:12px 16px;font-size:13px;font-weight:600;color:var(--text-muted);border-bottom:2px solid transparent;cursor:pointer" onclick="showToast('Récurrences — bientôt')">Récurrences</div>
  </div>
  <!-- Legend -->
  <div id="cal-legend" style="padding:10px 20px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:6px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:8px"><div style="width:10px;height:10px;border-radius:50%;background:var(--pro-a)"></div><span style="font-size:11px;font-weight:600;color:var(--navy)">Fatima Zahra</span></div>
      <div style="display:flex;gap:6px"><span class="chip chip-success" style="font-size:9px">Disponible</span><span class="chip chip-warn" style="font-size:9px">Demandé</span></div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:8px"><div style="width:10px;height:10px;border-radius:50%;background:var(--pro-b)"></div><span style="font-size:11px;font-weight:600;color:var(--navy)">Khadija Benali</span></div>
      <div style="display:flex;gap:6px"><span class="chip chip-success" style="font-size:9px">Disponible</span></div>
    </div>
  </div>
  <!-- Week grid -->
  <div class="scroll">
    <div id="cal-grid"></div>
  </div>
  <div class="cta-bar">
    <button class="btn btn-primary" id="cal-primary-cta" onclick="gotoV3('s-fid-contract')">Valider et envoyer l'offre</button>
  </div>
</div>

<!-- ══ FIDELISATION CONTRACT ══ -->
<div class="screen" id="s-fid-contract">
  <div class="back-hdr"><button class="back-btn" onclick="gotoV3('s-fid-configure')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button><span class="t-h2">Conditions d'engagement</span></div>
  <div class="scroll" style="padding-bottom:90px">
    <div style="padding:20px;display:flex;flex-direction:column;gap:14px">
      <!-- Summary (dynamically rendered) -->
      <div class="card" id="contract-summ"></div>
      <!-- Conditions -->
      <div style="background:var(--bg-alt);border-radius:var(--r-lg);padding:18px">
        <div class="t-h3" style="margin-bottom:14px">Conditions de l'engagement</div>
        <div style="display:flex;flex-direction:column;gap:12px">
          <div style="display:flex;gap:10px;align-items:flex-start">
            <div style="width:6px;height:6px;border-radius:50%;background:var(--navy);margin-top:6px;flex-shrink:0"></div>
            <span class="t-body">Chaque professionnelle est libre d'accepter ou refuser l'offre de fidélisation individuellement.</span>
          </div>
          <div style="display:flex;gap:10px;align-items:flex-start">
            <div style="width:6px;height:6px;border-radius:50%;background:var(--navy);margin-top:6px;flex-shrink:0"></div>
            <span class="t-body">Les tarifs sont des planchers. La professionnelle peut proposer un ajustement lors de l'acceptation.</span>
          </div>
          <div style="display:flex;gap:10px;align-items:flex-start">
            <div style="width:6px;height:6px;border-radius:50%;background:var(--navy);margin-top:6px;flex-shrink:0"></div>
            <span class="t-body">Paiement mensuel en espèces à chaque début de mois. La couverture CNSS est gérée par Babloo.</span>
          </div>
          <div style="display:flex;gap:10px;align-items:flex-start">
            <div style="width:6px;height:6px;border-radius:50%;background:var(--warning);margin-top:6px;flex-shrink:0"></div>
            <span class="t-body">Annulation d'un créneau : préavis 72h requis, sinon une session est offerte au client.</span>
          </div>
          <div style="display:flex;gap:10px;align-items:flex-start">
            <div style="width:6px;height:6px;border-radius:50%;background:var(--navy);margin-top:6px;flex-shrink:0"></div>
            <span class="t-body">Résiliation possible avec 1 mois de préavis par l'une ou l'autre des parties.</span>
          </div>
        </div>
      </div>
      <!-- Toggle accept -->
      <div style="background:var(--surface);border-radius:var(--r-lg);padding:16px;box-shadow:var(--sh-sm);display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:13px;font-weight:600;color:var(--navy);max-width:240px;line-height:1.5">J'accepte les conditions et je confirme l'envoi des offres</span>
        <div class="tgl on" id="accept-tgl" onclick="this.classList.toggle('on')"></div>
      </div>
    </div>
  </div>
  <div class="cta-bar">
    <button class="btn btn-clay" onclick="sendFidOffers()">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      Envoyer les offres de fidélisation
    </button>
    <p style="text-align:center;font-size:11px;color:var(--text-muted)">Chaque professionnelle recevra et validera individuellement</p>
  </div>
</div>

<!-- ══ FIDELISATION DASHBOARD ══ -->
<div class="screen" id="s-fid-dashboard">
  <div style="background:var(--surface);padding:52px 20px 16px;border-bottom:1px solid var(--border);flex-shrink:0">
    <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--navy);margin-bottom:2px">Mes Fidèles</div>
    <div style="font-size:12px;color:var(--text-muted)" id="fid-dash-sub">Aucune offre envoyée pour le moment</div>
  </div>
  <div class="scroll">
    <div style="height:16px"></div>
    <div id="fid-dashboard-list"></div>
    <!-- Book a slot CTA -->
    <div style="padding:4px 20px 20px">
      <button class="btn btn-outline" onclick="openMyCalendar('s-fid-dashboard')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Calendrier
      </button>
    </div>
  </div>
  <div class="nav-bar">
    <div class="nav-item" onclick="gotoV3('s-home')"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="nav-lbl">Accueil</span></div>
    <div class="nav-item" onclick="gotoV3('s-orders')" style="position:relative"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span class="nav-lbl">Commandes</span><div class="nav-badge">1</div></div>
    <div class="nav-item active" onclick="gotoV3('s-fid-dashboard')"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="nav-lbl">Fidèles</span></div>
    <div class="nav-item" onclick="showToast('Paramètres — bientôt')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93l-1.41 1.41M4.93 19.07l1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2M4.93 4.93l1.41 1.41M19.07 19.07l-1.41-1.41"/></svg><span class="nav-lbl">Paramètres</span></div>
  </div>
</div>

<!-- ══ ORDERS ══ -->
<div class="screen" id="s-orders">
  <div style="background:var(--surface);padding:52px 20px 16px;border-bottom:1px solid var(--border);flex-shrink:0">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--navy)">Mes commandes</div>
      <div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center" id="orders-logo"></div>
    </div>
  </div>
  <div class="scroll" id="orders-list"></div>
  <div class="nav-bar">
    <div class="nav-item" onclick="gotoV3('s-home')"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="nav-lbl">Accueil</span></div>
    <div class="nav-item active" onclick="gotoV3('s-orders')" style="position:relative"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span class="nav-lbl">Commandes</span></div>
    <div class="nav-item" onclick="gotoV3('s-fid-dashboard')"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="nav-lbl">Fidèles</span></div>
    <div class="nav-item" onclick="showToast('Paramètres — bientôt')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93l-1.41 1.41M4.93 19.07l1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2M4.93 4.93l1.41 1.41M19.07 19.07l-1.41-1.41"/></svg><span class="nav-lbl">Paramètres</span></div>
  </div>
</div>

<!-- ══ ORDER DETAIL ══ -->
<div class="screen" id="s-order-detail">
  <div class="back-hdr">
    <button class="back-btn" onclick="gotoV3('s-orders')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="t-h2" style="flex:1" id="od-title">Détail commande</span>
    <span class="chip" id="od-status-chip">—</span>
  </div>
  <div class="scroll" id="od-content" style="padding:20px;display:flex;flex-direction:column;gap:14px"></div>
</div>

<!-- MODALS -->
<div class="modal-ov" id="modal-location" onclick="closeModal('modal-location')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div style="font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--navy);margin-bottom:4px">Adresse de service</div>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:18px">Babloo opère uniquement dans Rabat et Salé</div>
    <input class="input-f" id="loc-search" placeholder="Rechercher une adresse..." style="margin-bottom:14px" oninput="filterZones(this.value)">
    <div class="t-label" style="margin-bottom:10px">Zones disponibles</div>
    <div class="zone-pill sel" onclick="selectZone(this,'Agdal, Rabat')">
      <div style="width:10px;height:10px;border-radius:50%;background:var(--success);flex-shrink:0"></div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--navy)">Agdal</div><div style="font-size:11px;color:var(--text-muted)">Rabat · Quartier actuel</div></div>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <div class="zone-pill" onclick="selectZone(this,'Hay Riad, Rabat')">
      <div style="width:10px;height:10px;border-radius:50%;background:var(--success);flex-shrink:0"></div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--navy)">Hay Riad</div><div style="font-size:11px;color:var(--text-muted)">Rabat</div></div>
    </div>
    <div class="zone-pill" onclick="selectZone(this,'Hassan, Rabat')">
      <div style="width:10px;height:10px;border-radius:50%;background:var(--success);flex-shrink:0"></div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--navy)">Hassan</div><div style="font-size:11px;color:var(--text-muted)">Rabat · Centre</div></div>
    </div>
    <div class="zone-pill" onclick="selectZone(this,'Salé Médina, Salé')">
      <div style="width:10px;height:10px;border-radius:50%;background:var(--pro-b);flex-shrink:0"></div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--navy)">Salé Médina</div><div style="font-size:11px;color:var(--text-muted)">Salé</div></div>
    </div>
    <div class="zone-pill" onclick="selectZone(this,'Tabriquet, Salé')">
      <div style="width:10px;height:10px;border-radius:50%;background:var(--pro-b);flex-shrink:0"></div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--navy)">Tabriquet</div><div style="font-size:11px;color:var(--text-muted)">Salé</div></div>
    </div>
    <!-- Out of zone -->
    <div style="background:rgba(176,35,15,0.06);border:1px solid rgba(176,35,15,0.18);border-radius:var(--r-md);padding:12px 14px;margin-top:6px;display:flex;gap:10px;align-items:flex-start">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--error)" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
      <span style="font-size:11px;color:var(--error);line-height:1.5">Les adresses hors de Rabat–Salé ne sont pas encore disponibles. Babloo arrive bientôt dans d'autres villes.</span>
    </div>
  </div>
</div>

<div class="modal-ov" id="modal-slot" onclick="closeModal('modal-slot')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div style="font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--navy);margin-bottom:16px">Demander un créneau</div>
    <div class="t-label" style="margin-bottom:8px">Professionnelle</div>
    <div style="display:flex;gap:8px;margin-bottom:18px" id="slot-pro-options">
      <div class="slot-pro-opt sel" id="slot-pro-a" data-pro="a" onclick="selectSlotPro('a')">
        <div class="avatar av-sm av-a">FZ</div><span style="font-size:12px;font-weight:700;color:var(--navy)">Fatima</span>
      </div>
      <div class="slot-pro-opt" id="slot-pro-b" data-pro="b" onclick="selectSlotPro('b')">
        <div class="avatar av-sm av-b">KB</div><span style="font-size:12px;font-weight:600;color:var(--text-sec)">Khadija</span>
      </div>
    </div>
    <div class="t-label" style="margin-bottom:8px">Jour</div>
    <input class="input-f" type="date" style="margin-bottom:14px" value="2026-02-24">
    <div style="display:flex;gap:10px;margin-bottom:18px">
      <div style="flex:1"><div class="t-label" style="margin-bottom:6px">Début</div><input class="input-f" type="time" value="10:00"></div>
      <div style="flex:1"><div class="t-label" style="margin-bottom:6px">Fin</div><input class="input-f" type="time" value="13:00"></div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
      <span style="font-size:13px;font-weight:600;color:var(--navy)">Récurrent chaque semaine</span>
      <div class="tgl" id="rec-tgl" onclick="this.classList.toggle('on')"></div>
    </div>
    <button class="btn btn-clay" onclick="requestSlot()">Envoyer la demande</button>
  </div>
</div>

<!-- PRO SELECTION MODAL -->
<div class="modal-ov" id="modal-pro-select" onclick="closeModal('modal-pro-select')">
  <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:88%">
    <div class="modal-handle"></div>
    <div id="pro-select-content"></div>
  </div>
</div>



<!-- ══ FORGOT PASSWORD ══ -->
<div class="screen" id="screen-forgot-password" role="main" aria-label="Mot de passe oublié">
  <header class="auth-sub-header">
    <button class="auth-back-btn" onclick="goForgotBack()" aria-label="Retour"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="auth-sub-title-sm">Récupération</span>
    <span style="width:34px"></span>
  </header>
  <div class="scroll" style="padding-bottom:40px">
    <div class="auth-sub-body">
      <div class="auth-sub-intro">
        <h1 class="auth-display-title">Mot de passe<br>oublié<span class="auth-clay-dot">?</span></h1>
        <p class="t-body">Entrez votre e-mail, nous vous envoyons un lien de réinitialisation</p>
      </div>
      <div class="auth-field-group">
        <div class="auth-field">
          <label class="auth-label" for="fp-email">Adresse e-mail</label>
          <input class="input-f auth-input" type="email" id="fp-email" placeholder="votre@email.com" autocomplete="email" inputmode="email"/>
          <span class="auth-field-err" id="fp-email-err" role="alert" hidden></span>
        </div>
      </div>
      <div class="auth-alert auth-alert--error" id="fp-global-err" hidden role="alert">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="fp-global-err-msg"></span>
      </div>
      <div id="fp-success" hidden style="background:var(--success-bg);border:1.5px solid var(--success);border-radius:var(--r-lg);padding:18px;text-align:center;margin-bottom:14px">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2.5" stroke-linecap="round" style="margin-bottom:8px"><circle cx="12" cy="12" r="10"/><polyline points="16 8 10 16 7 13"/></svg>
        <div style="font-size:14px;font-weight:700;color:var(--navy);margin-bottom:4px">E-mail envoyé !</div>
        <div style="font-size:12px;color:var(--success);line-height:1.5">Vérifiez votre boîte de réception et suivez le lien pour réinitialiser votre mot de passe.</div>
      </div>
      <button class="btn btn-primary auth-cta" id="fp-submit">
        <span class="auth-cta-label">Envoyer le lien</span>
        <span class="auth-cta-loader" hidden><span class="auth-spinner"></span>Envoi…</span>
      </button>
      <div style="text-align:center;margin-top:16px">
        <button type="button" class="auth-link-sm" onclick="goForgotBack()" style="font-size:13px">← Retour à la connexion</button>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================
     BABLOO — OTP VERIFICATION SCREEN
     Drop inside your .screen wrapper, hidden by default.
     Add class "active" or show via your existing nav logic.
     ============================================================ -->
<div class="screen otp-screen" id="screen-otp" role="main" aria-label="Vérification par code SMS">

  <!-- ── Header ── -->
  <header class="otp-header">
    <button class="otp-back-btn" id="otp-back" aria-label="Retour">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
        <path d="M13 16L7 10L13 4" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <span class="otp-header-title t-label">Vérification</span>
    <span class="otp-header-spacer" aria-hidden="true"></span>
  </header>

  <!-- ── Body ── -->
  <div class="otp-body">

    <!-- Icon badge -->
    <div class="otp-icon-wrap" aria-hidden="true">
      <div class="otp-icon-ring">
        <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
          <path d="M21 3H7C5.9 3 5 3.9 5 5V23C5 24.1 5.9 25 7 25H21C22.1 25 23 24.1 23 23V5C23 3.9 22.1 3 21 3Z"
                stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 21H14.01" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
          <rect x="10" y="7" width="8" height="1.5" rx="0.75" fill="currentColor" opacity=".35"/>
        </svg>
      </div>
    </div>

    <!-- Title block -->
    <div class="otp-intro">
      <h1 class="otp-title t-h1">Code envoyé<br>par SMS</h1>
      <p class="otp-desc t-body">
        Entrez le code à 6 chiffres envoyé au
      </p>
      <p class="otp-phone" id="otp-phone-display">+212 06 ·· ·· ·· 42</p>
    </div>

    <!-- OTP Input Row -->
    <fieldset class="otp-fieldset" id="otp-fieldset" aria-label="Code de vérification à 6 chiffres">
      <legend class="sr-only">Code de vérification</legend>
      <div class="otp-boxes" id="otp-boxes" role="group">
        <input class="otp-box" type="tel" inputmode="numeric" pattern="[0-9]"
               maxlength="1" autocomplete="one-time-code"
               aria-label="Chiffre 1 du code" id="otp-0" data-index="0"/>
        <input class="otp-box" type="tel" inputmode="numeric" pattern="[0-9]"
               maxlength="1"
               aria-label="Chiffre 2 du code" id="otp-1" data-index="1"/>
        <input class="otp-box" type="tel" inputmode="numeric" pattern="[0-9]"
               maxlength="1"
               aria-label="Chiffre 3 du code" id="otp-2" data-index="2"/>
        <input class="otp-box" type="tel" inputmode="numeric" pattern="[0-9]"
               maxlength="1"
               aria-label="Chiffre 4 du code" id="otp-3" data-index="3"/>
        <input class="otp-box" type="tel" inputmode="numeric" pattern="[0-9]"
               maxlength="1"
               aria-label="Chiffre 5 du code" id="otp-4" data-index="4"/>
        <input class="otp-box" type="tel" inputmode="numeric" pattern="[0-9]"
               maxlength="1"
               aria-label="Chiffre 6 du code" id="otp-5" data-index="5"/>
      </div>
      <!-- Error message -->
      <div class="otp-error" id="otp-error" role="alert" aria-live="assertive" hidden>
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
          <circle cx="7" cy="7" r="6.5" stroke="currentColor"/>
          <path d="M7 4V7.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          <circle cx="7" cy="10" r=".7" fill="currentColor"/>
        </svg>
        <span id="otp-error-msg">Code incorrect. Veuillez réessayer.</span>
      </div>
    </fieldset>

    <!-- CTA -->
    <button class="btn btn-primary otp-cta" id="otp-submit" disabled aria-disabled="true">
      <span class="otp-cta-label">Vérifier le code</span>
      <span class="otp-loader" aria-hidden="true" hidden>
        <span class="otp-spinner"></span>
        Vérification…
      </span>
    </button>

    <!-- Resend row -->
    <div class="otp-resend-row">
      <span class="otp-resend-hint t-body-sm">Pas reçu le code ?</span>
      <button class="otp-resend-btn" id="otp-resend" disabled aria-disabled="true"
              aria-describedby="otp-timer-sr">
        <span id="otp-resend-label">Renvoyer dans <strong id="otp-countdown">30</strong>s</span>
      </button>
      <span id="otp-timer-sr" class="sr-only" aria-live="polite" aria-atomic="true"></span>
    </div>

    <!-- Change number -->
    <button class="otp-change-num" id="otp-change-number">
      Modifier le numéro
    </button>

  </div><!-- /otp-body -->

  <!-- ── Success overlay ── -->
  <div class="otp-success" id="otp-success" hidden aria-live="polite">
    <div class="otp-success-card">
      <div class="otp-success-badge" aria-hidden="true">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
          <path d="M7 16.5L13 22.5L25 10" stroke="currentColor"
                stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h2 class="otp-success-title t-h1">Identité<br>confirmée</h2>
      <p class="otp-success-sub t-body">Bienvenue sur Babloo !</p>
    </div>
  </div>

</div><!-- /screen-otp -->



<!-- ══════════════════════════════════════════════════════════
     BABLOO AUTH SYSTEM — 6 screens
     ══════════════════════════════════════════════════════════ -->

<!-- ══ AUTH ENTRY ══ -->
<div class="screen active" id="screen-auth" role="main" aria-label="Bienvenue sur Babloo">
  <div class="auth-hero">
    <div class="auth-hero-blob auth-hero-blob--1"></div>
    <div class="auth-hero-blob auth-hero-blob--2"></div>
    <div class="auth-logo-wrap">
      <div class="auth-logo-mark" id="auth-hero-logo"></div>
      <span class="auth-wordmark">Babloo</span>
    </div>
    <p class="auth-tagline">Des artisans de confiance,<br>à portée de main.</p>
  </div>
  <div class="auth-card">
    <div class="auth-tabs" role="tablist" aria-label="Mode d'authentification">
      <button class="auth-tab active" id="tab-signin" role="tab" aria-selected="true" data-mode="signin">Se connecter</button>
      <button class="auth-tab" id="tab-signup" role="tab" aria-selected="false" data-mode="signup">Créer un compte</button>
      <div class="auth-tab-indicator" id="auth-tab-indicator" aria-hidden="true"></div>
    </div>
    <div class="auth-sso" role="group">
      <button class="auth-btn-sso auth-btn-google" id="auth-google-btn" data-provider="google" aria-label="Continuer avec Google">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true" style="flex-shrink:0">
          <path d="M17.64 9.2a10.34 10.34 0 0 0-.164-1.84H9v3.48h4.844a4.14 4.14 0 0 1-1.796 2.716v2.258h2.908C16.658 14.252 17.64 11.927 17.64 9.2z" fill="#4285F4"/>
          <path d="M9 18c2.43 0 4.467-.806 5.956-2.18L12.048 13.56C11.243 14.1 10.212 14.42 9 14.42c-2.344 0-4.328-1.584-5.036-3.712H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/>
          <path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A9.004 9.004 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
          <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 6.29C4.672 4.162 6.656 3.58 9 3.58z" fill="#EA4335"/>
        </svg>
        <span class="auth-sso-label">Continuer avec Google</span>
      </button>
      <button class="auth-btn-sso auth-btn-apple" id="auth-apple-btn" data-provider="apple" aria-label="Continuer avec Apple">
        <svg width="16" height="19" viewBox="0 0 16 19" fill="none" aria-hidden="true" style="flex-shrink:0">
          <path d="M13.173 10.04c-.02-2.44 2-3.62 2.082-3.674-1.135-1.657-2.9-1.885-3.526-1.909-1.5-.152-2.928.883-3.686.883-.758 0-1.927-.858-3.17-.834C3.1 4.525 1.62 5.46.762 6.9c-1.754 3.03-.45 7.522 1.254 9.985.834 1.2 1.826 2.547 3.128 2.498 1.256-.05 1.73-.808 3.25-.808s1.942.808 3.275.783c1.353-.023 2.212-1.224 3.038-2.428.95-1.39 1.346-2.737 1.37-2.808-.03-.013-2.623-1.006-2.647-3.998l-.257.916zM10.784 2.75C11.45 1.91 11.908.77 11.783-.4c-.973.042-2.134.648-2.826 1.468-.62.72-1.167 1.87-1.02 2.974 1.08.084 2.18-.55 2.847-1.313z" fill="currentColor"/>
        </svg>
        <span class="auth-sso-label">Continuer avec Apple</span>
      </button>
    </div>
    <div class="auth-divider" aria-hidden="true">
      <span class="auth-divider-line"></span>
      <span class="auth-divider-label">ou</span>
      <span class="auth-divider-line"></span>
    </div>
    <div class="auth-methods">
      <button class="auth-btn-method" id="auth-email-btn">
        <span class="auth-method-icon" aria-hidden="true"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></span>
        <span class="auth-method-label">Continuer avec l'e-mail</span>
        <svg class="auth-method-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" aria-hidden="true"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
      <button class="auth-btn-method" id="auth-phone-btn">
        <span class="auth-method-icon" aria-hidden="true"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></span>
        <span class="auth-method-label">Continuer avec le téléphone</span>
        <svg class="auth-method-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" aria-hidden="true"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>
    <p class="auth-legal" id="auth-legal" hidden>
      En créant un compte, vous acceptez nos
      <button class="auth-legal-link" type="button">Conditions d'utilisation</button>
      et notre <button class="auth-legal-link" type="button">Politique de confidentialité</button>.
    </p>
  </div>
</div>

<!-- ══ SIGN-IN EMAIL ══ -->
<div class="screen" id="screen-signin-email" role="main" aria-label="Connexion par e-mail">
  <header class="auth-sub-header">
    <button class="auth-back-btn" data-goto="screen-auth" aria-label="Retour"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="auth-sub-title-sm">Se connecter</span>
    <span style="width:34px"></span>
  </header>
  <div class="scroll" style="padding-bottom:40px">
    <div class="auth-sub-body">
      <div class="auth-sub-intro">
        <h1 class="auth-display-title">Bon retour<span class="auth-clay-dot">.</span></h1>
        <p class="t-body">Connectez-vous avec votre e-mail</p>
      </div>
      <div class="auth-field-group">
        <div class="auth-field">
          <label class="auth-label" for="sie-email">Adresse e-mail</label>
          <input class="input-f auth-input" type="email" id="sie-email" placeholder="votre@email.com" autocomplete="email" inputmode="email" aria-required="true"/>
          <span class="auth-field-err" id="sie-email-err" role="alert" hidden></span>
        </div>
        <div class="auth-field">
          <div class="auth-label-row">
            <label class="auth-label" for="sie-password">Mot de passe</label>
            <button type="button" class="auth-link-sm" id="sie-forgot-link" onclick="openForgotPassword('screen-signin-email')">Mot de passe oublié ?</button>
          </div>
          <div class="auth-input-wrap">
            <input class="input-f auth-input" type="password" id="sie-password" placeholder="••••••••" autocomplete="current-password" aria-required="true"/>
            <button type="button" class="auth-eye-btn" data-target="sie-password" aria-label="Afficher"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          </div>
          <span class="auth-field-err" id="sie-pass-err" role="alert" hidden></span>
        </div>
      </div>
      <div class="auth-alert auth-alert--error" id="sie-global-err" hidden role="alert">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="sie-global-err-msg">E-mail ou mot de passe incorrect.</span>
      </div>
      <button class="btn btn-primary auth-cta" id="sie-submit">
        <span class="auth-cta-label">Se connecter</span>
        <span class="auth-cta-loader" hidden><span class="auth-spinner"></span>Connexion…</span>
      </button>
    </div>
  </div>
</div>

<!-- ══ SIGN-IN PHONE ══ -->
<div class="screen" id="screen-signin-phone" role="main" aria-label="Connexion par téléphone">
  <header class="auth-sub-header">
    <button class="auth-back-btn" data-goto="screen-auth" aria-label="Retour"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="auth-sub-title-sm">Se connecter</span>
    <span style="width:34px"></span>
  </header>
  <div class="scroll" style="padding-bottom:40px">
    <div class="auth-sub-body">
      <div class="auth-sub-intro">
        <h1 class="auth-display-title">Bon retour<span class="auth-clay-dot">.</span></h1>
        <p class="t-body">Connectez-vous avec votre numéro</p>
      </div>
      <div class="auth-field-group">
        <div class="auth-field">
          <label class="auth-label" for="sip-phone">Numéro de téléphone</label>
          <div class="auth-phone-row">
            <button type="button" class="auth-dial-pill">🇲🇦 +212</button>
            <input class="input-f auth-input auth-phone-input" type="tel" id="sip-phone" placeholder="06 00 00 00 00" autocomplete="tel-national" inputmode="tel" aria-required="true"/>
          </div>
          <span class="auth-field-err" id="sip-phone-err" role="alert" hidden></span>
        </div>
      </div>
      <div class="auth-alert auth-alert--error" id="sip-global-err" hidden role="alert">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span>Aucun compte associé à ce numéro.</span>
      </div>
      <button class="btn btn-primary auth-cta" id="sip-submit">
        <span class="auth-cta-label">Continuer</span>
        <span class="auth-cta-loader" hidden><span class="auth-spinner"></span>Vérification…</span>
      </button>
    </div>
  </div>
</div>

<!-- ══ SIGN-IN PASSWORD (phone step 2) ══ -->
<div class="screen" id="screen-signin-pass" role="main" aria-label="Saisie du mot de passe">
  <header class="auth-sub-header">
    <button class="auth-back-btn" data-goto="screen-signin-phone" aria-label="Retour"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="auth-sub-title-sm">Se connecter</span>
    <span style="width:34px"></span>
  </header>
  <div class="scroll" style="padding-bottom:40px">
    <div class="auth-sub-body">
      <div class="auth-sub-intro">
        <h1 class="auth-display-title">Votre mot<br>de passe<span class="auth-clay-dot">.</span></h1>
        <p class="t-body">Pour le numéro <strong id="sipw-phone-display" class="auth-phone-badge"></strong></p>
      </div>
      <div class="auth-field-group">
        <div class="auth-field">
          <label class="auth-label" for="sipw-password">Mot de passe</label>
          <div class="auth-input-wrap">
            <input class="input-f auth-input" type="password" id="sipw-password" placeholder="••••••••" autocomplete="current-password" aria-required="true"/>
            <button type="button" class="auth-eye-btn" data-target="sipw-password" aria-label="Afficher"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          </div>
          <span class="auth-field-err" id="sipw-pass-err" role="alert" hidden></span>
        </div>
      </div>
      <div class="auth-alert auth-alert--error" id="sipw-global-err" hidden role="alert">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="sipw-global-err-msg">Mot de passe incorrect. Réessayez.</span>
      </div>
      <button class="btn btn-primary auth-cta" id="sipw-submit">
        <span class="auth-cta-label">Se connecter</span>
        <span class="auth-cta-loader" hidden><span class="auth-spinner"></span>Connexion…</span>
      </button>
      <button type="button" class="auth-link-centered" onclick="openForgotPassword('screen-signin-phone')">Mot de passe oublié ?</button>
    </div>
  </div>
</div>

<!-- ══ SIGN-UP EMAIL (step 1/2) ══ -->
<div class="screen" id="screen-signup-email" role="main" aria-label="Création de compte">
  <header class="auth-sub-header">
    <button class="auth-back-btn" data-goto="screen-auth" aria-label="Retour"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="auth-sub-title-sm">Créer un compte</span>
    <span style="width:34px"></span>
  </header>
  <div class="auth-progress-bar-wrap" aria-label="Étape 1 sur 2">
    <div class="auth-progress-track"><div class="auth-progress-fill" style="width:50%"></div></div>
    <span class="auth-progress-label">Étape 1 / 2</span>
  </div>
  <div class="scroll" style="padding-bottom:40px">
    <div class="auth-sub-body">
      <div class="auth-sub-intro">
        <h1 class="auth-display-title">Créer un<br>compte<span class="auth-clay-dot">.</span></h1>
        <p class="t-body">Commençons avec votre e-mail</p>
      </div>
      <div class="auth-field-group">
        <div class="auth-field">
          <label class="auth-label" for="sue-email">Adresse e-mail</label>
          <input class="input-f auth-input" type="email" id="sue-email" placeholder="votre@email.com" autocomplete="email" inputmode="email" aria-required="true"/>
          <span class="auth-field-err" id="sue-email-err" role="alert" hidden></span>
        </div>
        <div class="auth-field">
          <label class="auth-label" for="sue-password">Créer un mot de passe</label>
          <div class="auth-input-wrap">
            <input class="input-f auth-input" type="password" id="sue-password" placeholder="••••••••" autocomplete="new-password" aria-required="true"/>
            <button type="button" class="auth-eye-btn" data-target="sue-password" aria-label="Afficher"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          </div>
          <span class="auth-field-hint">8 caractères minimum</span>
          <span class="auth-field-err" id="sue-pass-err" role="alert" hidden></span>
        </div>
        <div class="auth-field">
          <label class="auth-label" for="sue-confirm">Confirmer le mot de passe</label>
          <div class="auth-input-wrap">
            <input class="input-f auth-input" type="password" id="sue-confirm" placeholder="••••••••" autocomplete="new-password" aria-required="true"/>
            <button type="button" class="auth-eye-btn" data-target="sue-confirm" aria-label="Afficher"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          </div>
          <span class="auth-field-err" id="sue-confirm-err" role="alert" hidden></span>
        </div>
      </div>
      <div class="auth-alert auth-alert--error" id="sue-global-err" hidden role="alert">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="sue-global-err-msg">Cet e-mail est déjà utilisé.</span>
      </div>
      <button class="btn btn-primary auth-cta" id="sue-submit">
        <span class="auth-cta-label">Continuer</span>
        <span class="auth-cta-loader" hidden><span class="auth-spinner"></span>Vérification…</span>
      </button>
    </div>
  </div>
</div>

<!-- ══ SIGN-UP PHONE (step 2/2 → OTP) ══ -->
<div class="screen" id="screen-signup-phone" role="main" aria-label="Vérification par téléphone">
  <header class="auth-sub-header">
    <button class="auth-back-btn" id="sup-back-btn" aria-label="Retour"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="auth-sub-title-sm">Créer un compte</span>
    <span style="width:34px"></span>
  </header>
  <div class="auth-progress-bar-wrap" aria-label="Étape 2 sur 2">
    <div class="auth-progress-track"><div class="auth-progress-fill" style="width:100%"></div></div>
    <span class="auth-progress-label">Étape 2 / 2</span>
  </div>
  <div class="scroll" style="padding-bottom:40px">
    <div class="auth-sub-body">
      <div class="auth-sub-intro">
        <h1 class="auth-display-title">Votre<br>numéro<span class="auth-clay-dot">.</span></h1>
        <p class="t-body" id="sup-subtitle">Ajoutez votre numéro pour sécuriser votre compte</p>
      </div>
      <div class="auth-field-group">
        <div class="auth-field">
          <label class="auth-label" for="sup-phone">Numéro de téléphone</label>
          <div class="auth-phone-row">
            <button type="button" class="auth-dial-pill">🇲🇦 +212</button>
            <input class="input-f auth-input auth-phone-input" type="tel" id="sup-phone" placeholder="06 00 00 00 00" autocomplete="tel-national" inputmode="tel" aria-required="true"/>
          </div>
          <span class="auth-field-err" id="sup-phone-err" role="alert" hidden></span>
        </div>
      </div>
      <div class="auth-alert auth-alert--info" id="sup-existing-hint" hidden>
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        <span>Ce numéro est déjà utilisé. <button type="button" class="auth-alert-link" id="sup-switch-signin">Se connecter ?</button></span>
      </div>
      <button class="btn btn-primary auth-cta" id="sup-submit">
        <span class="auth-cta-label">Recevoir le code</span>
        <span class="auth-cta-loader" hidden><span class="auth-spinner"></span>Envoi…</span>
      </button>
    </div>
  </div>
</div>
<!-- ══ END AUTH SCREENS ══ -->

</div><!-- end screens -->
</div><!-- end phone -->

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sb-sec">Auth</div>
  <button class="sb-btn" onclick="window.goto('screen-auth')">⟶ Écran d'accueil</button>
  <button class="sb-btn" onclick="window.goto('screen-signin-email')">Connexion e-mail</button>
  <button class="sb-btn" onclick="window.goto('screen-signin-phone')">Connexion téléphone</button>
  <button class="sb-btn" onclick="window.goto('screen-signup-email')">Inscription e-mail</button>
  <button class="sb-btn" onclick="window.goto('screen-signup-phone')">Inscription téléphone</button>
  <div class="sb-sec">Accueil</div>
  <button class="sb-btn active" onclick="gotoV3('s-home')">Accueil</button>
  <div class="sb-sec">Booking</div>
  <button class="sb-btn" onclick="S.svc='maid';goto('s-booking-maid')">Ménage · Filtres</button>
  <button class="sb-btn" onclick="S.svc='cuisine';goto('s-booking-cuisine')">Cuisine</button>
  <button class="sb-btn" onclick="S.svc='childcare';goto('s-booking-childcare')">Garde d'enfants</button>
  <button class="sb-btn" onclick="gotoV3('s-confirm')">Récapitulatif</button>
  <button class="sb-btn" onclick="gotoV3('s-search')">Recherche</button>
  <button class="sb-btn" onclick="gotoV3('s-status')">Suivi commande</button>
  <div class="sb-sec">Post-prestation</div>
  <button class="sb-btn" onclick="gotoV3('s-rating')">Notation</button>
  <div class="sb-sec">Fidélisation <span class="sb-new">NEW</span></div>
  <button class="sb-btn" onclick="openSquadReview()">Sélection Squad</button>
  <button class="sb-btn" onclick="gotoV3('s-fid-configure')">Config par personne</button>
  <button class="sb-btn" onclick="openTeamCalendar('s-fid-dashboard')">Calendrier partagé</button>
  <button class="sb-btn" onclick="gotoV3('s-fid-contract')">Contrat</button>
  <button class="sb-btn" onclick="gotoV3('s-fid-dashboard')">Dashboard Fidèles</button>
  <div class="sb-sec">Autre</div>
  <button class="sb-btn" onclick="gotoV3('s-orders')">Mes commandes</button>
  <button class="sb-btn" onclick="openModal('modal-location')">Sélecteur localisation</button>
  <button class="sb-btn" onclick="openModal('modal-slot')">Modal créneau</button>
</div>

<script>
let cur = 'screen-auth'; /* Auth flow: entry point changed from s-home */

function goto(id) {
  const from = document.getElementById(cur);
  const to = document.getElementById(id);
  if (!to || cur === id) return;
  if (from) { from.classList.remove('active'); from.style.transform = 'translateX(-18px)'; setTimeout(() => { if (from) from.style.transform = ''; }, 300); }
  to.classList.add('active');
  cur = id;
  document.querySelectorAll('.sb-btn').forEach(b => { b.classList.toggle('active', b.getAttribute('onclick') && b.getAttribute('onclick').includes(id)); });
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// (Dead code removed — all functions below are overridden by v3 engine via window.x assignments)

// Toast
let toastT;
function showToast(msg) {
  const ex = document.querySelector('.toast');
  if (ex) ex.remove();
  clearTimeout(toastT);
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.getElementById('app').appendChild(t);
  toastT = setTimeout(() => t.remove(), 2600);
}

// Init sidebar active
document.querySelector('.sb-btn').classList.add('active');



// ════════════════════════════════════════════════════════════
//  BABLOO v3 — FULL DYNAMIC ENGINE
//  Context-aware rendering · Real pricing · State-driven UI
// ════════════════════════════════════════════════════════════

// ─── Inject SVG logos
setTimeout(()=>{
  // Logo injection already handled by injectLogos()
},50);

// ─── State
const S={
  svc:'maid',
  loc:'Agdal, Rabat',
  activeOrderDraftId:null,
  maid:{type:'simple',surface:80,team:'duo',notes:''},
  cuisine:{dishes:'',guests:6,notes:''},
  childcare:{children:2,hours:3,notes:''},
  fid:{
    curPro:'a',
    offers:[
      {
        id:'F-ACTIVE-A',
        key:'a',
        name:'Fatima Zahra',
        init:'FZ',
        av:'av-a',
        role:'Coordinatrice',
        price:850,
        hours:28,
        skills:['Ménage & entretien','Préparation culinaire'],
        status:'active',
        statusLabel:'Contrat actif',
        doneHours:18,
        remainingHours:10,
        nextCount:3,
        nextSlot:'Lundi 10h–13h',
        createdAt:new Date().toISOString()
      }
    ],
    members:{
      a:{sel:true,name:'Fatima Zahra',role:'Coordinatrice',rating:'4.9',cnt:47,
         skills:{menage:true,cuisine:true,garde:false,repassage:false},hours:28,price:0,
         slots:{morning:true,afternoon:false,flexible:false,recurring:true},
         av:'av-a',init:'FZ',rel:96},
      b:{sel:true,name:'Khadija Benali',role:'Spécialiste sol',rating:'4.7',cnt:31,
         skills:{menage:true,cuisine:false,garde:false,repassage:true},hours:20,price:0,
         slots:{morning:true,afternoon:false,flexible:false,recurring:false},
         av:'av-b',init:'KB',rel:91},
      c:{sel:false,name:'Samira Alaoui',role:'Polyvalente',rating:'4.4',cnt:18,
         skills:{menage:true,cuisine:false,garde:true,repassage:false},hours:0,price:0,
         slots:{morning:false,afternoon:true,flexible:true,recurring:false},
         av:'av-c',init:'SA',rel:83}
    },
    defs:{
      menage:{label:'Ménage & entretien',base:400,minH:20},
      cuisine:{label:'Préparation culinaire',base:250,minH:8},
      garde:{label:"Garde d'enfants",base:300,minH:12},
      repassage:{label:'Repassage',base:150,minH:6}
    }
  },
  chatMsgs:[],rating:4,selectedPro:'a'
};

// ─── Pricing
const P={
  maid(surf,team,type){
    const rows=[[40,{solo:80,duo:0,squad:0}],[70,{solo:100,duo:140,squad:0}],
      [110,{solo:130,duo:170,squad:0}],[160,{solo:170,duo:210,squad:270}],
      [220,{solo:210,duo:260,squad:320}],[999,{solo:260,duo:320,squad:400}]];
    const r=rows.find(([m])=>surf<=m)||rows[rows.length-1];
    let p=r[1][team]||r[1].solo;
    return type==='deep'?Math.round(p*1.35):p;
  },
  dur(surf,team){
    let h;
    if(surf<=50)h=[1.5,2.5];else if(surf<=90)h=[2.5,3.5];
    else if(surf<=140)h=[3,4.5];else if(surf<=200)h=[4,6];else h=[5,7];
    const f=team==='duo'?0.65:team==='squad'?0.5:1;
    return h.map(x=>+(x*f).toFixed(1)).join('–')+'h';
  },
  cuisine(g){
    if(g<=4)return 100;if(g<=7)return 130;if(g<=10)return 165;
    return 165+Math.ceil((g-10)/3)*25;
  },
  childcare(c,h){return c*80+c*Math.max(0,h-2)*25;},
  fid(m){
    let t=0;
    Object.entries(m.skills).filter(([,v])=>v).forEach(([sk])=>{t+=S.fid.defs[sk]?.base||0;});
    if(m.hours>20)t+=Math.floor((m.hours-20)*8);
    return Math.max(t,300);
  },
  min(){
    if(S.svc==='maid')return P.maid(S.maid.surface,S.maid.team,S.maid.type);
    if(S.svc==='cuisine')return P.cuisine(S.cuisine.guests);
    return P.childcare(S.childcare.children,S.childcare.hours);
  }
};

const calcFid=()=>Object.values(S.fid.members).forEach(m=>m.price=P.fid(m));
calcFid();

// ─── Helpers
const cap=s=>s[0].toUpperCase()+s.slice(1);
const $=id=>document.getElementById(id);
const set=(id,v)=>{const e=$(id);if(e)e.textContent=v;};
const setH=(id,v)=>{const e=$(id);if(e)e.innerHTML=v;};
const ic=(svg)=>`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">${svg}</svg>`;
const checkSVG=ic('<polyline points="20 6 9 17 4 12"/>');
const avBg={a:'linear-gradient(135deg,#6C63FF,#A080FF)',b:'linear-gradient(135deg,#E8517A,#F07AB0)',c:'linear-gradient(135deg,#00A89C,#00D4C8)'};

// ─── Navigation override
const _origGoto = typeof goto !== 'undefined' ? goto : null;
const gotoV3=(id)=>{
  // Fire original first
  if(_origGoto)_origGoto(id);
  // Update nav bar active states
  updateNavBar(id);
  // Update status bar (dark only on auth entry)
  const statusBar=document.getElementById('status-bar');
  if(statusBar) statusBar.classList.toggle('dark', id==='screen-auth');
  // Dynamic renders
  const renders={
    's-home':renderHomeTrackingBanner,
    's-booking-maid':renderMaidStep,
    's-confirm':renderConfirm,
    's-order-confirmed':renderOrderConfirmed,
    's-search':renderSearch,
    's-status':renderStatus,
    's-rating':renderRating,
    's-booking-cuisine':renderCuisineStep,
    's-booking-childcare':renderChildcareStep,
    's-squad-review':renderSquad,
    's-fid-dashboard':renderFidDashboard,
    's-fid-configure':()=>{if(!fidConfigQueue.length)buildFidQueue();renderFidCfg();},
    's-fid-calendar':renderCal,
    's-fid-contract':renderContract,
    's-chat':renderChat,
    's-orders':renderOrders
  };
  if(id==='s-status' && statusPhase<4 && !statusAutoRunning){
    startStatusSimulation(false);
  }
  setTimeout(()=>{if(renders[id])renders[id]();},50);
};
// Override goto globally
window.goto=gotoV3;

// ─── Nav bar active state management
const navMap={
  's-home':'Accueil','s-booking-maid':'Accueil','s-booking-cuisine':'Accueil','s-booking-childcare':'Accueil',
  's-confirm':'Accueil','s-search':'Accueil','s-order-confirmed':'Accueil','s-status':'Accueil','s-chat':'Accueil','s-rating':'Accueil',
  's-orders':'Commandes','s-order-detail':'Commandes',
  's-fid-dashboard':'Fidèles','s-fid-configure':'Fidèles','s-fid-calendar':'Fidèles',
  's-fid-contract':'Fidèles','s-squad-review':'Fidèles'
};
function updateNavBar(screenId){
  const activeTab=navMap[screenId];
  if(!activeTab)return;
  document.querySelectorAll('.nav-bar').forEach(bar=>{
    bar.querySelectorAll('.nav-item').forEach(item=>{
      const lbl=item.querySelector('.nav-lbl');
      if(lbl) item.classList.toggle('active',lbl.textContent===activeTab);
    });
  });
  updateOrdersBadge();
}
function updateOrdersBadge(){
  const activeCount=typeof ordersData!=='undefined'?ordersData.filter(o=>o.status==='en_cours').length:0;
  document.querySelectorAll('.nav-badge').forEach(badge=>{
    const parent=badge.closest('.nav-item');
    if(parent && parent.querySelector('.nav-lbl')?.textContent==='Commandes'){
      badge.textContent=activeCount;
      badge.style.display=activeCount>0?'':'none';
    }
  });
}

// ─── Fix back button in confirm to be context-aware
function goBk(){
  if(S.svc==='maid')gotoV3('s-booking-maid');
  else if(S.svc==='cuisine')gotoV3('s-booking-cuisine');
  else gotoV3('s-booking-childcare');
}

let squadBackScreen='s-rating';
window.openSquadReview=function(fromId){
  squadBackScreen=fromId||document.querySelector('.screen.active')?.id||'s-rating';
  gotoV3('s-squad-review');
};
window.backFromSquad=function(){
  gotoV3(squadBackScreen||'s-rating');
};

// ─── Surface/team updater (patching existing functions)
window.updateSurface=function(v){
  S.maid.surface=parseInt(v);
  if(S.maid.surface<=60)S.maid.team='solo';
  else if(S.maid.surface<=160)S.maid.team='duo';
  else S.maid.team='squad';
  const d=$('surface-val');if(d)d.textContent=v;
  const c=$('rec-team-chip');if(c)c.textContent=teamRec(S.maid.surface);
  patchMaidPrice();
  ['solo','duo','squad'].forEach(t=>{
    const e=$('team-'+t);if(e)e.classList.toggle('sel',t===S.maid.team);
  });
};

window.selTeam=function(t){
  S.maid.team=t;
  ['solo','duo','squad'].forEach(tt=>{
    const e=$('team-'+tt);if(!e)return;
    e.classList.toggle('sel',tt===t);
  });
  patchMaidPrice();
};

window.toggleBkType=function(el,myId,otherId){
  S.maid.type=myId==='type-simple'?'simple':'deep';
  $(myId)?.classList.add('sel');
  $(otherId)?.classList.remove('sel');
  patchMaidPrice();
};

function teamRec(s){
  if(s<=60)return'Solo recommandé';if(s<=160)return'Duo recommandé';return'Squad recommandé';
}

function patchMaidPrice(){
  const p=P.maid(S.maid.surface,S.maid.team,S.maid.type);
  const d=P.dur(S.maid.surface,S.maid.team);
  const pe=$('price-estimate');if(pe)pe.textContent=p+' MAD';
  const de=$('duration-estimate');if(de)de.textContent=d;
}

function renderMaidStep(){
  const surfaceInput=document.querySelector('#s-booking-maid input[type=range]');
  if(surfaceInput)surfaceInput.value=S.maid.surface;
  const notes=$('maid-notes');if(notes)notes.value=S.maid.notes||'';
  $('type-simple')?.classList.toggle('sel',S.maid.type==='simple');
  $('type-deep')?.classList.toggle('sel',S.maid.type==='deep');
  const d=$('surface-val');if(d)d.textContent=S.maid.surface;
  const c=$('rec-team-chip');if(c)c.textContent=teamRec(S.maid.surface);
  ['solo','duo','squad'].forEach(t=>{
    const e=$('team-'+t);if(e)e.classList.toggle('sel',t===S.maid.team);
  });
  patchMaidPrice();
}

function renderCuisineStep(){
  set('guests-val',S.cuisine.guests);
  const dish=$('cuisine-dishes');if(dish)dish.value=S.cuisine.dishes||'';
  const p=P.cuisine(S.cuisine.guests);
  const min=$('cuisine-price-min');if(min)min.textContent=p+' MAD';
  const hero=$('cuisine-price-hero');if(hero)hero.textContent=p+' MAD';
  const note=$('cuisine-note');if(note)note.textContent=`Pour ${S.cuisine.guests} personne${S.cuisine.guests>1?'s':''} · hors ingrédients · prix final négocié`;
}

function renderChildcareStep(){
  set('children-val',S.childcare.children);
  set('hours-val',S.childcare.hours);
  const notes=$('childcare-notes');if(notes)notes.value=S.childcare.notes||'';
  const p=P.childcare(S.childcare.children,S.childcare.hours);
  const top=$('childcare-price');if(top)top.textContent=p+' MAD';
  const hero=$('childcare-price-hero');if(hero)hero.textContent=p+' MAD';
  const note=$('childcare-note');if(note)note.textContent=`${S.childcare.children} enfant${S.childcare.children>1?'s':''} · ${S.childcare.hours}h · prix final négocié`;
}

// Cuisine stepper
window.stepChange=function(key,d){
  if(key==='guests'){
    S.cuisine.guests=Math.max(1,Math.min(20,S.cuisine.guests+d));
    set('guests-val',S.cuisine.guests);
    const p=P.cuisine(S.cuisine.guests);
    const min=$('cuisine-price-min');if(min)min.textContent=p+' MAD';
    const hero=$('cuisine-price-hero');if(hero)hero.textContent=p+' MAD';
    const note=$('cuisine-note');if(note)note.textContent=`Pour ${S.cuisine.guests} personne${S.cuisine.guests>1?'s':''} · hors ingrédients · prix final négocié`;
  } else if(key==='children'){
    S.childcare.children=Math.max(1,Math.min(6,S.childcare.children+d));
    set('children-val',S.childcare.children);
  } else if(key==='hours'){
    S.childcare.hours=Math.max(1,Math.min(12,S.childcare.hours+d));
    set('hours-val',S.childcare.hours);
  }
  if(key!=='guests'){
    const p=P.childcare(S.childcare.children,S.childcare.hours);
    const top=$('childcare-price');if(top)top.textContent=p+' MAD';
    const hero=$('childcare-price-hero');if(hero)hero.textContent=p+' MAD';
    const note=$('childcare-note');if(note)note.textContent=`${S.childcare.children} enfant${S.childcare.children>1?'s':''} · ${S.childcare.hours}h · prix final négocié`;
  }
};

// ════════════════════════
//  CONFIRM RENDERER
// ════════════════════════
function renderConfirm(){
  const el=$('dyn-confirm');if(!el)return;
  const s=S.svc,price=P.min();
  let title,sub,details,note='Aucun prépaiement requis';
  if(s==='maid'){
    title=`Ménage · ${cap(S.maid.team)}`;
    sub=`${S.maid.type==='simple'?'Ménage simple':'Ménage profond'} · ${S.maid.surface} m²`;
    const tc={solo:'1 personne',duo:'2 personnes',squad:'3+ personnes'}[S.maid.team];
    details=row('Type',S.maid.type==='simple'?'Ménage simple':'Ménage profond')+
      row('Superficie',S.maid.surface+' m²')+row('Équipe',tc)+
      row('Durée estimée',P.dur(S.maid.surface,S.maid.team));
    note='Aucun prépaiement · Offre 1er service active';
  } else if(s==='cuisine'){
    title='Cuisine · Solo';sub=`${S.cuisine.guests} convives`;
    details=row('Convives',S.cuisine.guests+' personnes')+
      (S.cuisine.dishes?row('Plats',S.cuisine.dishes.slice(0,35)+'…'):'')+'<div style="background:#FFF4DC;border-radius:8px;padding:8px 10px;font-size:11px;color:#9A5D00;font-weight:600;margin-top:6px">Ingrédients à prévoir par vos soins</div>';
  } else {
    title="Garde d'enfants · Solo";
    sub=`${S.childcare.children} enfant${S.childcare.children>1?'s':''} · ${S.childcare.hours}h`;
    details=row('Enfants',''+S.childcare.children)+row('Durée',S.childcare.hours+'h');
  }
  el.innerHTML=`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
        <div><div class="t-label" style="margin-bottom:4px">Service commandé</div>
        <div class="t-h2">${title}</div>
        <div style="font-size:12px;color:var(--text-sec);margin-top:2px">${sub}</div></div>
        ${s==='maid'?'<span class="chip chip-clay">1ère commande</span>':''}
      </div>
      <div style="border-top:1px solid var(--border);padding-top:14px;display:flex;flex-direction:column;gap:0">
        ${details}
        ${row('Adresse',S.loc)}
        ${row('Paiement','Espèces à la porte')}
      </div>
    </div>
    <div style="background:var(--navy);border-radius:20px;padding:18px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,.42);margin-bottom:5px">Plancher minimum</div>
        <div style="font-family:'Fraunces',serif;font-size:28px;font-weight:700;color:#fff">${price} MAD</div>
        <div style="font-size:11px;color:rgba(255,255,255,.45);margin-top:2px">Prix final négocié via le chat</div>
      </div>
      <div style="opacity:.35"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><div style="font-size:9px;color:rgba(255,255,255,.5);text-align:center;margin-top:3px">Négociation</div></div>
    </div>
    <div style="background:var(--bg-alt);border-radius:20px;padding:16px">
      <div class="t-h3" style="margin-bottom:12px">Ce qui se passe ensuite</div>
      ${[[1,'Babloo assigne des professionnelles disponibles dans votre quartier'],
         [2,'Vous négociez le prix final via le chat (au-dessus du plancher)'],
         [3,'La professionnelle arrive — vous payez en espèces à la porte'],
         [4,'Notez la prestation pour aider la communauté']].map(([n,t])=>
        `<div style="display:flex;gap:11px;align-items:flex-start;margin-bottom:10px">
           <div style="width:24px;height:24px;border-radius:50%;background:var(--navy);display:flex;align-items:center;justify-content:center;flex-shrink:0">
             <span style="font-size:10px;font-weight:700;color:#fff">${n}</span></div>
           <span style="font-size:12px;line-height:1.55;color:var(--text-sec)">${t}</span></div>`).join('')}
    </div>`;
}
function row(l,v){
  return`<div style="display:flex;justify-content:space-between;margin-bottom:9px">
    <span style="font-size:13px;color:var(--text-sec)">${l}</span>
    <span style="font-size:13px;font-weight:600;color:var(--navy);max-width:200px;text-align:right">${v}</span></div>`;
}

function genOrderId(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let out='ORD-';
  for(let i=0;i<5;i++)out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}

function getCurrentFlowTeam(){
  const key=S.selectedPro||'a';
  const p=S.fid.members[key];
  if(!p)return [];
  return [{name:p.name,role:p.role,rating:p.rating,cnt:p.cnt,init:p.init,av:p.av,tasks:'Prestation selon votre demande'}];
}

function getCurrentFlowDetail(){
  if(S.svc==='maid'){
    return {
      label:`Ménage · ${cap(S.maid.team)}`,
      detail:`Ménage ${S.maid.type==='simple'?'simple':'profond'} · ${S.maid.surface}m²`,
      dur:P.dur(S.maid.surface,S.maid.team)
    };
  }
  if(S.svc==='cuisine'){
    return {
      label:'Cuisine · Solo',
      detail:`${S.cuisine.guests} convives`,
      dur:'3h00'
    };
  }
  return {
    label:'Baby-sitting · Solo',
    detail:`${S.childcare.children} enfant${S.childcare.children>1?'s':''} · ${S.childcare.hours}h`,
    dur:`${S.childcare.hours}h00`
  };
}

function ensureCurrentOrderDraft(){
  if(typeof ordersData==='undefined')return null;
  if(S.activeOrderDraftId){
    const existing=ordersData.find(o=>o.id===S.activeOrderDraftId);
    if(existing && existing.status==='en_cours')return existing;
  }
  const meta=getCurrentFlowDetail();
  const id=genOrderId();
  const now=new Date();
  const dateLabel=now.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
  const draft={
    id,status:'en_cours',type:S.svc,label:meta.label,detail:meta.detail,
    date:dateLabel,time:'À confirmer',dur:meta.dur,price:negoState.confirmed?negoState.price:P.min(),tip:0,
    address:S.loc,payment:'Espèces à la porte',team:getCurrentFlowTeam(),
    clientRating:null,clientComment:null
  };
  ordersData.unshift(draft);
  S.activeOrderDraftId=id;
  statusTrackedOrderId=id;
  persistStatusState();
  updateOrdersBadge();
  return draft;
}

// ════════════════════════
//  STATUS RENDERER
// ════════════════════════
function renderOrderConfirmed(){
  const el=$('dyn-order-confirmed');if(!el)return;
  const tracked=ensureCurrentOrderDraft()||getTrackedOrder();
  const pro=(tracked?.team||[])[0]||S.fid.members[S.selectedPro||'a'];
  el.innerHTML=`
    <div style="background:var(--navy);border-radius:var(--r-lg);padding:20px;text-align:center">
      <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:6px">Commande</div>
      <div style="font-family:'Fraunces',serif;font-size:24px;font-weight:700;color:white;margin-bottom:4px">#${tracked?.id||'—'}</div>
      <div style="font-family:'Fraunces',serif;font-size:32px;font-weight:700;color:white;margin-bottom:4px">${tracked?.price||0} MAD</div>
    </div>
    <div class="card">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="avatar av-lg ${pro.av||''}" style="${pro.av?'':'background:var(--navy)'}">${pro.init||'--'}</div>
        <div style="flex:1">
          <div style="font-size:15px;font-weight:700;color:var(--navy)">${pro.name||'Professionnelle'}</div>
          <div style="font-size:11px;color:var(--text-sec);margin-top:2px">${pro.role||''}</div>
        </div>
        <span class="chip chip-success">Confirmée</span>
      </div>
    </div>
    <div class="card">
      ${row('Service',tracked?.label||'—')}
      ${row('Adresse',S.loc)}
      ${row('Paiement','Espèces à la porte')}
    </div>
    <div style="background:var(--bg-alt);border-radius:var(--r-md);padding:12px 14px;display:flex;gap:8px;align-items:flex-start">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span style="font-size:11px;color:var(--text-muted);line-height:1.5">Votre professionnelle est en route. Vous pouvez suivre sa progression en temps réel.</span>
    </div>`;
}

let statusPhase=0;
const statusSteps=[
  {lbl:'Commande confirmée',time:'10:15',desc:'Votre demande a été acceptée'},
  {lbl:'En route vers vous',time:'11:05',desc:'Arrivée estimée dans 25 min'},
  {lbl:'Arrivée sur place',time:'11:30',desc:'La professionnelle est à votre porte'},
  {lbl:'Prestation en cours',time:'11:50',desc:'Nettoyage en cours…'},
  {lbl:'Prestation terminée',time:'14:55',desc:'Travail terminé avec succès !'}
];
const STATUS_PHASE_DELAYS=[2800,3600,3000,5200];
const STATUS_STEP_OFFSETS_MIN=[0,12,24,35,190];
const STATUS_STORAGE_KEY='babloo_status_sim_v2';
let statusTimers=[];
let statusAutoRunning=false;
let statusStartedAt=null;
let statusTrackedOrderId=null;

function isStatusScreenActive(){
  return document.querySelector('.screen.active')?.id==='s-status';
}

function fmtClock(d){
  return d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
}

function setStatusStepTimesFromStart(startDate){
  statusSteps.forEach((step,i)=>{
    const t=new Date(startDate.getTime()+STATUS_STEP_OFFSETS_MIN[i]*60000);
    step.time=fmtClock(t);
  });
}

function persistStatusState(){
  try{
    localStorage.setItem(STATUS_STORAGE_KEY,JSON.stringify({
      phase:statusPhase,
      startedAt:statusStartedAt?statusStartedAt.toISOString():null,
      trackedOrderId:statusTrackedOrderId
    }));
  }catch(_){}
}

function restoreStatusState(){
  try{
    const raw=localStorage.getItem(STATUS_STORAGE_KEY);
    if(!raw)return;
    const saved=JSON.parse(raw);
    if(typeof saved.phase==='number')statusPhase=Math.max(0,Math.min(4,saved.phase));
    if(saved.startedAt){
      const dt=new Date(saved.startedAt);
      if(!isNaN(dt.getTime())){
        statusStartedAt=dt;
        setStatusStepTimesFromStart(dt);
      }
    }
    if(saved.trackedOrderId)statusTrackedOrderId=saved.trackedOrderId;
  }catch(_){}
}

function getTrackedOrder(){
  if(typeof ordersData==='undefined')return null;
  if(statusTrackedOrderId){
    const existing=ordersData.find(o=>o.id===statusTrackedOrderId);
    if(existing)return existing;
  }
  const active=ordersData.find(o=>o.status==='en_cours');
  if(active){
    statusTrackedOrderId=active.id;
    return active;
  }
  const fallback=ordersData[0]||null;
  if(fallback)statusTrackedOrderId=fallback.id;
  return fallback;
}

function syncTrackedOrderFromPhase(reset=false){
  const tracked=getTrackedOrder();
  if(!tracked)return;
  if(reset){
    tracked.status='en_cours';
    tracked.clientRating=null;
    tracked.clientComment=null;
  }else if(statusPhase>=4){
    tracked.status='terminee';
  }else{
    tracked.status='en_cours';
  }
  updateOrdersBadge();
  if(document.querySelector('.screen.active')?.id==='s-orders')renderOrders();
  if(document.querySelector('.screen.active')?.id==='s-home')renderHomeTrackingBanner();
  persistStatusState();
}

function renderHomeTrackingBanner(){
  const wrap=$('home-live-banner-wrap');
  if(!wrap)return;
  const tracked=getTrackedOrder();
  if(!tracked || statusPhase>=4 || tracked.status!=='en_cours'){
    wrap.style.display='none';
    wrap.innerHTML='';
    return;
  }
  const current=statusSteps[statusPhase]||statusSteps[0];
  const next=statusSteps[Math.min(statusPhase+1,4)]||statusSteps[4];
  const progress=(statusPhase/(statusSteps.length-1))*100;
  const phaseDots=statusSteps.map((_,i)=>{
    const isDone=i<statusPhase;
    const isActive=i===statusPhase;
    const bg=isDone?'var(--clay)':isActive?'var(--navy)':'var(--border)';
    const border=isActive?'2px solid rgba(14,20,66,.18)':'none';
    const size=isActive?'12px':'8px';
    return `<div style="width:${size};height:${size};border-radius:999px;background:${bg};border:${border};transition:all .2s"></div>`;
  }).join('');
  wrap.style.display='';
  wrap.innerHTML=`
    <div onclick="gotoV3('s-status')" style="cursor:pointer;background:linear-gradient(165deg,var(--surface) 0%,var(--bg-alt) 100%);border-radius:22px;padding:14px 14px 12px;box-shadow:var(--sh-md);border:1.5px solid var(--border);position:relative;overflow:hidden">
      <div style="position:absolute;left:0;top:0;right:0;height:3px;background:linear-gradient(90deg,var(--clay) 0%,var(--clay-light) 100%)"></div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div style="width:34px;height:34px;border-radius:12px;background:rgba(14,20,66,.07);display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(14,20,66,.08)">
          <div style="width:18px;height:18px;line-height:0">${BABLOO_SVG_NAVY}</div>
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-size:10px;font-weight:700;letter-spacing:.9px;text-transform:uppercase;color:var(--text-muted)">Suivi en direct · #${tracked.id}</div>
          <div style="font-size:14px;font-weight:700;color:var(--navy);line-height:1.35;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${current.lbl}</div>
        </div>
        <span style="font-size:11px;color:var(--text-sec);font-weight:600">${next.time}</span>
      </div>
      <div style="position:relative;height:7px;border-radius:999px;background:var(--border);overflow:hidden">
        <div style="height:100%;width:${progress}%;background:linear-gradient(90deg,var(--clay) 0%,var(--clay-light) 100%);border-radius:999px;transition:width .35s ease"></div>
        <div style="position:absolute;top:50%;left:${progress}%;transform:translate(-50%,-50%);width:12px;height:12px;border-radius:50%;background:var(--surface);box-shadow:0 0 0 3px rgba(196,55,13,.22),0 2px 8px rgba(14,20,66,.16)"></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:10px">${phaseDots}</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <span style="font-size:11px;color:var(--text-sec)">Prochaine étape : ${next.lbl}</span>
        <span style="font-size:11px;color:var(--clay);font-weight:700">Voir le suivi</span>
      </div>
    </div>`;
}

function clearStatusTimers(){
  statusTimers.forEach(t=>clearTimeout(t));
  statusTimers=[];
  statusAutoRunning=false;
}

function startStatusSimulation(reset=false){
  if(reset){
    statusPhase=0;
    statusStartedAt=new Date();
    setStatusStepTimesFromStart(statusStartedAt);
    persistStatusState();
  }else if(!statusStartedAt){
    statusStartedAt=new Date();
    setStatusStepTimesFromStart(statusStartedAt);
    persistStatusState();
  }
  clearStatusTimers();
  syncTrackedOrderFromPhase(reset);
  if(statusPhase>=4)return;
  statusAutoRunning=true;
  let elapsed=0;
  for(let i=statusPhase;i<4;i++){
    elapsed+=STATUS_PHASE_DELAYS[i];
    const timer=setTimeout(()=>{
      statusPhase=i+1;
      syncTrackedOrderFromPhase(false);
      if(isStatusScreenActive()){
        renderStatus();
        showToast(statusSteps[statusPhase].lbl);
      }
      if(statusPhase>=4)clearStatusTimers();
    },elapsed);
    statusTimers.push(timer);
  }
}

window.openLiveStatus=function(){
  startStatusSimulation(true);
  gotoV3('s-status');
};

function renderStatus(){
  const el=$('dyn-status');if(!el)return;
  const tracked=getTrackedOrder();
  const title=$('status-order-title');
  if(title)title.textContent=`Commande #${tracked?.id||'—'}`;
  const price=tracked?.price ?? (negoState.confirmed?negoState.price:P.min());
  const label=tracked?.label||'Prestation';
  const detail=tracked?.detail||'—';
  const pro=(tracked?.team||[])[0]||S.fid.members[S.selectedPro||'a'];
  const chip=$('status-main-chip');
  if(chip){
    if(statusPhase===0){chip.textContent='Confirmé';chip.className='chip chip-success';}
    else if(statusPhase<4){chip.textContent='En cours';chip.className='chip chip-warn';}
    else{chip.textContent='Terminé';chip.className='chip chip-navy';}
  }
  el.innerHTML=`
    <div class="card">
      <div class="t-label" style="margin-bottom:12px">Votre professionnelle</div>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="avatar av-lg ${pro.av||''}" style="${pro.av?'':'background:var(--navy)'}">${pro.init||'--'}</div>
        <div style="flex:1">
          <div style="font-size:15px;font-weight:700;color:var(--navy)">${pro.name||'Professionnelle'}</div>
          <div style="font-size:11px;color:var(--text-sec);margin-top:2px">${pro.role||''}${pro.rating?` · ${pro.rating} ★`:''}</div>
        </div>
        <button class="btn btn-ghost btn-xs" onclick="gotoV3('s-chat')">Chat</button>
      </div>
    </div>
    <div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="t-label" style="margin-bottom:4px">Prix convenu</div>
      <div style="font-family:'Fraunces',serif;font-size:28px;font-weight:700;color:var(--navy)">${price} MAD</div></div>
      <span class="chip chip-success">Confirmé</span>
    </div>
    <div class="card">
      <div class="t-label" style="margin-bottom:11px">Détails commande</div>
      ${row('Service',label)}${row('Détail',detail)}${row('Adresse',S.loc)}${row('Paiement','Espèces à la porte')}
    </div>
    <div class="card">
      <div class="t-label" style="margin-bottom:12px">Suivi en temps réel</div>
      ${statusSteps.map((step,i)=>{
        const done=i<statusPhase;
        const active=i===statusPhase;
        const future=i>statusPhase;
        const col=done?'var(--success)':active?'var(--clay)':'var(--border-strong)';
        const txtCol=done?'var(--navy)':active?'var(--clay)':'var(--text-muted)';
        return`<div style="display:flex;gap:12px;opacity:${future?'.45':'1'}">
          <div style="display:flex;flex-direction:column;align-items:center">
            <div style="width:20px;height:20px;border-radius:50%;background:${col};flex-shrink:0;display:flex;align-items:center;justify-content:center">
              ${done?'<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>':active?'<div style="width:8px;height:8px;border-radius:50%;background:white;animation:pulse 1.4s infinite"></div>':'<div style="width:6px;height:6px;border-radius:50%;background:white"></div>'}
            </div>
            ${i<statusSteps.length-1?`<div style="width:2px;flex:1;min-height:18px;background:${done?'var(--success)':active?'rgba(196,55,13,.4)':'var(--border)'};margin:3px 0"></div>`:''}
          </div>
          <div style="padding-bottom:${i<statusSteps.length-1?'14':'0'}px">
            <div style="font-size:13px;font-weight:${done||active?'700':'500'};color:${txtCol}">${step.lbl}</div>
            <div style="font-size:11px;color:var(--text-muted)">${(done||active)?step.time:'—'}</div>
            ${active?`<div style="font-size:11px;color:var(--clay);margin-top:3px;font-weight:500">${step.desc}</div>`:''}
          </div>
        </div>`;
      }).join('')}
    </div>
    ${statusPhase<4?`
      <div style="background:var(--bg-alt);border-radius:var(--r-lg);padding:14px 16px;display:flex;gap:10px;align-items:flex-start;margin-bottom:8px">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span style="font-size:11px;color:var(--text-muted);line-height:1.5">Mise à jour automatique en cours… prochaine étape : <strong style="color:var(--navy)">${statusSteps[Math.min(statusPhase+1,4)].lbl}</strong>.</span>
      </div>`:`
      <div style="background:var(--success-bg);border:1.5px solid var(--success);border-radius:var(--r-lg);padding:18px;text-align:center;margin-bottom:8px">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2.5" stroke-linecap="round" style="margin-bottom:8px"><circle cx="12" cy="12" r="10"/><polyline points="16 8 10 16 7 13"/></svg>
        <div style="font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--navy);margin-bottom:4px">Prestation terminée !</div>
        <div style="font-size:12px;color:var(--success)">Durée totale : 3h05</div>
      </div>
      <button class="btn btn-clay" onclick="gotoV3('s-rating')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        Évaluer la prestation
      </button>`}`;
}

// ════════════════════════
//  SEARCH FLOW
// ════════════════════════
let searchTimers=[];
function renderSearch(){
  searchTimers.forEach(t=>clearTimeout(t));
  searchTimers=[];
  const anim=$('search-anim');if(anim)anim.style.display='';
  const res=$('search-results');if(res)res.style.display='none';
  const prog=$('search-prog');if(prog)prog.style.width='0%';
  const chip=$('search-chip');if(chip){chip.textContent='Recherche…';chip.className='chip chip-warn';}
  const statusTxt=$('search-status-txt');
  const steps=[
    [300,'15%','Vérification des disponibilités…'],
    [1200,'45%','Analyse des profils à proximité…'],
    [2200,'72%','Correspondance avec votre demande…'],
    [3200,'95%','Professionnelles identifiées !'],
    [3800,'100%','']
  ];
  steps.forEach(([ms,w,txt])=>{
    searchTimers.push(setTimeout(()=>{
      if(prog)prog.style.width=w;
      if(statusTxt&&txt)statusTxt.textContent=txt;
    },ms));
  });
  searchTimers.push(setTimeout(()=>{
    if(anim)anim.style.display='none';
    if(res)res.style.display='';
    if(chip){chip.textContent='2 trouvées';chip.className='chip chip-success';}
  },4200));
}

// ════════════════════════
//  PRO SELECTION
// ════════════════════════
function selectPro(key){
  S.selectedPro=key;
  renderProModal(key);
}
window.selectPro=selectPro;

function renderProModal(key){
  const el=$('pro-select-content');if(!el)return;
  const pro=S.fid.members[key];
  const skills=Object.entries(pro.skills).filter(([,v])=>v).map(([sk])=>S.fid.defs[sk].label);
  el.innerHTML=`
    <div style="text-align:center;margin-bottom:18px">
      <div class="avatar av-xl" style="background:${avBg[key]};margin:0 auto 12px">${pro.init}</div>
      <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--navy)">${pro.name}</div>
      <div style="font-size:12px;color:var(--text-sec);margin-top:3px">${pro.role}</div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:18px">
      <div style="flex:1;background:var(--bg-alt);border-radius:var(--r-md);padding:12px;text-align:center">
        <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--navy)">${pro.rating}</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px">Note</div>
      </div>
      <div style="flex:1;background:var(--bg-alt);border-radius:var(--r-md);padding:12px;text-align:center">
        <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--navy)">${pro.cnt}</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px">Prestations</div>
      </div>
      <div style="flex:1;background:var(--bg-alt);border-radius:var(--r-md);padding:12px;text-align:center">
        <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--navy)">${pro.rel}%</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px">Fiabilité</div>
      </div>
    </div>
    <div class="t-label" style="margin-bottom:8px">Compétences</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:18px">
      ${skills.map(s=>`<span class="chip chip-navy" style="font-size:11px">${s}</span>`).join('')}
    </div>
    <div class="t-label" style="margin-bottom:8px">Points forts</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px">
      ${[{i:'⏱',t:'Ponctualité',d:'Arrive toujours à l\'heure'},{i:'✨',t:'Qualité du travail',d:'Attention aux détails reconnue'},{i:'💬',t:'Communication',d:'Prévient en cas de changement'}].map(p=>`
        <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-alt);border-radius:var(--r-md)">
          <span style="font-size:18px">${p.i}</span>
          <div><div style="font-size:12px;font-weight:700;color:var(--navy)">${p.t}</div>
          <div style="font-size:11px;color:var(--text-muted)">${p.d}</div></div>
        </div>`).join('')}
    </div>
    <div style="background:var(--navy);border-radius:var(--r-lg);padding:16px;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,.4)">Plancher minimum</div>
        <div style="font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:white;margin-top:2px">${P.min()} MAD</div>
      </div>
      <div style="font-size:11px;color:rgba(255,255,255,.5);text-align:right">Prix à négocier<br>directement</div>
    </div>
    <button class="btn btn-clay" onclick="closeModal('modal-pro-select');gotoV3('s-chat')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Sélectionner et négocier le prix
    </button>`;
}

// ════════════════════════
//  CHAT / NÉGOCIATION
// ════════════════════════
let negoState = { price: 0, floor: 0, confirmed: false };

function renderChat(){
  const floor = P.min();
  const proKey=S.selectedPro||'a';
  const pro=S.fid.members[proKey];
  negoState.floor = floor;
  negoState.price = Math.round(floor * 1.15);
  negoState.confirmed = false;
  const chatAv=$('chat-hdr-avatar');
  if(chatAv){
    chatAv.textContent=pro.init;
    chatAv.className=`avatar av-md ${pro.av||''}`;
    if(!pro.av)chatAv.style.background=avBg[proKey]||'var(--navy)';
    else chatAv.style.background='';
  }
  const chatName=$('chat-hdr-name');if(chatName)chatName.textContent=pro.name;
  const chatRole=$('chat-hdr-role');if(chatRole)chatRole.textContent=pro.role+' · En ligne';
  S.chatMsgs=[
    {f:'pro',t:'Bonjour ! Je suis disponible pour votre demande.'},
    {f:'cli',t:'Bonjour '+pro.name.split(' ')[0]+' ! On peut discuter du prix ?'},
    {f:'pro',t:'Bien sûr, le plancher est de '+floor+' MAD. Proposez votre prix !'},
    {f:'sys',t:'Négociation du prix en cours'}
  ];
  drawChat();
  renderNegoPanel();
}

function renderNegoPanel(){
  const el=$('nego-panel');if(!el)return;
  const floor=negoState.floor;
  const maxPrice=Math.round(floor*2.5);
  const price=negoState.price;
  
  if(negoState.confirmed){
    // Show confirmed state
    el.innerHTML=`
      <div style="background:var(--success-bg);border:1.5px solid var(--success);border-radius:var(--r-lg);padding:18px;text-align:center;margin-top:4px">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2.5" stroke-linecap="round" style="margin-bottom:8px"><circle cx="12" cy="12" r="10"/><polyline points="16 8 10 16 7 13"/></svg>
        <div style="font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--navy);margin-bottom:3px">${negoState.price} MAD</div>
        <div style="font-size:12px;color:var(--success);font-weight:600;margin-bottom:4px">Prix convenu ✓</div>
        <div style="font-size:11px;color:var(--text-muted)">Paiement en espèces à l'arrivée</div>
      </div>
      <button class="btn btn-primary" style="margin-top:14px" onclick="gotoV3('s-order-confirmed')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
        Continuer vers le suivi
      </button>`;
    return;
  }
  
  // Active negotiation panel
  const pct=Math.round(((price-floor)/floor)*100);
  el.innerHTML=`
    <div class="nego-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <div>
          <div class="t-label" style="margin-bottom:4px">Plancher minimum</div>
          <div style="font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--text-muted)">${floor} MAD</div>
        </div>
        <div style="text-align:right">
          <div class="t-label" style="margin-bottom:4px">Votre proposition</div>
          <div style="display:flex;align-items:center;gap:4px;justify-content:flex-end">
            ${pct>0?`<span class="chip chip-success" style="font-size:9px">+${pct}%</span>`:''}
          </div>
        </div>
      </div>
      <!-- Big price display -->
      <div style="text-align:center;margin-bottom:4px">
        <div class="nego-price-display" id="nego-price-val">${price} MAD</div>
      </div>
      <!-- Slider -->
      <input type="range" class="nego-slider" id="nego-slider" min="${floor}" max="${maxPrice}" value="${price}" step="5" oninput="updateNegoPrice(parseInt(this.value))">
      <div style="display:flex;justify-content:space-between;margin-bottom:14px">
        <span style="font-size:10px;color:var(--text-muted)">${floor} MAD</span>
        <span style="font-size:10px;color:var(--text-muted)">${maxPrice} MAD</span>
      </div>
      <!-- Quick buttons -->
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px">
        ${[{l:'Plancher',v:floor},{l:'+10%',v:Math.round(floor*1.1)},{l:'+20%',v:Math.round(floor*1.2)},{l:'+30%',v:Math.round(floor*1.3)}].map(b=>
          `<button class="nego-quick-btn${negoState.price===b.v?' sel':''}" onclick="updateNegoPrice(${b.v})">${b.l}<span style="font-weight:400;margin-left:3px;font-size:11px">${b.v} MAD</span></button>`
        ).join('')}
      </div>
      <!-- Manual input -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:10px 14px;border-radius:var(--r-md);background:var(--surface);border:1.5px solid var(--border)">
        <span style="font-size:12px;color:var(--text-muted);white-space:nowrap">Saisir un montant :</span>
        <input type="number" class="input-f" id="nego-input" value="${price}" min="${floor}" max="${maxPrice}" step="5" style="border:none;padding:0;font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--navy);text-align:right;width:80px" oninput="updateNegoPrice(parseInt(this.value)||${floor})">
        <span style="font-size:14px;font-weight:600;color:var(--text-sec)">MAD</span>
      </div>
      <!-- Info -->
      <div style="background:rgba(14,20,66,.04);border-radius:var(--r-sm);padding:10px 12px;display:flex;gap:8px;align-items:flex-start;margin-bottom:14px">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span style="font-size:11px;color:var(--text-muted);line-height:1.5">Le prix minimum garantit une rémunération juste. Proposez librement au-dessus pour valoriser le travail.</span>
      </div>
      <!-- Confirm button -->
      <button class="btn btn-clay" onclick="confirmNegoPrice()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
        Proposer ${price} MAD
      </button>
    </div>`;
}

window.updateNegoPrice=function(v){
  const floor=negoState.floor;
  v=Math.max(floor,Math.min(Math.round(floor*2.5),v));
  negoState.price=v;
  const disp=$('nego-price-val');if(disp)disp.textContent=v+' MAD';
  const slider=$('nego-slider');if(slider)slider.value=v;
  const inp=$('nego-input');if(inp)inp.value=v;
  // Update confirm button text
  const btns=document.querySelectorAll('#nego-panel .btn-clay');
  btns.forEach(b=>b.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg> Proposer ${v} MAD`);
  // Update quick buttons selection
  document.querySelectorAll('.nego-quick-btn').forEach(b=>b.classList.remove('sel'));
};

window.confirmNegoPrice=function(){
  negoState.confirmed=true;
  S.chatMsgs.push({f:'cli',t:'Je propose '+negoState.price+' MAD.'});
  S.chatMsgs.push({f:'pro',t:'C\'est parfait, j\'accepte ! À tout à l\'heure.'});
  drawChat();
  renderNegoPanel();
  const scroll=$('nego-scroll');if(scroll)setTimeout(()=>scroll.scrollTop=scroll.scrollHeight,100);
};

function drawChat(){
  const el=$('chat-msgs');if(!el)return;
  el.style.display='flex';el.style.flexDirection='column';el.style.gap='8px';
  el.innerHTML='<div style="font-size:11px;color:var(--text-muted);text-align:center;margin-bottom:4px">Aujourd\'hui</div>'+
    S.chatMsgs.map(m=>{
      if(m.f==='sys')return`<div style="background:#FFF4DC;color:#9A5D00;border:1px solid rgba(176,107,0,.25);font-size:11px;font-weight:600;padding:5px 14px;border-radius:999px;margin:2px auto;align-self:center">${m.t}</div>`;
      const cli=m.f==='cli';
      return`<div style="max-width:76%;padding:10px 14px;border-radius:18px;font-size:14px;line-height:1.5;align-self:${cli?'flex-end':'flex-start'};background:${cli?'var(--navy)':'#fff'};color:${cli?'#fff':'var(--navy)'};${cli?'':'box-shadow:0 2px 8px rgba(14,20,66,.08)'}">${m.t}</div>`;
    }).join('');
  const scroll=$('nego-scroll');if(scroll)setTimeout(()=>scroll.scrollTop=scroll.scrollHeight,50);
}

window.chatGoBack=function(){
  if(negoState.confirmed) gotoV3('s-status');
  else gotoV3('s-search');
};

window.chatSend=function(e){
  if(e.key!=='Enter')return;
  const inp=$('chat-inp'),v=inp?.value.trim();
  if(!v)return;
  S.chatMsgs.push({f:'cli',t:v});
  inp.value='';drawChat();
  const r=['D\'accord, c\'est noté !','Merci pour la précision.','Pas de problème.','À tout à l\'heure.'];
  setTimeout(()=>{S.chatMsgs.push({f:'pro',t:r[Math.floor(Math.random()*r.length)]});drawChat();},900);
};

// ════════════════════════
//  SQUAD REVIEW
// ════════════════════════
function renderSquad(){
  const tracked=getTrackedOrder();
  if(tracked && tracked.id!==squadHydratedOrderId && Array.isArray(tracked.team) && tracked.team.length){
    hydrateFidelityFromOrder(tracked);
    squadHydratedOrderId=tracked.id;
  }
  calcFid();
  const sel=Object.values(S.fid.members).filter(m=>m.sel);
  const tot=sel.reduce((s,m)=>s+m.price,0);
  const totalTxt=tot.toLocaleString('fr-FR')+' MAD<span style="font-size:13px;font-weight:500;color:var(--text-muted)">/mois</span>';
  const countTxt=sel.length+' / '+Object.keys(S.fid.members).length;
  setH('sq-total',totalTxt);
  set('sq-count',countTxt);
  setH('fid-total',totalTxt);
  set('fid-count',countTxt);
  const tgl=$('tgl-all');if(tgl)tgl.classList.toggle('on',sel.length===Object.keys(S.fid.members).length);
  const cards=$('squad-cards');if(!cards)return;
  cards.innerHTML=Object.entries(S.fid.members).map(([k,m])=>`
    <div class="squad-card${m.sel?' sel':''}" id="sqc-${k}" onclick="toggleSqM('${k}')" style="margin:0 20px 12px;background:#fff;border-radius:20px;padding:18px;box-shadow:0 2px 10px rgba(14,20,66,.08);border:2px solid ${m.sel?'var(--navy)':'transparent'};cursor:pointer;position:relative;transition:border-color .2s">
      <div style="position:absolute;top:16px;right:16px">
        <div style="width:22px;height:22px;border-radius:50%;border:2px solid ${m.sel?'var(--navy)':'var(--border-strong)'};background:${m.sel?'var(--navy)':'#fff'};display:flex;align-items:center;justify-content:center">
          ${m.sel?'<svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>':''}
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:13px;margin-bottom:12px">
        <div class="avatar av-lg" style="background:${avBg[k]}">${m.init}</div>
        <div style="flex:1;padding-right:28px">
          <div style="font-size:15px;font-weight:700;color:var(--navy)">${m.name}</div>
          <div style="font-size:11px;color:var(--text-sec);margin-bottom:3px">${m.role}</div>
          <div style="font-size:12px;font-weight:700;color:var(--navy)">${m.rating} <span style="font-weight:400;color:var(--text-muted)">★ · ${m.cnt} prestations</span></div>
        </div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px">
        ${Object.entries(m.skills).filter(([,v])=>v).map(([sk])=>`<span class="chip${m.sel?' chip-navy':''}" style="font-size:10px">${S.fid.defs[sk].label}</span>`).join('')}
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span style="font-size:10px;color:var(--text-muted);min-width:56px">Fiabilité</span>
        <div style="height:4px;border-radius:2px;background:var(--border);flex:1;overflow:hidden"><div style="height:100%;border-radius:2px;background:var(--navy);width:${m.rel}%"></div></div>
        <span style="font-size:11px;font-weight:700;color:var(--navy);min-width:28px;text-align:right">${m.rel}%</span>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:11px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="t-label" style="margin-bottom:2px">Tarif mensuel estimé</div>
          <div style="font-family:'Fraunces',serif;font-size:17px;font-weight:700;color:${m.sel?'var(--clay)':'var(--text-muted)'}">${m.sel?m.price.toLocaleString('fr-FR')+' MAD':'—'}<span style="font-size:11px;font-weight:500;color:var(--text-muted)">${m.sel?'/mois':''}</span></div>
        </div>
        ${m.sel?`<button class="btn btn-ghost btn-xs" onclick="S.fid.curPro='${k}';gotoV3('s-fid-configure');event.stopPropagation()">Configurer</button>`:`<span class="chip" style="font-size:10px">Ajouter</span>`}
      </div>
    </div>`).join('');
}

window.toggleSqM=function(k){S.fid.members[k].sel=!S.fid.members[k].sel;renderSquad();};
window.toggleAll=function(){
  const tgl=$('tgl-all');if(!tgl)return;
  const on=!tgl.classList.contains('on');
  Object.keys(S.fid.members).forEach(k=>S.fid.members[k].sel=on);
  renderSquad();
};

// ════════════════════════
//  FID CONFIG
// ════════════════════════
let fidConfigQueue=[];
let fidConfigIdx=0;
let squadHydratedOrderId=null;

function buildFidQueue(){
  fidConfigQueue=Object.entries(S.fid.members).filter(([,m])=>m.sel).map(([k])=>k);
  fidConfigIdx=0;
  if(fidConfigQueue.length>0) S.fid.curPro=fidConfigQueue[0];
}

function renderFidCfg(){
  calcFid();
  const k=S.fid.curPro,m=S.fid.members[k];
  // Update queue index
  const idx=fidConfigQueue.indexOf(k);
  if(idx>=0) fidConfigIdx=idx;
  const total=fidConfigQueue.length||1;
  const current=fidConfigIdx+1;
  const av=$('fid-cfg-av');
  if(av){av.textContent=m.init;av.className=`avatar av-lg`;av.style.background=avBg[k];}
  set('fid-cfg-name',m.name);
  set('fid-cfg-sub',`${m.role} · ${m.rating} ★`);
  // Update stepper
  const stepLabel=document.querySelector('#s-fid-configure div[style*="letter-spacing:1.5px"]');
  if(stepLabel) stepLabel.textContent=`Configuration · ${current} sur ${total}`;
  // Update dots
  const dotsWrap=document.querySelector('#s-fid-configure div[style*="display:flex;gap:6px"]');
  if(dotsWrap) dotsWrap.innerHTML=fidConfigQueue.map((_,i)=>
    `<div style="width:8px;height:8px;border-radius:50%;background:${i<=fidConfigIdx?'white':'rgba(255,255,255,0.3)'}"></div>`
  ).join('');
  // Update next button
  const nextBtn=$('fid-next-btn');
  if(nextBtn){
    const isLast=fidConfigIdx>=total-1;
    if(isLast){
      nextBtn.innerHTML=`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg> Voir le contrat`;
    } else {
      const nextKey=fidConfigQueue[fidConfigIdx+1];
      const nextName=S.fid.members[nextKey].name.split(' ')[0];
      nextBtn.innerHTML=`Suivante : ${nextName} <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>`;
    }
  }
  const hslider=document.querySelector('#s-fid-configure input[type=range]');
  if(hslider)hslider.value=m.hours;
  set('h-month',m.hours);
  renderSkills();renderFidPrice();renderPrefSlots();
}

window.nextFidConfig=function(){
  if(fidConfigIdx>=fidConfigQueue.length-1){
    gotoV3('s-fid-contract');
  } else {
    fidConfigIdx++;
    S.fid.curPro=fidConfigQueue[fidConfigIdx];
    renderFidCfg();
    showToast('Configuration de '+S.fid.members[S.fid.curPro].name.split(' ')[0]);
  }
};

function renderSkills(){
  const k=S.fid.curPro,m=S.fid.members[k];
  const el=$('skill-rows');if(!el)return;
  el.innerHTML=Object.entries(S.fid.defs).map(([sk,def])=>`
    <div class="skill-row${m.skills[sk]?' on':''}" onclick="toggleSkill('${sk}')">
      <div style="flex:1">
        <div class="skill-name">${def.label}</div>
        <div class="skill-hint">+${def.base} MAD/mois · ${def.minH}h minimum</div>
      </div>
      <div class="skill-chk${m.skills[sk]?' on':''}"></div>
    </div>`).join('');
}

window.toggleSkill=function(sk){
  const k=S.fid.curPro;S.fid.members[k].skills[sk]=!S.fid.members[k].skills[sk];
  calcFid();renderSkills();renderFidPrice();
};

window.updH=function(v){
  const k=S.fid.curPro;S.fid.members[k].hours=parseInt(v);
  set('h-month',v);
  calcFid();renderFidPrice();
};

function renderFidPrice(){
  const k=S.fid.curPro,m=S.fid.members[k];
  const el=$('fid-price-summ');if(!el)return;
  const sel=Object.entries(m.skills).filter(([,v])=>v);
  const bonus=m.hours>20?Math.floor((m.hours-20)*8):0;
  el.innerHTML=`
    <div style="background:#F7F3EB;border-radius:16px;padding:16px;border:1px solid rgba(196,55,13,.14)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="t-label">Récapitulatif · ${m.name.split(' ')[0]}</div>
        <span class="chip chip-clay">Par compétence</span>
      </div>
      ${sel.map(([sk])=>`<div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span style="font-size:12px;color:var(--text-sec)">${S.fid.defs[sk].label}</span>
        <span style="font-size:12px;font-weight:600;color:var(--navy)">${S.fid.defs[sk].base} MAD</span></div>`).join('')}
      ${bonus?`<div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span style="font-size:12px;color:var(--text-sec)">Heures sup. (+${m.hours-20}h)</span>
        <span style="font-size:12px;font-weight:600;color:var(--navy)">+${bonus} MAD</span></div>`:''}
      <div style="border-top:1px solid rgba(196,55,13,.15);padding-top:10px;display:flex;justify-content:space-between">
        <span style="font-size:14px;font-weight:700;color:var(--navy)">Total ${m.name.split(' ')[0]}</span>
        <span style="font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--clay)">${m.price} MAD/mois</span>
      </div>
      <p style="font-size:10px;color:var(--text-muted);line-height:1.6;margin-top:8px">${m.name.split(' ')[0]} peut proposer un ajustement à l'acceptation.</p>
    </div>`;
}

function renderPrefSlots(){
  const k=S.fid.curPro,m=S.fid.members[k];
  if(!m)return;
  Object.keys(m.slots||{}).forEach(slot=>{
    const el=$('pref-slot-'+slot);
    if(el)el.classList.toggle('sel',!!m.slots[slot]);
  });
}

window.togglePrefSlot=function(slot){
  const k=S.fid.curPro,m=S.fid.members[k];
  if(!m || !m.slots || !(slot in m.slots))return;
  m.slots[slot]=!m.slots[slot];
  renderPrefSlots();
};

// ════════════════════════
//  CALENDAR
// ════════════════════════
let calTab='equipe';
let calCtx={ mode:'team', proKey:null, back:'s-fid-dashboard' };

function getFocusedCalendarPro(){
  if(calCtx.mode!=='pro') return null;
  const key=calCtx.proKey;
  return (S && S.fid && S.fid.members && S.fid.members[key]) ? key : null;
}

function updateCalendarChrome(){
  const titleEl=$('cal-title');
  const cta=$('cal-primary-cta');
  const focusPro=getFocusedCalendarPro();
  if(titleEl){
    if(calTab==='moi') titleEl.textContent='Mon calendrier';
    else if(focusPro) titleEl.textContent='Calendrier · '+(S.fid.members[focusPro].name.split(' ')[0]);
    else titleEl.textContent='Planning partagé';
  }
  if(cta){
    const showCta=(calCtx.mode==='pro' && calCtx.back==='s-fid-configure') || calCtx.mode==='team';
    cta.style.display=showCta?'':'none';
  }
}

window.openMyCalendar=function(backId){
  calCtx={ mode:'mine', proKey:null, back: backId || 's-fid-dashboard' };
  calTab='moi';
  gotoV3('s-fid-calendar');
  setTimeout(()=>{ updateCalendarChrome(); renderCal(); }, 60);
};

window.openTeamCalendar=function(backId){
  calCtx={ mode:'team', proKey:null, back: backId || 's-fid-dashboard' };
  calTab='equipe';
  gotoV3('s-fid-calendar');
  setTimeout(()=>{ updateCalendarChrome(); renderCal(); }, 60);
};

window.openProCalendar=function(proKey, backId){
  calCtx={ mode:'pro', proKey: proKey || ((S&&S.fid&&S.fid.curPro)||'a'), back: backId || 's-fid-configure' };
  calTab='equipe';
  gotoV3('s-fid-calendar');
  setTimeout(()=>{ updateCalendarChrome(); renderCal(); }, 60);
};

window.requestSlot=function(){
  const dateInput=document.querySelector('#modal-slot input[type=date]');
  const timeInputs=document.querySelectorAll('#modal-slot input[type=time]');
  const recurring=document.getElementById('rec-tgl')?.classList.contains('on');
  const selPro=document.querySelector('#slot-pro-options .slot-pro-opt.sel');
  const proName=selPro?selPro.querySelector('span')?.textContent||'la professionnelle':'Fatima';
  const start=timeInputs[0]?.value||'10:00';
  const end=timeInputs[1]?.value||'13:00';
  const dateStr=dateInput?.value;
  let displayDate='';
  if(dateStr){
    const d=new Date(dateStr);
    const days=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
    displayDate=days[d.getDay()]+' '+d.getDate()+'/'+(d.getMonth()+1);
  }
  closeModal('modal-slot');
  showToast(`Créneau demandé à ${proName} : ${displayDate} ${start}–${end}${recurring?' (récurrent)':''}`);
};

window.selectSlotPro=function(proKey){
  document.querySelectorAll('#slot-pro-options .slot-pro-opt').forEach(el=>{
    el.classList.toggle('sel',el.dataset.pro===proKey);
  });
};

window.goCalendarBack=function(){
  gotoV3((calCtx && calCtx.back) || 's-fid-dashboard');
};

window.switchCalTab=function(tab){
  calTab=tab;
  ['equipe','moi'].forEach(t=>{
    const el=$('cal-tab-'+t);if(!el)return;
    if(t===tab){el.style.fontWeight='700';el.style.color='var(--navy)';el.style.borderBottom='2px solid var(--navy)';}
    else{el.style.fontWeight='600';el.style.color='var(--text-muted)';el.style.borderBottom='2px solid transparent';}
  });
  updateCalendarChrome();
  renderCal();
};

function renderCal(){
  const el=$('cal-grid');if(!el)return;
  const legend=$('cal-legend');
  const focusPro=getFocusedCalendarPro();
  updateCalendarChrome();

  if(calTab==='moi'){
    if(legend)legend.innerHTML=`
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:10px;height:10px;border-radius:50%;background:var(--navy)"></div>
        <span style="font-size:11px;font-weight:600;color:var(--navy)">Mes créneaux confirmés</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:10px;height:10px;border-radius:50%;background:var(--clay)"></div>
        <span style="font-size:11px;font-weight:600;color:var(--navy)">En attente de confirmation</span>
      </div>`;
    const times=['8h','9h','10h','11h','12h','13h','14h','15h'];
    const days=['',' L 24',' M 25',' M 26',' J 27',' V 28',' S 29',' D 30'];
    const myEvs={
      '9-1':{c:'var(--navy)',l:'🏠 FZ · Ménage',confirmed:true},
      '10-1':{c:'var(--navy)',l:'🏠 FZ · Ménage',confirmed:true},
      '10-3':{c:'var(--clay)',l:'⏳ KB · Sol',confirmed:false},
      '14-2':{c:'var(--navy)',l:'🍳 KB · Cuisine',confirmed:true},
      '9-5':{c:'var(--navy)',l:'🏠 FZ · Ménage',confirmed:true},
      '10-5':{c:'var(--navy)',l:'🏠 FZ',confirmed:true},
      '14-4':{c:'var(--clay)',l:'⏳ KB · Rep.',confirmed:false}
    };
    let h='<div style="display:grid;grid-template-columns:34px repeat(7,1fr)">';
    days.forEach((d,i)=>{
      h+=`<div style="padding:6px 3px;text-align:center;font-size:${i===0?9:10}px;font-weight:700;color:${i===1?'var(--clay)':'var(--text-muted)'};border-bottom:1px solid var(--border);background:#fff">${d}</div>`;
    });
    times.forEach(t=>{
      h+=`<div style="padding:5px 4px;text-align:right;font-size:9px;color:var(--text-muted);border-right:1px solid var(--border);border-bottom:1px solid var(--border);background:var(--bg-alt)">${t}</div>`;
      for(let c=1;c<=7;c++){
        const ev=myEvs[parseInt(t)+'-'+c];
        h+=`<div style="border-right:1px solid var(--border);border-bottom:1px solid var(--border);background:${ev?'rgba(14,20,66,.03)':'#fff'};min-height:36px;cursor:pointer;position:relative">
          ${ev?`<div style="position:absolute;inset:2px;border-radius:4px;padding:3px 4px;font-size:8px;font-weight:700;color:#fff;background:${ev.c};overflow:hidden;line-height:1.3;${!ev.confirmed?'opacity:.7;border:1px dashed rgba(255,255,255,.5)':''}">${ev.l}</div>`:''}
        </div>`;
      }
    });
    h+='</div>';
    h+=`<div style="padding:16px 20px">
      <div class="t-label" style="margin-bottom:10px">Mes prochains rendez-vous</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border-radius:var(--r-md);border-left:4px solid var(--navy)">
          <div>
            <div style="font-size:13px;font-weight:700;color:var(--navy)">Lundi 24 · 9h–11h</div>
            <div style="font-size:11px;color:var(--text-sec)">Fatima Zahra · Ménage</div>
          </div>
          <span class="chip chip-success" style="margin-left:auto;font-size:9px">Confirmé</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border-radius:var(--r-md);border-left:4px solid var(--navy)">
          <div>
            <div style="font-size:13px;font-weight:700;color:var(--navy)">Mardi 25 · 14h–16h</div>
            <div style="font-size:11px;color:var(--text-sec)">Khadija B. · Cuisine</div>
          </div>
          <span class="chip chip-success" style="margin-left:auto;font-size:9px">Confirmé</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border-radius:var(--r-md);border-left:4px solid var(--clay)">
          <div>
            <div style="font-size:13px;font-weight:700;color:var(--navy)">Mercredi 26 · 10h–12h</div>
            <div style="font-size:11px;color:var(--text-sec)">Khadija B. · Sol</div>
          </div>
          <span class="chip chip-warn" style="margin-left:auto;font-size:9px">En attente</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border-radius:var(--r-md);border-left:4px solid var(--clay)">
          <div>
            <div style="font-size:13px;font-weight:700;color:var(--navy)">Jeudi 27 · 14h–15h</div>
            <div style="font-size:11px;color:var(--text-sec)">Khadija B. · Repassage</div>
          </div>
          <span class="chip chip-warn" style="margin-left:auto;font-size:9px">En attente</span>
        </div>
      </div>
      <div style="margin-top:14px;background:rgba(14,20,66,.04);border-radius:var(--r-md);padding:12px 14px;display:flex;gap:8px;align-items:flex-start">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span style="font-size:11px;color:var(--text-muted);line-height:1.5">Vos créneaux confirmés sont réservés. Si vous avez besoin d'un autre service, vérifiez vos disponibilités ici.</span>
      </div>
    </div>`;
    el.innerHTML=h;
    return;
  }

  if(focusPro){
    const m=S.fid.members[focusPro];
    const dot=focusPro==='a'?'var(--pro-a)':focusPro==='b'?'var(--pro-b)':'var(--pro-c)';
    if(legend)legend.innerHTML=`
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:8px"><div style="width:10px;height:10px;border-radius:50%;background:${dot}"></div><span style="font-size:11px;font-weight:600;color:var(--navy)">${m.name}</span></div>
        <div style="display:flex;gap:6px"><span class="chip chip-success" style="font-size:9px">Disponible</span>${focusPro==='a'?'<span class="chip chip-warn" style="font-size:9px">Demandé</span>':''}</div>
      </div>`;
  } else if(legend)legend.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:8px"><div style="width:10px;height:10px;border-radius:50%;background:var(--pro-a)"></div><span style="font-size:11px;font-weight:600;color:var(--navy)">Fatima Zahra</span></div>
      <div style="display:flex;gap:6px"><span class="chip chip-success" style="font-size:9px">Disponible</span><span class="chip chip-warn" style="font-size:9px">Demandé</span></div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:8px"><div style="width:10px;height:10px;border-radius:50%;background:var(--pro-b)"></div><span style="font-size:11px;font-weight:600;color:var(--navy)">Khadija Benali</span></div>
      <div style="display:flex;gap:6px"><span class="chip chip-success" style="font-size:9px">Disponible</span></div>
    </div>`;

  const times=['8h','9h','10h','11h','12h','13h','14h','15h'];
  const days=['',' L 24',' M 25',' M 26',' J 27',' V 28',' S 29',' D 30'];
  let evs={'9-2':{c:'#6C63FF',l:'FZ · Ménage'},'9-5':{c:'#6C63FF',l:'FZ'},
    '10-1':{c:'var(--clay)',l:'Demandé'},'10-2':{c:'#6C63FF',l:'FZ'},
    '10-3':{c:'#E8517A',l:'KB · Sol'},'10-5':{c:'#6C63FF',l:'FZ'},
    '11-2':{c:'#6C63FF',l:'FZ'},'11-3':{c:'#E8517A',l:'KB'},
    '14-2':{c:'#E8517A',l:'KB · Cuisine'},'14-4':{c:'#E8517A',l:'KB'}};
  if(focusPro){
    const proColor = focusPro==='a' ? '#6C63FF' : focusPro==='b' ? '#E8517A' : '#00A89C';
    const filtered={};
    Object.entries(evs).forEach(([k,v])=>{
      if(v.c===proColor || (focusPro==='a' && v.l==='Demandé')) filtered[k]=v;
    });
    evs=filtered;
  }

  let h=`<div style="display:grid;grid-template-columns:34px repeat(7,1fr)">`;
  days.forEach((d,i)=>{
    h+=`<div style="padding:6px 3px;text-align:center;font-size:${i===0?9:10}px;font-weight:700;color:${i===1?'var(--clay)':'var(--text-muted)'};border-bottom:1px solid var(--border);background:#fff">${d}</div>`;
  });
  times.forEach(t=>{
    h+=`<div style="padding:5px 4px;text-align:right;font-size:9px;color:var(--text-muted);border-right:1px solid var(--border);border-bottom:1px solid var(--border);background:var(--bg-alt)">${t}</div>`;
    for(let c=1;c<=7;c++){
      const ev=evs[`${parseInt(t)}-${c}`];
      const bg=(focusPro==='a' && parseInt(t)===10&&c===1)?'rgba(196,55,13,.05)':'#fff';
      h+=`<div style="border-right:1px solid var(--border);border-bottom:1px solid var(--border);background:${bg};min-height:36px;cursor:pointer;position:relative">
        ${ev?`<div style="position:absolute;inset:2px;border-radius:4px;padding:3px 4px;font-size:8px;font-weight:700;color:#fff;background:${ev.c};overflow:hidden;line-height:1.3">${ev.l}</div>`:''}
      </div>`;
    }
  });
  h+='</div>';

  let detailCard='';
  if(!focusPro || focusPro==='a'){
    const label = focusPro ? ('Créneau demandé · '+S.fid.members[focusPro].name.split(' ')[0]) : 'DEMANDE EN ATTENTE';
    const subtitle = focusPro ? 'Ménage récurrent · '+S.fid.members[focusPro].name : 'Ménage + Cuisine · Fatima Zahra';
    detailCard=`<div style="padding:16px 20px 24px">
      <div style="background:rgba(196,55,13,0.06);border:1.5px solid rgba(196,55,13,0.2);border-radius:var(--r-lg);padding:16px">
        <div style="font-size:11px;font-weight:700;color:var(--clay);letter-spacing:.5px;margin-bottom:10px">${label}</div>
        <div style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:3px">Lundi 24 Fév · 10h – 13h</div>
        <div style="font-size:12px;color:var(--text-sec);margin-bottom:14px">${subtitle}</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost btn-xs" style="flex:1" onclick="showToast('Demande annulée')">Annuler</button>
          <button class="btn btn-xs" style="flex:2;background:var(--success);color:white" onclick="showToast('Créneau confirmé !')">Confirmer</button>
        </div>
      </div>
    </div>`;
  } else {
    detailCard=`<div style="padding:16px 20px 24px">
      <div style="background:rgba(14,20,66,.04);border:1px solid rgba(14,20,66,.10);border-radius:var(--r-lg);padding:14px 16px;display:flex;gap:10px;align-items:flex-start">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span style="font-size:11px;color:var(--text-muted);line-height:1.5">Vue centrée sur ${S.fid.members[focusPro].name}. Ouvrez l'onglet <strong style="color:var(--navy)">Mon planning</strong> pour comparer avec vos autres réservations.</span>
      </div>
    </div>`;
  }
  h+=detailCard;
  el.innerHTML=h;
}


// ════════════════════════
//  CONTRACT
// ════════════════════════
function renderContract(){
  calcFid();
  const el=$('contract-summ');if(!el)return;
  const sel=Object.entries(S.fid.members).filter(([,m])=>m.sel);
  const tot=sel.reduce((s,[,m])=>s+m.price,0);
  el.innerHTML=`
    <div class="t-label" style="margin-bottom:12px">Récapitulatif des ${sel.length} offre${sel.length>1?'s':''}</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      ${sel.map(([k,m])=>`
        <div style="display:flex;align-items:center;gap:12px">
          <div class="avatar av-md" style="background:${avBg[k]}">${m.init}</div>
          <div style="flex:1">
            <div style="font-size:13px;font-weight:700;color:var(--navy)">${m.name}</div>
            <div style="font-size:11px;color:var(--text-muted)">${Object.entries(m.skills).filter(([,v])=>v).map(([sk])=>S.fid.defs[sk].label).join(' + ')} · ${m.hours}h/mois</div>
          </div>
          <div style="font-family:'Fraunces',serif;font-size:16px;font-weight:700;color:var(--clay)">${m.price.toLocaleString('fr-FR')} MAD</div>
        </div>`).join('')}
      <div style="border-top:1px solid var(--border);padding-top:12px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:14px;font-weight:700;color:var(--navy)">Total mensuel</span>
        <span style="font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--navy)">${tot.toLocaleString('fr-FR')} MAD</span>
      </div>
    </div>`;
}

// ════════════════════════
//  MISC OVERRIDES
// ════════════════════════
window.sendFidOffers=function(){
  const tgl=document.getElementById('accept-tgl');
  if(!tgl||!tgl.classList.contains('on')){
    showToast('Veuillez accepter les conditions');
    return;
  }
  const selected=Object.entries(S.fid.members).filter(([,m])=>m.sel);
  if(!selected.length){
    showToast('Sélectionnez au moins une professionnelle');
    return;
  }
  const now=new Date();
  selected.forEach(([k,m])=>{
    S.fid.offers.unshift({
      id:'F-'+Math.random().toString(36).slice(2,8).toUpperCase(),
      key:k,
      name:m.name,
      init:m.init,
      av:m.av,
      role:m.role,
      price:m.price,
      hours:m.hours,
      skills:Object.entries(m.skills).filter(([,v])=>v).map(([sk])=>S.fid.defs[sk].label),
      status:'pending',
      statusLabel:`En attente de l'acceptation de ${m.name.split(' ')[0]}`,
      createdAt:now.toISOString()
    });
  });
  const names=selected.map(([,m])=>m.name.split(' ')[0]);
  showToast('Offres envoyées à '+names.join(' et ')+' !');
  // Reset fid config queue for next time
  fidConfigQueue=[];fidConfigIdx=0;
  setTimeout(()=>gotoV3('s-fid-dashboard'),1300);
};

function hydrateFidelityFromOrder(order){
  if(!order || !Array.isArray(order.team))return;
  const firstTeamName=(order.team[0]?.name||'').split(' ')[0]||'';
  Object.entries(S.fid.members).forEach(([k,m])=>{
    const isInTeam=order.team.some(t=>t.name===m.name || t.name.split(' ')[0]===m.name.split(' ')[0]);
    m.sel=!!isInTeam;
    if(isInTeam && m.hours<10)m.hours=10;
  });
  const selectedKeys=Object.entries(S.fid.members).filter(([,m])=>m.sel).map(([k])=>k);
  if(selectedKeys.length){
    const firstExact=selectedKeys.find(k=>S.fid.members[k].name.split(' ')[0]===firstTeamName);
    S.fid.curPro=firstExact||selectedKeys[0];
  }
  calcFid();
}

function renderFidDashboard(){
  const list=$('fid-dashboard-list');
  const sub=$('fid-dash-sub');
  if(!list)return;
  const offers=S.fid.offers||[];
  if(sub){
    sub.textContent=offers.length
      ?`${offers.length} offre${offers.length>1?'s':''} envoyée${offers.length>1?'s':''} ce mois`
      :'Aucune offre envoyée pour le moment';
  }
  if(!offers.length){
    list.innerHTML=`
      <div class="card" style="margin:0 20px 12px">
        <div style="font-size:13px;color:var(--text-sec);line-height:1.6;margin-bottom:12px">Vos offres de fidélisation apparaîtront ici avec leur statut en temps réel.</div>
        <button class="btn btn-clay" onclick="openSquadReview('s-fid-dashboard')">Créer une offre</button>
      </div>`;
    return;
  }
  list.innerHTML=offers.map(o=>`
    <div class="fid-card">
      <div class="fid-top" style="cursor:pointer" onclick="S.fid.curPro='${o.key}';gotoV3('s-fid-configure')">
        <div class="avatar av-md ${o.av}">${o.init}</div>
        <div style="flex:1">
          <div style="font-size:14px;font-weight:700;color:var(--navy)">${o.name}</div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:1px">${o.skills.join(' + ')} · ${o.hours}h/mois</div>
        </div>
        <div style="text-align:right">
          <span class="chip ${o.status==='active'?'chip-success':'chip-warn'}" style="font-size:10px">${o.status==='active'?'Active':'En attente'}</span>
          <div style="font-family:'Fraunces',serif;font-size:16px;font-weight:700;color:${o.status==='active'?'var(--clay)':'var(--text-muted)'};margin-top:4px">${o.price} MAD</div>
        </div>
      </div>
      <div style="padding:14px 18px;background:${o.status==='active'?'var(--success-bg)':'var(--warning-bg)'};display:flex;align-items:center;gap:10px">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="${o.status==='active'?'var(--success)':'var(--warning)'}" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span style="font-size:11px;color:${o.status==='active'?'var(--success)':'var(--warning)'};font-weight:500">${o.statusLabel}</span>
      </div>
      ${o.status==='active'?`
      <div class="fid-bot">
        <div style="flex:1;text-align:center"><div class="fid-stat-val">${o.doneHours??18}h</div><div class="fid-stat-lbl">Effectuées</div></div>
        <div style="width:1px;background:var(--border)"></div>
        <div style="flex:1;text-align:center"><div class="fid-stat-val">${o.remainingHours??Math.max(0,(o.hours||0)-(o.doneHours||0))}h</div><div class="fid-stat-lbl">Restantes</div></div>
        <div style="width:1px;background:var(--border)"></div>
        <div style="flex:1;text-align:center"><div class="fid-stat-val">${o.nextCount??3}</div><div class="fid-stat-lbl">Prochains</div></div>
      </div>
      <div style="padding:12px 18px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px;color:var(--text-sec)">Prochain créneau : <strong style="color:var(--navy)">${o.nextSlot||'Lundi 10h–13h'}</strong></span>
        <button class="btn btn-xs btn-ghost" onclick="openProCalendar('${o.key}','s-fid-dashboard')">Calendrier</button>
      </div>`:''}
    </div>
  `).join('');
}

window.filterZones=function(q){
  const query=q.toLowerCase().trim();
  document.querySelectorAll('.zone-pill').forEach(pill=>{
    const text=pill.textContent.toLowerCase();
    pill.style.display=(!query||text.includes(query))?'':'none';
  });
};

window.selectZone=window.setLoc=function(el,name){
  S.loc=name;
  document.querySelectorAll('.zone-pill').forEach(p=>p.classList.remove('sel'));
  el?.classList.add('sel');
  closeModal('modal-location');
  set('loc-display',name);
  const valueEl=document.querySelector('.location-trigger .location-value');
  if(valueEl)valueEl.textContent=name;
  showToast('Adresse : '+name);
};

let ratingState={stars:4,comment:'',tip:0};
window.setRating=window.setR=function(n){
  ratingState.stars=n;
  document.querySelectorAll('#stars-global svg').forEach((s,i)=>{
    s.style.fill=i<n?'var(--navy)':'#D8D7EE';
  });
};

window.setRatingTip=function(v){
  ratingState.tip=v;
  renderRating();
};

function renderRating(){
  const tracked=getTrackedOrder();
  document.querySelectorAll('#stars-global svg').forEach((s,i)=>{
    s.style.fill=i<ratingState.stars?'var(--navy)':'#D8D7EE';
  });
  const team=(tracked?.team||[]);
  const avWrap=$('rating-fid-avatars');
  const namesEl=$('rating-fid-names');
  if(avWrap && team.length){
    avWrap.innerHTML=team.map((t,i)=>`<div class="avatar av-sm ${t.av||''}" style="${t.av?'':'background:rgba(255,255,255,.2);color:white;'}border:2px solid rgba(14,20,66,0.6);${i>0?'margin-left:-8px':''}">${t.init||'--'}</div>`).join('');
  }
  if(namesEl && team.length){
    namesEl.textContent=team.map(t=>t.name.split(' ')[0]).join(' · ');
  }
  const grid=$('rating-tip-grid');
  if(grid){
    grid.innerHTML=[0,10,20,50].map(v=>`
      <button class="tip-btn${ratingState.tip===v&&v>0?' sel':''}" onclick="setRatingTip(${v})" style="justify-content:center;padding:10px 8px">
        <span style="font-size:12px;font-weight:700;color:${ratingState.tip===v&&v>0?'var(--clay)':'var(--text-sec)'}">${v===0?'Non':`+${v}`}</span>
      </button>
    `).join('');
  }
  const total=$('rating-tip-total');
  if(total){
    const order=getTrackedOrder();
    const base=order?.price ?? (negoState.confirmed?negoState.price:P.min());
    const all=base+(ratingState.tip||0);
    total.textContent=ratingState.tip>0?`Total payé: ${all} MAD (dont ${ratingState.tip} MAD de pourboire)`:`Total payé: ${base} MAD`;
  }
}

window.submitRating=function(){
  const ta=document.getElementById('rating-comment');
  ratingState.comment=ta?ta.value.trim():'';
  const order=getTrackedOrder()||ordersData.find(o=>o.status==='en_cours');
  if(order){
    order.clientRating=ratingState.stars;
    order.clientComment=ratingState.comment||null;
    order.tip=ratingState.tip||0;
    order.status='terminee';
  }
  statusPhase=4;
  clearStatusTimers();
  syncTrackedOrderFromPhase(false);
  updateOrdersBadge();
  showToast('Merci pour votre évaluation !');
  S.activeOrderDraftId=null;
  setTimeout(()=>gotoV3('s-home'),1200);
};

window.submitAndFidelize=function(){
  const ta=document.getElementById('rating-comment');
  ratingState.comment=ta?ta.value.trim():'';
  const order=getTrackedOrder()||ordersData.find(o=>o.status==='en_cours');
  if(order){
    order.clientRating=ratingState.stars;
    order.clientComment=ratingState.comment||null;
    order.tip=ratingState.tip||0;
    order.status='terminee';
    hydrateFidelityFromOrder(order);
  }
  statusPhase=4;
  clearStatusTimers();
  syncTrackedOrderFromPhase(false);
  updateOrdersBadge();
  S.activeOrderDraftId=null;
  openSquadReview('s-rating');
};

// ─── SVG Logo injection everywhere ───
(function injectLogos(){
  // Status bar (clay/brand version)
  const sbEl=document.getElementById('sb-logo');
  if(sbEl) sbEl.innerHTML=BABLOO_SVG_CLAY;
  // Promo banner (white ghost)
  const promoEl=document.getElementById('promo-logo');
  if(promoEl) promoEl.innerHTML=BABLOO_SVG_WHITE;
  // Orders page
  const ordLogo=document.getElementById('orders-logo');
  if(ordLogo) ordLogo.innerHTML=BABLOO_SVG_NAVY;
})();

// ─── Splash screen auto-dismiss ───
(function initSplash(){
  const splash=document.getElementById('splash');
  const container=document.getElementById('splash-container');
  const paths=document.querySelectorAll('.splash-trace');
  if(!splash||!container||!paths.length)return;

  const dismissSplash=()=>{
    splash.classList.add('hide');
    setTimeout(()=>{splash.style.display='none';},550);
  };

  if(!window.gsap){
    setTimeout(dismissSplash,1900);
    return;
  }

  paths.forEach(path=>{
    const length=path.getTotalLength();
    gsap.set(path,{strokeDasharray:length,strokeDashoffset:length});
  });

  gsap.timeline({delay:0.2,onComplete:dismissSplash})
    .to('.splash-trace',{
      strokeDashoffset:0,
      duration:1.2,
      ease:'power2.inOut'
    })
    .to(container,{
      scale:0.94,
      duration:0.15,
      ease:'power2.in'
    },'-=0.1')
    .to('#splash-base',{
      fill:'#04016D',
      stroke:'transparent',
      duration:0.01
    },'<')
    .to(['#splash-cut-top','#splash-hammer'],{
      fill:'#FFFFFF',
      stroke:'transparent',
      duration:0.01
    },'<')
    .to(container,{
      scale:1,
      filter:'drop-shadow(0px 10px 25px rgba(4, 1, 109, 0.15))',
      duration:0.5,
      ease:'back.out(2.5)'
    });
})();

// ════════════════════════
//  ORDERS DATA + RENDERING
// ════════════════════════
const ordersData = [
  {
    id:'ORD-3F9KA',status:'en_cours',type:'maid',label:'Ménage · Duo',detail:'Ménage simple · 80m²',
    date:'Mar 25 Fév 2026',time:'11h50 – 15h00',dur:'3h10',price:180,tip:20,
    address:'Agdal, Rabat',payment:'Espèces à la porte',
    team:[
      {name:'Fatima Zahra',role:'Coordinatrice',rating:'4.9',cnt:47,init:'FZ',av:'av-a',tasks:'Surfaces, salle de bain, cuisine'},
      {name:'Khadija Benali',role:'Ménage sol',rating:'4.7',cnt:31,init:'KB',av:'av-b',tasks:'Sol, vitres, dépoussiérage'}
    ],
    clientRating:null,clientComment:null
  },
  {
    id:'ORD-2B7MX',status:'terminee',type:'maid',label:'Ménage + Cuisine · Solo',detail:'Ménage simple + Tajine poulet · 60m²',
    date:'Lun 10 Fév 2026',time:'09h00 – 12h30',dur:'3h30',price:160,tip:0,
    address:'Agdal, Rabat',payment:'Espèces',
    team:[
      {name:'Fatima Zahra',role:'Coordinatrice',rating:'4.9',cnt:45,init:'FZ',av:'av-a',tasks:'Ménage complet + préparation tajine poulet olives'}
    ],
    clientRating:5,clientComment:'Travail impeccable, Fatima est très professionnelle et ponctuelle.'
  },
  {
    id:'ORD-1K4PZ',status:'terminee',type:'cuisine',label:'Cuisine · Solo',detail:'Couscous royal · 8 convives',
    date:'Ven 31 Jan 2026',time:'10h00 – 14h00',dur:'4h00',price:200,tip:30,
    address:'Hay Riad, Rabat',payment:'Espèces',
    team:[
      {name:'Samira Alaoui',role:'Cuisinière',rating:'4.4',cnt:18,init:'SA',av:'av-c',tasks:'Couscous royal légumes + viande pour 8 personnes'}
    ],
    clientRating:4,clientComment:'Très bon couscous, un peu en retard cependant.'
  },
  {
    id:'ORD-0X9LN',status:'terminee',type:'childcare',label:'Baby-sitting · Solo',detail:'2 enfants · 4h',
    date:'Dim 19 Jan 2026',time:'14h00 – 18h00',dur:'4h00',price:200,tip:0,
    address:'Agdal, Rabat',payment:'Espèces',
    team:[
      {name:'Khadija Benali',role:'Baby-sitter',rating:'4.7',cnt:29,init:'KB',av:'av-b',tasks:'Garde de 2 enfants (4 et 7 ans), aide aux devoirs, goûter'}
    ],
    clientRating:5,clientComment:'Les enfants l\'adorent, très patiente et attentive.'
  }
];

restoreStatusState();
syncTrackedOrderFromPhase(false);

function renderOrders(){
  const el=$('orders-list');if(!el)return;
  const active=ordersData.filter(o=>o.status==='en_cours');
  const done=ordersData.filter(o=>o.status==='terminee');
  const stars=(n)=>{let s='';for(let i=1;i<=5;i++)s+=`<svg width="12" height="12" viewBox="0 0 24 24" fill="${i<=n?'var(--navy)':'#D8D7EE'}" stroke="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;return s;};
  const typeIcon={maid:'🧹',cuisine:'🍳',childcare:'👶'};
  
  const cardHTML=(o)=>`
    <div style="margin:0 20px 12px;background:var(--surface);border-radius:var(--r-lg);overflow:hidden;box-shadow:var(--sh-sm);cursor:pointer;transition:transform .1s" onclick="showOrderDetail('${o.id}')" onmousedown="this.style.transform='scale(.98)'" onmouseup="this.style.transform=''">
      <div style="padding:14px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)">
        <div style="display:flex;margin-right:-4px">${o.team.map((t,i)=>`<div class="avatar av-md ${t.av}" style="${i>0?'margin-left:-10px;border:2px solid white':''}">${t.init}</div>`).join('')}</div>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:700;color:var(--navy)">${o.label}</div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:1px">${o.team.map(t=>t.name.split(' ')[0]).join(' + ')}</div>
        </div>
        <span class="chip ${o.status==='en_cours'?'chip-success':'chip-navy'}" style="${o.status!=='en_cours'?'background:rgba(14,20,66,0.07)':''};font-size:10px">${o.status==='en_cours'?'En cours':'Terminée'}</span>
      </div>
      <div style="padding:11px 16px;background:var(--bg-alt);display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-size:11px;color:var(--text-sec)">${o.date}</span>
          ${o.clientRating?`<span style="display:inline-flex;gap:1px;margin-left:4px">${stars(o.clientRating)}</span>`:''}
        </div>
        <span style="font-family:'Fraunces',serif;font-size:15px;font-weight:700;color:var(--navy)">${o.price} MAD</span>
      </div>
    </div>`;
  
  el.innerHTML=`
    ${active.length?`<div style="padding:18px 20px 8px"><div class="t-label">En cours</div></div>${active.map(cardHTML).join('')}`:''}
    ${done.length?`<div style="padding:${active.length?'10':'18'}px 20px 8px"><div class="t-label">Terminées · ${done.length} commande${done.length>1?'s':''}</div></div>${done.map(cardHTML).join('')}`:''}
    <div style="height:20px"></div>`;
}

window.showOrderDetail=function(id){
  const o=ordersData.find(x=>x.id===id);if(!o)return;
  gotoV3('s-order-detail');
  setTimeout(()=>{
    const title=$('od-title');if(title)title.textContent='#'+o.id;
    const chip=$('od-status-chip');
    if(chip){chip.textContent=o.status==='en_cours'?'En cours':'Terminée';chip.className='chip '+(o.status==='en_cours'?'chip-success':'chip-navy');}
    const el=$('od-content');if(!el)return;
    
    const starsHTML=(n)=>{let s='';for(let i=1;i<=5;i++)s+=`<svg width="14" height="14" viewBox="0 0 24 24" fill="${i<=n?'var(--navy)':'#D8D7EE'}" stroke="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;return s;};
    
    el.innerHTML=`
      <!-- Service summary -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
          <div>
            <div class="t-label" style="margin-bottom:4px">Service</div>
            <div class="t-h2">${o.label}</div>
            <div style="font-size:12px;color:var(--text-sec);margin-top:3px">${o.detail}</div>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:12px;display:flex;flex-direction:column;gap:8px">
          ${row('Date',o.date)}
          ${row('Horaire',o.time)}
          ${row('Durée effective',o.dur)}
          ${row('Adresse',o.address)}
          ${row('Paiement',o.payment)}
        </div>
      </div>
      <!-- Price breakdown -->
      <div style="background:var(--navy);border-radius:var(--r-lg);padding:18px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,.42);margin-bottom:4px">Montant payé</div>
          <div style="font-family:'Fraunces',serif;font-size:28px;font-weight:700;color:white">${o.price} MAD</div>
          ${o.tip>0?`<div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:2px">dont ${o.tip} MAD de pourboire</div>`:''}
        </div>
        <div style="text-align:center;opacity:.5">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
          <div style="font-size:9px;color:rgba(255,255,255,.5);margin-top:3px">Espèces</div>
        </div>
      </div>
      <!-- Team details -->
      <div class="card">
        <div class="t-label" style="margin-bottom:14px">Équipe · ${o.team.length} professionnel${o.team.length>1?'les':'le'}</div>
        ${o.team.map(t=>`
          <div style="display:flex;gap:12px;align-items:flex-start;${o.team.indexOf(t)<o.team.length-1?'margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border)':''}">
            <div class="avatar av-lg ${t.av}">${t.init}</div>
            <div style="flex:1">
              <div style="font-size:14px;font-weight:700;color:var(--navy)">${t.name}</div>
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">${t.role} · ${t.rating} ★ · ${t.cnt} prestations</div>
              <div style="background:var(--bg-alt);border-radius:var(--r-sm);padding:8px 10px;font-size:11px;color:var(--text-sec);line-height:1.5">
                <strong style="color:var(--navy)">Tâches :</strong> ${t.tasks}
              </div>
            </div>
          </div>`).join('')}
      </div>
      <!-- Client rating -->
      ${o.clientRating?`
      <div class="card">
        <div class="t-label" style="margin-bottom:10px">Votre évaluation</div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <div style="display:flex;gap:2px">${starsHTML(o.clientRating)}</div>
          <span style="font-size:13px;font-weight:700;color:var(--navy)">${o.clientRating}/5</span>
        </div>
        ${o.clientComment?`<div style="background:var(--bg-alt);border-radius:var(--r-md);padding:12px 14px;font-size:13px;color:var(--text-sec);line-height:1.6;font-style:italic">"${o.clientComment}"</div>`:''}
      </div>`:`
      <div style="background:var(--bg-alt);border-radius:var(--r-lg);padding:16px;text-align:center">
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:10px">Vous n'avez pas encore évalué cette prestation</div>
        <button class="btn btn-outline" style="height:40px;font-size:13px" onclick="gotoV3('s-rating')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          Évaluer maintenant
        </button>
      </div>`}
      <!-- Re-order -->
      <button class="btn btn-clay" onclick="reorderFromOrder('${o.id}')">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        Commander à nouveau
      </button>`;
  },60);
};

window.reorderFromOrder=function(id){
  const o=ordersData.find(x=>x.id===id);if(!o)return;
  S.svc=o.type;
  S.loc=o.address;
  if(o.type==='maid'){
    const surfMatch=o.detail.match(/(\d+)m/);
    if(surfMatch)S.maid.surface=parseInt(surfMatch[1]);
    S.maid.team=o.team.length>=3?'squad':o.team.length===2?'duo':'solo';
  } else if(o.type==='cuisine'){
    const gMatch=o.detail.match(/(\d+)\s*convives/);
    if(gMatch)S.cuisine.guests=parseInt(gMatch[1]);
  } else if(o.type==='childcare'){
    const cMatch=o.detail.match(/(\d+)\s*enfant/);
    if(cMatch)S.childcare.children=parseInt(cMatch[1]);
    const hMatch=o.detail.match(/(\d+)h/);
    if(hMatch)S.childcare.hours=parseInt(hMatch[1]);
  }
  gotoV3('s-booking-'+(o.type==='childcare'?'childcare':o.type));
  showToast('Préférences pré-remplies');
};

// ─── Sidebar nav wiring
document.querySelectorAll('.sb-btn').forEach(b=>{
  const oc=b.getAttribute('onclick')||'';
  if(oc.includes("S.svc='maid'")){
    b.onclick=()=>{S.svc='maid';gotoV3('s-booking-maid');};
  } else if(oc.includes("S.svc='cuisine'")){
    b.onclick=()=>{S.svc='cuisine';gotoV3('s-booking-cuisine');};
  } else if(oc.includes("S.svc='childcare'")){
    b.onclick=()=>{S.svc='childcare';gotoV3('s-booking-childcare');};
  }
});



/* ================================================================
   BABLOO OTP — Behavior
   Paste anywhere after DOM is ready (or wrap in DOMContentLoaded)
   ================================================================ */
(function () {
  'use strict';

  if (window.__BablooOTPBound) return;
  window.__BablooOTPBound = true;

  const DEMO_VALID_CODE = '123456';
  const RESEND_DELAY = 30;

  const boxes = Array.from(document.querySelectorAll('.otp-box'));
  const submitBtn = document.getElementById('otp-submit');
  const resendBtn = document.getElementById('otp-resend');
  const errorEl = document.getElementById('otp-error');
  const errorMsg = document.getElementById('otp-error-msg');
  const timerSR = document.getElementById('otp-timer-sr');
  const successEl = document.getElementById('otp-success');
  const backBtn = document.getElementById('otp-back');
  const changeBtn = document.getElementById('otp-change-number');
  const ctaLabel = document.querySelector('.otp-cta-label');
  const ctaLoader = document.querySelector('.otp-loader');
  const phoneEl = document.getElementById('otp-phone-display');
  const otpScreen = document.getElementById('screen-otp');

  if (!boxes.length || !submitBtn || !resendBtn || !otpScreen) return;

  let countdown = null;

  const getCountdownEl = () => document.getElementById('otp-countdown');
  const getResendLabelEl = () => document.getElementById('otp-resend-label');
  const getValue = () => boxes.map(b => b.value).join('');
  const isComplete = () => getValue().length === boxes.length;
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function routeTo(id) {
    if (typeof window.goto === 'function') window.goto(id);
    else {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const target = document.getElementById(id);
      if (target) target.classList.add('active');
    }
  }

  function setResendLabelTimer(seconds) {
    const label = getResendLabelEl();
    if (label) label.innerHTML = `Renvoyer dans <strong id="otp-countdown">${seconds}</strong>s`;
  }

  function setResendLabelReady() {
    const label = getResendLabelEl();
    if (label) label.textContent = 'Renvoyer';
  }

  function updateSubmit() {
    const ok = isComplete();
    submitBtn.disabled = !ok;
    submitBtn.setAttribute('aria-disabled', String(!ok));
  }

  function shakeError() {
    boxes.forEach(b => {
      b.classList.remove('otp-error-box');
      void b.offsetWidth;
      b.classList.add('otp-error-box');
    });
  }

  function setError(msg) {
    if (errorMsg) errorMsg.textContent = msg;
    if (errorEl) errorEl.hidden = false;
    shakeError();
  }

  function clearError() {
    if (errorEl) errorEl.hidden = true;
    boxes.forEach(b => b.classList.remove('otp-error-box'));
  }

  function setLoading(on) {
    if (ctaLabel) ctaLabel.hidden = on;
    if (ctaLoader) ctaLoader.hidden = !on;
    submitBtn.disabled = on || !isComplete();
    submitBtn.setAttribute('aria-disabled', String(submitBtn.disabled));
    boxes.forEach(b => { b.disabled = on; });
  }

  function resetBoxes() {
    boxes.forEach(b => {
      b.value = '';
      b.disabled = false;
      b.classList.remove('filled', 'otp-error-box');
    });
    clearError();
    updateSubmit();
  }

  function showSuccess() {
    if (!successEl) return;
    successEl.hidden = false;
    setTimeout(() => routeTo('s-home'), 1800);
  }

  boxes.forEach((box, i) => {
    box.addEventListener('input', () => {
      const digit = box.value.replace(/\D/g, '').slice(-1);
      box.value = digit;
      box.classList.toggle('filled', digit !== '');
      clearError();
      updateSubmit();
      if (digit && i < boxes.length - 1) boxes[i + 1].focus();
    });

    box.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace') {
        if (box.value === '' && i > 0) {
          boxes[i - 1].value = '';
          boxes[i - 1].classList.remove('filled');
          boxes[i - 1].focus();
        } else {
          box.value = '';
          box.classList.remove('filled');
        }
        clearError();
        updateSubmit();
        e.preventDefault();
      }
      if (e.key === 'ArrowLeft' && i > 0) { boxes[i - 1].focus(); e.preventDefault(); }
      if (e.key === 'ArrowRight' && i < boxes.length - 1) { boxes[i + 1].focus(); e.preventDefault(); }
      if (e.key === 'Enter' && isComplete() && !submitBtn.disabled) {
        e.preventDefault();
        submitBtn.click();
      }
    });

    box.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '').slice(0, boxes.length);
      if (!text) return;
      boxes.forEach((b, idx) => {
        const ch = text[idx] || '';
        b.value = ch;
        b.classList.toggle('filled', !!ch);
      });
      const focusIndex = Math.min(Math.max(text.length - 1, 0), boxes.length - 1);
      boxes[focusIndex].focus();
      clearError();
      updateSubmit();
    });

    box.addEventListener('click', () => box.select && box.select());
  });

  submitBtn.addEventListener('click', async () => {
    if (!isComplete()) return;
    const code = getValue();
    setLoading(true);
    await sleep(1200);
    setLoading(false);

    if (code === DEMO_VALID_CODE) {
      showSuccess();
      return;
    }

    resetBoxes();
    setError('Code incorrect. Veuillez réessayer.');
    boxes[0].focus();
  });

  function startCountdown(seconds) {
    let s = seconds;
    resendBtn.disabled = true;
    resendBtn.setAttribute('aria-disabled', 'true');
    setResendLabelTimer(s);
    if (timerSR) timerSR.textContent = `Renvoyer disponible dans ${s} secondes`;

    if (countdown) clearInterval(countdown);
    countdown = setInterval(() => {
      s -= 1;
      const cd = getCountdownEl();
      if (cd) cd.textContent = String(Math.max(s, 0));
      if (timerSR) timerSR.textContent = `Renvoyer disponible dans ${Math.max(s, 0)} secondes`;
      if (s <= 0) {
        clearInterval(countdown);
        countdown = null;
        resendBtn.disabled = false;
        resendBtn.setAttribute('aria-disabled', 'false');
        setResendLabelReady();
        if (timerSR) timerSR.textContent = 'Vous pouvez maintenant renvoyer le code.';
      }
    }, 1000);
  }

  resendBtn.addEventListener('click', () => {
    if (resendBtn.disabled) return;
    resetBoxes();
    boxes[0].focus();
    startCountdown(RESEND_DELAY);
    if (typeof showToast === 'function') showToast('Nouveau code SMS envoyé');
  });

  function goBackFromOTP() {
    if (successEl) successEl.hidden = true;
    routeTo('s-home');
  }

  if (backBtn) backBtn.addEventListener('click', goBackFromOTP);
  if (changeBtn) changeBtn.addEventListener('click', goBackFromOTP);

  function initOTP(maskedPhone) {
    if (phoneEl && maskedPhone) phoneEl.textContent = maskedPhone;
    if (successEl) successEl.hidden = true;
    if (ctaLabel) ctaLabel.hidden = false;
    if (ctaLoader) ctaLoader.hidden = true;
    resetBoxes();
    startCountdown(RESEND_DELAY);
    setTimeout(() => boxes[0].focus(), 120);
  }

  window.BablooOTP = {
    init: initOTP,
    show(maskedPhone) {
      routeTo('screen-otp');
      initOTP(maskedPhone || '+212 06 ·· ·· ·· 42');
    }
  };

  if (otpScreen.classList.contains('active')) {
    initOTP();
  }

  /* Demo auto-open removed — auth flow now handles OTP entry */
})();


/* ================================================================
   BABLOO AUTH — Integration patch
   Runs after BablooOTP IIFE. Uses window.goto (= gotoV3).
   ================================================================ */
(function () {
  'use strict';

  if (window.__BablooAuthBound) return;
  window.__BablooAuthBound = true;

  const A = { mode: 'signin', method: 'email', fromSSO: false, phone: '', dialCode: '+212' };

  function go(id) { if (typeof window.goto === 'function') window.goto(id); }
  window.__fpBackTarget = window.__fpBackTarget || 'screen-signin-email';
  window.openForgotPassword = function(backId){
    window.__fpBackTarget = backId || 'screen-signin-email';
    go('screen-forgot-password');
  };
  window.goForgotBack = function(){
    go(window.__fpBackTarget || 'screen-signin-email');
  };
  const statusBar = document.getElementById('status-bar');
  function setStatusDark(on) { if (statusBar) statusBar.classList.toggle('dark', on); }
  function maskPhone(raw) {
    const digits = String(raw || '').replace(/\D/g, '');
    if (digits.length < 4) return A.dialCode + ' ' + raw;
    return A.dialCode + ' ' + digits.slice(0, 2) + ' ·· ·· ' + digits.slice(-2);
  }
  const delay = ms => new Promise(r => setTimeout(r, ms));

  function setLoading(btn, on) {
    const lbl = btn.querySelector('.auth-cta-label');
    const ldr = btn.querySelector('.auth-cta-loader');
    if (lbl) lbl.hidden = on;
    if (ldr) ldr.hidden = !on;
    btn.disabled = on;
  }
  function showFieldErr(inputId, errId, msg) {
    const inp = document.getElementById(inputId);
    const err = document.getElementById(errId);
    if (inp) inp.classList.add('auth-err');
    if (err) { err.textContent = msg; err.hidden = false; }
  }
  function clearFieldErr(inputId, errId) {
    const inp = document.getElementById(inputId);
    const err = document.getElementById(errId);
    if (inp) inp.classList.remove('auth-err');
    if (err) err.hidden = true;
  }
  function showGlobalErr(errId, msgId, msg) {
    const el = document.getElementById(errId);
    const ms = document.getElementById(msgId);
    if (ms && msg) ms.textContent = msg;
    if (el) el.hidden = false;
  }
  function clearGlobalErr(errId) { const el = document.getElementById(errId); if (el) el.hidden = true; }
  function validateEmail(v) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v || '').trim()); }
  function validatePhone(v) { return String(v || '').replace(/\D/g, '').length >= 8; }

  document.querySelectorAll('.auth-eye-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const inp = document.getElementById(btn.dataset.target);
      if (!inp) return;
      inp.type = inp.type === 'password' ? 'text' : 'password';
      btn.setAttribute('aria-label', inp.type === 'password' ? 'Afficher' : 'Masquer');
    });
  });
  document.querySelectorAll('.auth-back-btn[data-goto]').forEach(btn => btn.addEventListener('click', () => go(btn.dataset.goto)));

  const supBackBtn = document.getElementById('sup-back-btn');
  if (supBackBtn) {
    supBackBtn.addEventListener('click', () => {
      if (A.fromSSO) go('screen-auth');
      else if (A.method === 'email') go('screen-signup-email');
      else go('screen-auth');
    });
  }

  const tabs = document.querySelectorAll('.auth-tab');
  const tabIndicator = document.getElementById('auth-tab-indicator');
  const authLegal = document.getElementById('auth-legal');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      A.mode = tab.dataset.mode;
      tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
      tab.classList.add('active');
      tab.setAttribute('aria-selected', 'true');
      if (tabIndicator) tabIndicator.classList.toggle('right', A.mode === 'signup');
      if (authLegal) authLegal.hidden = (A.mode !== 'signup');
    });
  });

  document.querySelectorAll('[data-provider]').forEach(btn => {
    btn.addEventListener('click', async () => {
      A.method = btn.dataset.provider; A.fromSSO = true;
      btn.classList.add('auth-loading');
      await delay(1200);
      btn.classList.remove('auth-loading');
      if (A.mode === 'signin') {
        go('s-home');
      } else {
        const sub = document.getElementById('sup-subtitle');
        if (sub) sub.textContent = 'Dernière étape — vérifiez votre numéro';
        go('screen-signup-phone');
      }
    });
  });

  document.getElementById('auth-email-btn')?.addEventListener('click', () => {
    A.method = 'email'; A.fromSSO = false;
    go(A.mode === 'signin' ? 'screen-signin-email' : 'screen-signup-email');
  });
  document.getElementById('auth-phone-btn')?.addEventListener('click', () => {
    A.method = 'phone'; A.fromSSO = false;
    if (A.mode === 'signin') go('screen-signin-phone');
    else {
      const sub = document.getElementById('sup-subtitle');
      if (sub) sub.textContent = 'Ajoutez votre numéro pour sécuriser votre compte';
      go('screen-signup-phone');
    }
  });

  // Auth uses window.goto (= gotoV3) directly via the go() helper above

  const sieSubmit = document.getElementById('sie-submit');
  if (sieSubmit) {
    sieSubmit.addEventListener('click', async () => {
      clearGlobalErr('sie-global-err');
      let ok = true;
      const email = document.getElementById('sie-email')?.value || '';
      const pass = document.getElementById('sie-password')?.value || '';
      if (!validateEmail(email)) { showFieldErr('sie-email', 'sie-email-err', 'Adresse e-mail invalide.'); ok = false; } else clearFieldErr('sie-email', 'sie-email-err');
      if (!pass) { showFieldErr('sie-password', 'sie-pass-err', 'Mot de passe requis.'); ok = false; } else clearFieldErr('sie-password', 'sie-pass-err');
      if (!ok) return;
      setLoading(sieSubmit, true);
      await delay(1400);
      setLoading(sieSubmit, false);
      if (pass === 'demo1234') go('s-home'); else showGlobalErr('sie-global-err', 'sie-global-err-msg', 'E-mail ou mot de passe incorrect.');
    });
  }

  const sipSubmit = document.getElementById('sip-submit');
  if (sipSubmit) {
    sipSubmit.addEventListener('click', async () => {
      clearGlobalErr('sip-global-err');
      const phone = document.getElementById('sip-phone')?.value || '';
      if (!validatePhone(phone)) { showFieldErr('sip-phone', 'sip-phone-err', 'Numéro invalide.'); return; }
      clearFieldErr('sip-phone', 'sip-phone-err');
      A.phone = phone;
      setLoading(sipSubmit, true);
      await delay(900);
      setLoading(sipSubmit, false);
      const disp = document.getElementById('sipw-phone-display');
      if (disp) disp.textContent = maskPhone(phone);
      go('screen-signin-pass');
    });
  }

  const sipwSubmit = document.getElementById('sipw-submit');
  if (sipwSubmit) {
    sipwSubmit.addEventListener('click', async () => {
      clearGlobalErr('sipw-global-err');
      const pass = document.getElementById('sipw-password')?.value || '';
      if (!pass) { showFieldErr('sipw-password', 'sipw-pass-err', 'Mot de passe requis.'); return; }
      clearFieldErr('sipw-password', 'sipw-pass-err');
      setLoading(sipwSubmit, true);
      await delay(1400);
      setLoading(sipwSubmit, false);
      if (pass === 'demo1234') go('s-home'); else showGlobalErr('sipw-global-err', 'sipw-global-err-msg', 'Mot de passe incorrect. Réessayez.');
    });
  }

  const sueSubmit = document.getElementById('sue-submit');
  if (sueSubmit) {
    sueSubmit.addEventListener('click', async () => {
      clearGlobalErr('sue-global-err');
      let ok = true;
      const email = document.getElementById('sue-email')?.value || '';
      const pass = document.getElementById('sue-password')?.value || '';
      const confirm = document.getElementById('sue-confirm')?.value || '';
      if (!validateEmail(email)) { showFieldErr('sue-email', 'sue-email-err', 'Adresse e-mail invalide.'); ok = false; } else clearFieldErr('sue-email', 'sue-email-err');
      if (pass.length < 8) { showFieldErr('sue-password', 'sue-pass-err', '8 caractères minimum.'); ok = false; } else clearFieldErr('sue-password', 'sue-pass-err');
      if (pass !== confirm) { showFieldErr('sue-confirm', 'sue-confirm-err', 'Les mots de passe ne correspondent pas.'); ok = false; } else clearFieldErr('sue-confirm', 'sue-confirm-err');
      if (!ok) return;
      setLoading(sueSubmit, true);
      await delay(1000);
      setLoading(sueSubmit, false);
      if (email.trim().toLowerCase() === 'used@babloo.ma') {
        showGlobalErr('sue-global-err', 'sue-global-err-msg', 'Cet e-mail est déjà utilisé. Connectez-vous ?');
      } else {
        A.method = 'email'; A.fromSSO = false;
        const sub = document.getElementById('sup-subtitle');
        if (sub) sub.textContent = 'Ajoutez votre numéro pour sécuriser votre compte';
        go('screen-signup-phone');
      }
    });
  }

  const supSubmit = document.getElementById('sup-submit');
  const supExistingHint = document.getElementById('sup-existing-hint');
  const supSwitchSignin = document.getElementById('sup-switch-signin');
  if (supSubmit) {
    supSubmit.addEventListener('click', async () => {
      clearFieldErr('sup-phone', 'sup-phone-err');
      if (supExistingHint) supExistingHint.hidden = true;
      const phone = document.getElementById('sup-phone')?.value || '';
      if (!validatePhone(phone)) { showFieldErr('sup-phone', 'sup-phone-err', 'Numéro invalide.'); return; }
      A.phone = phone;
      setLoading(supSubmit, true);
      await delay(900);
      setLoading(supSubmit, false);
      if (phone.replace(/\D/g, '') === '0600000000') {
        if (supExistingHint) supExistingHint.hidden = false;
        return;
      }
      const masked = maskPhone(phone);
      const otpCtaLabel = document.querySelector('#screen-otp .otp-cta-label');
      if (otpCtaLabel) otpCtaLabel.textContent = 'Vérifier et créer mon compte';
      window.__otpBackTarget = 'screen-signup-phone';
      if (window.BablooOTP) window.BablooOTP.init(masked);
      go('screen-otp');
    });
  }

  if (supSwitchSignin) {
    supSwitchSignin.addEventListener('click', () => {
      A.mode = 'signin';
      tabs.forEach(t => {
        const isSI = t.dataset.mode === 'signin';
        t.classList.toggle('active', isSI);
        t.setAttribute('aria-selected', String(isSI));
      });
      if (tabIndicator) tabIndicator.classList.remove('right');
      if (authLegal) authLegal.hidden = true;
      go('screen-auth');
    });
  }

  ['otp-back', 'otp-change-number'].forEach(id => {
    const el = document.getElementById(id);
    if (!el || !el.parentNode) return;
    const fresh = el.cloneNode(true);
    el.parentNode.replaceChild(fresh, el);
    fresh.addEventListener('click', () => {
      const suc = document.getElementById('otp-success');
      if (suc) suc.hidden = true;
      const lbl = document.querySelector('#screen-otp .otp-cta-label');
      if (lbl) lbl.textContent = 'Vérifier le code';
      const target = window.__otpBackTarget || 's-home';
      window.__otpBackTarget = undefined;
      go(target);
    });
  });

  if (window.BablooOTP) {
    const _origShow = window.BablooOTP.show;
    window.BablooOTP.show = function(masked) {
      window.__otpBackTarget = undefined;
      const lbl = document.querySelector('#screen-otp .otp-cta-label');
      if (lbl) lbl.textContent = 'Vérifier le code';
      if (_origShow) _origShow.call(this, masked);
    };
  }

  const heroLogo = document.getElementById('auth-hero-logo');
  if (heroLogo && typeof BABLOO_SVG_WHITE !== 'undefined') {
    heroLogo.innerHTML = BABLOO_SVG_WHITE;
    heroLogo.style.cssText = 'display:flex;align-items:center;justify-content:center;';
  }

  // Forgot password handler
  const fpSubmit = document.getElementById('fp-submit');
  if (fpSubmit) {
    fpSubmit.addEventListener('click', async () => {
      clearFieldErr('fp-email', 'fp-email-err');
      clearGlobalErr('fp-global-err');
      const fpSuccess = document.getElementById('fp-success');
      if (fpSuccess) fpSuccess.hidden = true;
      const email = document.getElementById('fp-email')?.value || '';
      if (!validateEmail(email)) { showFieldErr('fp-email', 'fp-email-err', 'Adresse e-mail invalide.'); return; }
      setLoading(fpSubmit, true);
      await delay(1200);
      setLoading(fpSubmit, false);
      if (fpSuccess) fpSuccess.hidden = false;
      const lbl = fpSubmit.querySelector('.auth-cta-label');
      if (lbl) lbl.textContent = 'Renvoyer le lien';
    });
  }

  try { cur = 'screen-auth'; } catch(e) {}
  setStatusDark(true);
  window.BablooAuth = { go, getState: () => ({ ...A }) };
})();
/* END BABLOO AUTH */


</script>
</body>
</html>
